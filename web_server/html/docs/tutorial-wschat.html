<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      Using Websockets to Build a Chat — Rampart 0.1.0 documentation
    </title>
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css">
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css">
    <link rel="stylesheet" href="_static/hacks.css" type="text/css">
    <link rel="index" title="Index" href="genindex.html">
    <link rel="search" title="Search" href="search.html">
    <link rel="top" title="Rampart 0.1.0 documentation" href="index.html">
    <link rel="up" title="Tutorials" href="tutorialtoc.html">
    <link rel="next" title="Building a Pi News Aggregator" href="tutorial-pi_news.html">
    <link rel="prev" title="Find Cities and their Closest Neighbors" href="tutorial-citysearch.html">
    <script src="_static/js/modernizr.min.js"></script>
    <style>
            .wy-nav-top,.wy-side-nav-search { background-color:black;}
            body,h1,h2,h3,h4,h5,h6 {font-family: "Varela Round", Sans-Serif;}
            dl:not(.docutils) dt {font-family: "Varela Round", Sans-Serif !important; font-size: 90% !important;}
            .autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; width: auto !important; padding-right:5px;}
            .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
            .autocomplete-selected { background: #F0F0F0; }
            .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
            .autocomplete-group { padding: 2px 5px; }
            .autocomplete-group strong { display: block; border-bottom: 1px solid #000; }
            .searchsect {max-height: 250px; overflow:hidden; padding-left:5px; padding-bottom: 15px; position: relative;}
            .linked { font-size: 1.1em; display: inline-block; position: relative; margin-top: 20px;}
            .slink { font-size: 1rem; margin-top:0px; margin-bottom:5px;}
            .fader {position: absolute;bottom: 0px;height: 2em; left:-5px; right:0px; background-color: #fcfcfc;}
            .expand {cursor:pointer; background-color: #eee; padding: 3px; font-family:monospace; position: absolute; right: 15px}
            .expandBottom { bottom: 18px }
            .expandTop { top: 3px }
            .expanded .fader { bottom : -15px }
            .expanded .expandBottom { bottom: 38px; }
            .wy-nav-content {max-width: 1600px;}
    </style>
  </head>
  <body class="wy-body-for-nav" role="document">
    <div class="wy-grid-for-nav">
      <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
          <div class="wy-side-nav-search">
            <a href="/" class="icon icon-home">Rampart</a>
            <div role="search">
              <form id="rtd-search-form" class="wy-form" action="search.html" method="get" name="rtd-search-form">
                <input type="text" name="q" placeholder="Search docs"> <input type="hidden" name="check_keywords"
                value="yes"> <input type="hidden" name="area" value="default">
              </form>
            </div>
          </div>
          <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            <p class="caption">
              <span class="caption-text">Contents:</span>
            </p>
            <ul class="current">
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-main.html">Rampart JavaScript</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-utils.html">Rampart Utility Functions</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="sqltoc.html">The rampart-sql module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-server.html">The rampart-server module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-html.html">The rampart-html module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-crypto.html">The rampart-crypto module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-curl.html">The rampart-curl module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-lmdb.html">The rampart-lmdb module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-redis.html">The rampart-redis module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-robots.html">The rampart-robots module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-cmark.html">The rampart-cmark module</a>
              </li>
              <li class="toctree-l1">
                <a class="reference internal" href="rampart-url.html">The rampart-url module</a>
              </li>
              <li class="toctree-l1 current">
                <a class="reference internal" href="tutorialtoc.html">Tutorials</a>
                <ul class="current">
                  <li class="toctree-l2">
                    <a class="reference internal" href="tutorial-citysearch.html">Find Cities and their Closest
                    Neighbors</a>
                  </li>
                  <li class="toctree-l2 current">
                    <a class="current reference internal" href="#">Using Websockets to Build a Chat</a>
                    <ul>
                      <li class="toctree-l3">
                        <a class="reference internal" href="#preface">Preface</a>
                        <ul>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#license">License</a>
                          </li>
                        </ul>
                      </li>
                      <li class="toctree-l3">
                        <a class="reference internal" href="#concepts">Concepts</a>
                      </li>
                      <li class="toctree-l3">
                        <a class="reference internal" href="#getting-started">Getting Started</a>
                        <ul>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#web-server-layout">Web Server Layout</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#the-client-html-and-script">The Client HTML and
                            Script</a>
                          </li>
                        </ul>
                      </li>
                      <li class="toctree-l3">
                        <a class="reference internal" href="#websockets-server-script">Websockets Server Script</a>
                        <ul>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#the-basics-of-rampart-server-websockets">The Basics of
                            Rampart-Server Websockets</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#setup-on-connect">Setup on Connect</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#receiving-from-client-and-forward">Receiving from
                            Client and Forward</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#receiving-from-other-clients">Receiving from other
                            Clients</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#full-script">Full Script</a>
                          </li>
                        </ul>
                      </li>
                      <li class="toctree-l3">
                        <a class="reference internal" href="#handling-binary-data">Handling Binary Data</a>
                        <ul>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#client-side-additions">Client-side Additions</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#receiving-files-from-client-and-forward">Receiving
                            Files from Client and Forward</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#receiving-files-from-other-clients">Receiving Files
                            from other Clients</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#full-script-handling-files">Full Script Handling
                            Files</a>
                          </li>
                        </ul>
                      </li>
                      <li class="toctree-l3">
                        <a class="reference internal" href="#chat-with-history-using-redis">Chat with History using
                        Redis</a>
                        <ul>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#client-side-changes">Client-Side changes</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#starting-redis">Starting Redis</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#replacing-event-functions">Replacing Event
                            Functions</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#listening-for-messages">Listening for Messages</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#forwarding-messages">Forwarding Messages</a>
                          </li>
                          <li class="toctree-l4">
                            <a class="reference internal" href="#full-script-with-redis">Full Script with Redis</a>
                          </li>
                        </ul>
                      </li>
                      <li class="toctree-l3">
                        <a class="reference internal" href="#improvements">Improvements</a>
                      </li>
                    </ul>
                  </li>
                  <li class="toctree-l2">
                    <a class="reference internal" href="tutorial-pi_news.html">Building a Pi News Aggregator</a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i> <a href="index.html">Rampart</a>
        </nav>
        <div class="wy-nav-content">
          <div class="rst-content">
            <div role="navigation" aria-label="breadcrumbs navigation">
              <ul class="wy-breadcrumbs">
                <li>
                  <a href="/">Home</a> »
                </li>
                <li>
                  <a href="index.html">Docs</a> »
                </li>
                <li>
                  <a href="tutorialtoc.html">Tutorials</a> »
                </li>
                <li>Using Websockets to Build a Chat
                </li>
              </ul>
              <hr>
            </div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                <div class="section" id="using-websockets-to-build-a-chat">
                  <h1>
                    Using Websockets to Build a Chat<a class="headerlink" href="#using-websockets-to-build-a-chat"
                    title="Permalink to this headline">¶</a>
                  </h1>
                  <div class="section" id="preface">
                    <h2>
                      Preface<a class="headerlink" href="#preface" title="Permalink to this headline">¶</a>
                    </h2>
                    <p>
                      In this tutorial, we will use <a class="reference internal" href=
                      "rampart-main.html#rampart-event"><span class="std std-ref">event</span></a> functions and the
                      <a class="reference internal" href=
                      "rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">Server
                      module</span></a>, along with some client side scripting to create a multi-user chat application.
                    </p>
                    <p>
                      You can download the complete project from our <a class="reference external" href=
                      "https://github.com/aflin/rampart_tutorials">Tutorial Repository</a> in the <a class=
                      "reference external" href="https://github.com/aflin/rampart_tutorials/tree/main/chat">chat
                      directory</a>.
                    </p>
                    <div class="section" id="license">
                      <h3>
                        License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        The code related to this tutorial is released under the MIT license.
                      </p>
                    </div>
                  </div>
                  <div class="section" id="concepts">
                    <h2>
                      Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a>
                    </h2>
                    <p>
                      This module will demonstrate:
                    </p>
                    <ul class="simple">
                      <li>
                        <p>
                          Using <a class="reference internal" href="rampart-main.html#rampart-event"><span class=
                          "std std-ref">event</span></a> functions to relay messages between clients.
                        </p>
                      </li>
                      <li>
                        <p>
                          Using the <a class="reference internal" href=
                          "rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">Server
                          module</span></a> to connect with clients using websockets.
                        </p>
                      </li>
                      <li>
                        <p>
                          Handling both text and files using websockets.
                        </p>
                      </li>
                      <li>
                        <p>
                          Using <a class="reference internal" href=
                          "rampart-redis.html#the-rampart-redis-module"><span class="std std-ref">rampart-redis
                          module</span></a> to replace rampart.event so we can have a saved history.
                        </p>
                      </li>
                    </ul>
                    <p>
                      In order to complete this tutorial, you should have basic knowledge of JavaScript and client side
                      scripting using JavaScript (a passing knowledge of jQuery is also helpful). This tutorial will
                      not provide an in-depth explanation of how client-side scripting works.
                    </p>
                  </div>
                  <div class="section" id="getting-started">
                    <h2>
                      Getting Started<a class="headerlink" href="#getting-started" title=
                      "Permalink to this headline">¶</a>
                    </h2>
                    <div class="section" id="web-server-layout">
                      <h3>
                        Web Server Layout<a class="headerlink" href="#web-server-layout" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        In the Rampart binary distribution is a sample web server tree. For our purposes here, we
                        assume you have downloaded and unzipped the Rampart binary distribution into a directory named
                        <code class="docutils literal notranslate"><span class="pre">~/downloads/rampart</span></code>.
                        We will use that for this project. The <a class="reference internal" href=
                        "rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">The
                        rampart-server HTTP module</span></a> is configured and loaded from the included <code class=
                        "docutils literal notranslate"><span class="pre">web_server/web_server_conf.js</span></code>
                        script. It defines <code class="docutils literal notranslate"><span class=
                        "pre">web_server/html</span></code> as the default directory for static html, <code class=
                        "docutils literal notranslate"><span class="pre">web_server/wsapps</span></code> as the default
                        directory for websocket scripts.
                      </p>
                      <p>
                        To get started, copy the <code class="docutils literal notranslate"><span class=
                        "pre">web_server</span></code> directory to a convenient place for this project. Also, for our
                        purposes, we do not need anything in the <code class=
                        "docutils literal notranslate"><span class="pre">web_server/apps/test_modules</span></code> or
                        <code class="docutils literal notranslate"><span class=
                        "pre">web_server/apps/wsapps</span></code> directories, so you can delete the copy of those
                        files. We will also add an empty file at <code class=
                        "docutils literal notranslate"><span class="pre">web_server/wsapps/wschat.js</span></code> and
                        <code class="docutils literal notranslate"><span class=
                        "pre">web_server/html/websockets_chat/index.html</span></code>.
                      </p>
                      <div class="highlight-default notranslate">
                        <div class="highlight">
                          <pre><span></span>user@localhost:~$ mkdir wschat_demo
user@localhost:~$ cd wschat_demo
user@localhost:~/wschat_demo$ cp -a ~/downloads/rampart/web_server ./
user@localhost:~/wschat_demo$ cd web_server/
user@localhost:~/wschat_demo/web_server$ rm -rf apps/test_modules wsapps/* html/index.html
user@localhost:~/wschat_demo/web_server$ touch ./wsapps/wschat.js
user@localhost:~/wschat_demo/web_server$ mkdir html/websockets_chat
user@localhost:~/wschat_demo/web_server$ touch ./html/websockets_chat/index.html
user@localhost:~/wschat_demo/web_server$ find .
./wsapps
./wsapps/wschat.js
./start_server.sh
./stop_server.sh
./web_server_conf.js
./logs
./apps
./html
./html/images
./html/images/inigo-not-fount.jpg
./html/websockets_chat
./html/websockets_chat/index.html
./data
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="the-client-html-and-script">
                      <h3>
                        The Client HTML and Script<a class="headerlink" href="#the-client-html-and-script" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        As stated before, we assume that you have a basic understanding of the client-side scripting
                        and therefore will dispense with a lengthy discussion about it. The main points are:
                      </p>
                      <ul class="simple">
                        <li>
                          <p>
                            There is no security or user management. A new chat client merely types in a name and is
                            connected via websockets to the server.
                          </p>
                        </li>
                        <li>
                          <p>
                            The <code class="docutils literal notranslate"><span class="pre">start()</span></code>
                            function makes the initial connection to the server.
                          </p>
                        </li>
                        <li>
                          <p>
                            The <code class="docutils literal notranslate"><span class="pre">procmess()</span></code>
                            receives messages from the server, decodes the JSON and displays the message for the user.
                          </p>
                        </li>
                        <li>
                          <p>
                            The <code class="docutils literal notranslate"><span class="pre">send()</span></code>
                            function is called when the user presses &lt;enter&gt; in the text box at the bottom of the
                            web page.
                          </p>
                        </li>
                        <li>
                          <p>
                            The <code class="docutils literal notranslate"><span class=
                            "pre">showMessage()</span></code> function is used to display incoming or echo outgoing
                            messages in the chat div.
                          </p>
                        </li>
                      </ul>
                      <p>
                        So we will begin with opening <code class="docutils literal notranslate"><span class=
                        "pre">html/websockets_chat/index.html</span></code> in an editor and pasting the following:
                      </p>
                      <div class="highlight-html notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class=
"o">=</span><span class="s">"UTF-8"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>chat<span class=
"p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
    <span class="nt">html</span><span class="o">,</span><span class="nt">body</span> <span class="p">{</span>
        <span class="k">height</span><span class="p">:</span><span class="mi">100</span><span class=
"kt">%</span><span class="p">;</span>
        <span class="k">font-family</span><span class="p">:</span><span class="n">Arial</span><span class=
"p">,</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="kc">sans-serif</span><span class=
"p">;</span>
        <span class="k">margin</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">container</span><span class="p">{</span>
        <span class="k">border</span><span class="p">:</span><span class="mi">5</span><span class=
"kt">px</span> <span class="kc">solid</span> <span class="kc">grey</span><span class="p">;</span>
        <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class=
"p">;</span>
        <span class="k">margin-top</span> <span class="p">:</span> <span class="mi">10</span><span class=
"kt">px</span><span class="p">;</span>
        <span class="k">padding</span><span class="p">:</span><span class="mi">10</span><span class=
"kt">px</span><span class="p">;</span>
        <span class="k">bottom</span><span class="p">:</span><span class="mi">30</span><span class=
"kt">px</span><span class="p">;</span>
        <span class="k">top</span><span class="p">:</span> <span class="mi">30</span><span class=
"kt">px</span><span class="p">;</span>
        <span class="k">right</span><span class="p">:</span><span class="mi">20</span><span class=
"kt">px</span><span class="p">;</span>
        <span class="k">left</span><span class="p">:</span><span class="mi">20</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">chatdiv</span><span class="p">{</span>
        <span class="k">padding</span><span class="p">:</span><span class="mi">5</span><span class=
"kt">px</span><span class="p">;</span>
        <span class="k">border</span><span class="p">:</span><span class="mi">2</span><span class=
"kt">px</span> <span class="kc">solid</span> <span class="kc">gray</span><span class="p">;</span>
        <span class="k">height</span><span class="p">:</span> <span class="nb">calc</span><span class=
"p">(</span><span class="mi">100</span><span class="kt">%</span> <span class="o">-</span> <span class=
"mi">175</span><span class="kt">px</span><span class="p">);</span>
        <span class="k">overflow-y</span><span class="p">:</span> <span class="kc">scroll</span><span class=
"p">;</span>
        <span class="k">margin</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">margin-top</span><span class="p">:</span> <span class="mi">5</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">event</span> <span class="p">{</span>
        <span class="k">color</span><span class="p">:</span><span class="mh">#999</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">n</span> <span class="p">{</span>
        <span class="k">color</span><span class="p">:</span><span class="mh">#393</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">i</span> <span class="p">{</span>
        <span class="k">vertical-align</span><span class="p">:</span> <span class="kc">top</span><span class=
"p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">s</span> <span class="p">{</span>
        <span class="k">color</span><span class="p">:</span><span class="mh">#933</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">wrapper</span><span class="p">{</span>
        <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class=
"kt">%</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">name</span><span class="p">{</span>
        <span class="k">width</span><span class="p">:</span><span class="mi">220</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">chatdiv</span><span class="p">.</span><span class=
"nc">dropping</span> <span class="p">{</span>
        <span class="k">border</span><span class="p">:</span> <span class="mi">2</span><span class=
"kt">px</span> <span class="kc">blue</span> <span class="kc">dashed</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">#</span><span class="nn">chatin</span><span class="p">{</span>
        <span class="k">width</span><span class="p">:</span> <span class="nb">calc</span><span class=
"p">(</span><span class="mi">100</span><span class="kt">%</span> <span class="o">-</span> <span class=
"mi">120</span><span class="kt">px</span><span class="p">);</span>
        <span class="k">height</span><span class="p">:</span> <span class="mf">1.5</span><span class=
"kt">em</span><span class="p">;</span>
        <span class="k">margin-top</span><span class="p">:</span> <span class="mi">7</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class=
"o">=</span><span class="s">"https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"</span><span class=
"p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class=
"nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class=
"p">{</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">name</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">reconnected</span><span class="o">=</span><span class=
"kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cd</span> <span class="o">=</span> <span class=
"nx">$</span><span class="p">(</span><span class="s1">'#chatdiv'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">prot</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">htmlEscape</span><span class="o">=</span><span class=
"kc">true</span><span class="p">;</span>

    <span class="c1">// check our protocol, set matching websocket version</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/^https:/</span><span class=
"p">.</span><span class="nx">test</span><span class="p">(</span><span class="nb">window</span><span class=
"p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class=
"p">))</span>
        <span class="nx">prot</span><span class="o">=</span><span class="s1">'wss://'</span>
    <span class="k">else</span>
        <span class="nx">prot</span><span class="o">=</span><span class="s1">'ws://'</span>

    <span class="c1">// check if connection is open</span>
    <span class="kd">function</span> <span class="nx">isOpen</span><span class="p">(</span><span class=
"nx">ws</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class=
"nx">ws</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class=
"nx">ws</span><span class="p">.</span><span class="nx">OPEN</span> <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getcookie</span><span class="p">(</span><span class=
"nx">cname</span><span class="p">){</span>
        <span class="c1">//https://www.30secondsofcode.org/js/s/parse-cookie</span>
        <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class=
"nb">document</span><span class="p">.</span><span class="nx">cookie</span>
            <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class=
"s1">';'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class=
"nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class=
"nx">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">reduce</span>
            <span class="p">(</span> <span class="p">(</span><span class="nx">acc</span><span class=
"p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">acc</span><span class="p">[</span><span class=
"nb">decodeURIComponent</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class=
"mi">0</span><span class="p">].</span><span class="nx">trim</span><span class="p">())]</span> <span class=
"o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">v</span><span class=
"p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">());</span>
                <span class="k">return</span> <span class="nx">acc</span><span class="p">;</span>
                <span class="p">},</span> <span class="p">{}</span>
            <span class="p">);</span>
        <span class="k">return</span> <span class="nx">cookies</span><span class="p">[</span><span class=
"nx">cname</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">showMessage</span><span class="p">(</span><span class=
"nx">data</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">htmlEscape</span><span class="p">)</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">msg</span> <span class=
"o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'&lt;div/&gt;'</span><span class=
"p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">msg</span><span class="p">).</span><span class="nx">html</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="o">==</span><span class="s2">"System"</span><span class=
"p">)</span>
            <span class="nx">cd</span><span class="p">.</span><span class="nx">append</span><span class=
"p">(</span><span class="s1">'&lt;span class="s"&gt;'</span> <span class="o">+</span> <span class=
"nx">data</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span> <span class=
"s2">":&lt;/span&gt; "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class=
"nx">msg</span> <span class="o">+</span><span class="s1">'&lt;br&gt;'</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nx">cd</span><span class="p">.</span><span class="nx">append</span><span class=
"p">(</span><span class="s1">'&lt;span class="n"&gt;'</span> <span class="o">+</span> <span class=
"nx">data</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span> <span class=
"s2">":&lt;/span&gt; "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class=
"nx">msg</span> <span class="o">+</span><span class="s1">'&lt;br&gt;'</span><span class="p">);</span>
        <span class="nx">cd</span><span class="p">.</span><span class="nx">scrollTop</span><span class=
"p">(</span><span class="nx">cd</span><span class="p">.</span><span class="nx">height</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">procmess</span> <span class="p">(</span><span class=
"nx">msg</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>

        <span class="k">try</span><span class="p">{</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class=
"p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class=
"p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class=
"nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cd</span><span class="p">.</span><span class="nx">append</span><span class=
"p">(</span><span class=
"s1">'&lt;span style="color:red;"&gt;error parsing message&lt;/span&gt;&lt;br&gt;'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// if reconnected, skip welcome message.</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">reconnected</span><span class="p">){</span>
            <span class="nx">reconnected</span><span class="o">=</span><span class="kc">false</span><span class=
"p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="nx">showMessage</span><span class="p">(</span><span class="nx">data</span><span class=
"p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">send</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">text</span><span class="o">=</span><span class=
"nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class="p">).</span><span class=
"nx">val</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">text</span><span class=
"o">==</span><span class="s2">""</span><span class="p">){</span>
            <span class="k">return</span> <span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">data</span><span class="o">=</span> <span class="p">{</span>
            <span class="nx">msg</span><span class="o">:</span> <span class="nx">text</span><span class="p">,</span>
            <span class="nx">from</span><span class="o">:</span> <span class="nx">name</span>
        <span class="p">};</span>

        <span class="k">try</span><span class="p">{</span>
            <span class="c1">// attempt reconnect if discoonnected</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">isOpen</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class=
"o">&amp;&</span> <span class="o">!</span><span class="nx">reconnected</span><span class="p">)</span> <span class=
"p">{</span>
                <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class=
"nx">WebSocket</span><span class="p">(</span><span class="nx">prot</span> <span class="o">+</span> <span class=
"nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class=
"nx">host</span> <span class="o">+</span> <span class="s2">"/wsapps/wschat-s.json"</span><span class="p">);</span>
                <span class="nx">socket</span><span class="p">.</span><span class=
"nx">addEventListener</span><span class="p">(</span><span class="s1">'open'</span><span class="p">,</span> <span class=
"kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
                    <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class=
"p">(</span><span class="nx">text</span><span class="p">);</span>
                    <span class="nx">reconnected</span><span class="o">=</span><span class="kc">true</span><span class=
"p">;</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">""</span><span class="p">);</span>
                    <span class="nx">showMessage</span><span class="p">(</span><span class="nx">data</span><span class=
"p">);</span>
                    <span class="nx">socket</span><span class="p">.</span><span class=
"nx">onmessage</span> <span class="o">=</span> <span class="nx">procmess</span><span class="p">;</span>
                <span class="p">});</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//send it</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class=
"p">(</span><span class="nx">text</span><span class="p">);</span>
            <span class="c1">//echo it</span>
            <span class="nx">showMessage</span><span class="p">(</span><span class="nx">data</span><span class=
"p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class=
"nx">e</span><span class="p">){</span>
            <span class="nx">showMessage</span><span class="p">({</span><span class="nx">from</span><span class=
"o">:</span><span class="s2">"System"</span><span class="p">,</span><span class="nx">msg</span><span class=
"o">:</span><span class="s1">'error sending message'</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">""</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">start</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class=
"p">();</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class=
"nx">WebSocket</span><span class="p">(</span><span class="nx">prot</span> <span class="o">+</span> <span class=
"nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class=
"nx">host</span> <span class="o">+</span> <span class="s2">"/wsapps/wschat-s.json"</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class=
"o">=</span> <span class="nx">procmess</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">setname</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">$</span><span class=
"p">(</span><span class="s1">'#name'</span><span class="p">).</span><span class="nx">val</span><span class=
"p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class=
"o">==</span><span class="s2">""</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class=
"o">=</span> <span class="s2">"username="</span><span class="o">+</span><span class="nx">name</span> <span class=
"o">+</span> <span class="s2">"; path=/; sameSite=Strict"</span><span class="p">;</span>
        <span class="nx">start</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// send message to server when &lt;enter&gt; is pressed</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">keypress</span><span class="p">(</span><span class="kd">function</span><span class=
"p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class=
"p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="s1">'13'</span><span class=
"p">)</span> <span class="p">{</span>
            <span class="nx">send</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// sign on</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#name'</span><span class=
"p">).</span><span class="nx">keypress</span><span class="p">(</span><span class="kd">function</span><span class=
"p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class=
"p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="s1">'13'</span><span class=
"p">)</span> <span class="p">{</span>
            <span class="nx">setname</span><span class="p">();</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#namemsg'</span><span class=
"p">).</span><span class="nx">text</span><span class="p">(</span><span class=
"s2">"You are logged in as "</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">focus</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// check if we signed on previously</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">getcookie</span><span class=
"p">(</span><span class="s2">"username"</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class=
"p">{</span>
        <span class="nx">start</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#name'</span><span class=
"p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#namemsg'</span><span class=
"p">).</span><span class="nx">text</span><span class="p">(</span><span class=
"s2">"You are logged in as "</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"wrapper"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>wschat tutorial<span class=
"p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"namespan"</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"namemsg"</span><span class="p">&gt;</span>Type Your Name and pres <span class=
"ni">&amp;lt;</span>enter<span class="ni">&amp;gt;</span> to begin:<span class="p">&lt;/</span><span class=
"nt">span</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class=
"na">placeholder</span><span class="o">=</span><span class="s">"Type your name and press enter"</span> <span class=
"na">id</span><span class="o">=</span><span class="s">"name"</span> <span class="na">type</span><span class=
"o">=</span><span class="s">"text"</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"chatdiv"</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"chatin"</span> <span class="na">type</span><span class="o">=</span><span class=
"s">"text"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="section" id="websockets-server-script">
                    <h2>
                      Websockets Server Script<a class="headerlink" href="#websockets-server-script" title=
                      "Permalink to this headline">¶</a>
                    </h2>
                    <div class="section" id="the-basics-of-rampart-server-websockets">
                      <h3>
                        The Basics of Rampart-Server Websockets<a class="headerlink" href=
                        "#the-basics-of-rampart-server-websockets" title="Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        As you probably know, server scripts are passed a <code class=
                        "docutils literal notranslate"><span class="pre">req</span></code> object when serving content
                        via the http and https protocols. Each request from a client results in a call to the
                        appropriate JavaScript callback, which receives a fresh <code class=
                        "docutils literal notranslate"><span class="pre">req</span></code> object with the details of
                        the request.
                      </p>
                      <p>
                        Websocket connections differ in that the <code class=
                        "docutils literal notranslate"><span class="pre">req</span></code> object is long lived and is
                        unique to the server-client connection rather than unique to a single request. More information
                        on how this works can be found in the <a class="reference internal" href=
                        "rampart-server.html#websockets"><span class="std std-ref">Server Websockets
                        Section</span></a>. However, here are the basics we need to know for this tutorial:
                      </p>
                      <blockquote>
                        <div>
                          <ul class="simple">
                            <li>
                              <p>
                                The <code class="docutils literal notranslate"><span class=
                                "pre">module.exports</span></code> function is run for every incoming websocket
                                message.
                              </p>
                            </li>
                            <li>
                              <p>
                                <code class="docutils literal notranslate"><span class="pre">req.count</span></code> is
                                the number of times function has been called since connection was made.
                              </p>
                            </li>
                            <li>
                              <p>
                                The first run (<code class="docutils literal notranslate"><span class=
                                "pre">req.count==0</span></code>) will have an empty body and represents the initial
                                connection.
                              </p>
                            </li>
                            <li>
                              <p>
                                The <code class="docutils literal notranslate"><span class="pre">req</span></code>
                                object is reused with <code class="docutils literal notranslate"><span class=
                                "pre">req.body</span></code> updated for each incoming message.
                              </p>
                            </li>
                            <li>
                              <p>
                                Sending data to the client is done with <code class=
                                "docutils literal notranslate"><span class="pre">req.wsSend()</span></code>.
                              </p>
                            </li>
                            <li>
                              <p>
                                Any data printed or put using <code class="docutils literal notranslate"><span class=
                                "pre">req.printf</span></code>/<code class="docutils literal notranslate"><span class=
                                "pre">req.put</span></code> will also be sent when <code class=
                                "docutils literal notranslate"><span class="pre">req.wsSend()</span></code> is called
                                or when the <code class="docutils literal notranslate"><span class=
                                "pre">module.exports</span></code> function returns.
                              </p>
                            </li>
                            <li>
                              <p>
                                <code class="docutils literal notranslate"><span class=
                                "pre">req.wsOnDisconnect</span></code> registers a function that is run when you
                                disconnect or you are disconnected by the client.
                              </p>
                            </li>
                            <li>
                              <p>
                                <code class="docutils literal notranslate"><span class="pre">req.wsEnd</span></code>
                                forces a disconnect (but runs callback first);
                              </p>
                            </li>
                            <li>
                              <p>
                                <code class="docutils literal notranslate"><span class=
                                "pre">req.websocketId</span></code> is a unique number to identify the current
                                connection to a single client.
                              </p>
                            </li>
                            <li>
                              <p>
                                <code class="docutils literal notranslate"><span class="pre">req.wsIsBin</span></code>
                                is <code class="docutils literal notranslate"><span class="pre">true</span></code> if
                                the client sends binary data. Data will be in <code class=
                                "docutils literal notranslate"><span class="pre">req.body</span></code>.
                              </p>
                            </li>
                            <li>
                              <p>
                                <code class="docutils literal notranslate"><span class="pre">req.body</span></code> is
                                always a <span class="green">Buffer</span>. If <code class=
                                "docutils literal notranslate"><span class="pre">req.wsIsBin</span></code> is
                                <code class="docutils literal notranslate"><span class="pre">false</span></code>, it
                                can be converted to a <span class="green">String</span> using <code class=
                                "docutils literal notranslate"><span class=
                                "pre">rampart.utils.sprintf('%s',req.body)</span></code> or <code class=
                                "docutils literal notranslate"><span class=
                                "pre">rampart.utils.bufferToString(req.body)</span></code>.
                              </p>
                            </li>
                          </ul>
                        </div>
                      </blockquote>
                      <p>
                        With your favorite editor, open the <code class="docutils literal notranslate"><span class=
                        "pre">wsapps/wschat.js</span></code> file and paste this stub script to begin:
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="nx">rampart</span><span class="p">.</span><span class=
                          "nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class=
                          "p">.</span><span class="nx">utils</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ev</span> <span class="o">=</span> <span class=
"nx">rampart</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>


<span class="kd">function</span> <span class="nx">getuser</span><span class="p">(</span><span class=
"nx">req</span><span class="p">){</span>
    <span class="c1">// no real user management here</span>
    <span class="c1">// just use the cookie set in client-side script</span>
    <span class="c1">// however here is where you could add an authentication scheme</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">cookies</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">receive_message</span><span class="p">()</span> <span class=
"p">{</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">setup_event_listen</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">forward_messages</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// exporting a single function</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class=
"o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class=
"p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* first run upon connect, req.body is empty</span>
<span class="cm">           Here is where we will set up the event to listen for</span>
<span class="cm">           incoming message from other users</span>
<span class="cm">         */</span>
        <span class="nx">setup_event_listen</span><span class="p">(</span><span class="nx">req</span><span class=
"p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* second and subsequent runs below.  Client has sent a message</span>
<span class="cm">           and we need to process and forward it to others who are</span>
<span class="cm">           listening via rampart.event.on above</span>
<span class="cm">         */</span>
        <span class="nx">forward_messages</span><span class="p">(</span><span class="nx">req</span><span class=
"p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="setup-on-connect">
                      <h3>
                        Setup on Connect<a class="headerlink" href="#setup-on-connect" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        We will use the <code class="docutils literal notranslate"><span class=
                        "pre">setup_event_listen()</span></code> function to simulate authentication of the user, set
                        up an event, register a function to handle a client disconnect and send a message letting other
                        clients know a new client has joined.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">function</span> <span class=
                          "nx">setup_event_listen</span><span class="p">(</span><span class="nx">req</span><span class=
                          "p">)</span> <span class="p">{</span>

    <span class="cm">/* check for username */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">=</span><span class="nx">getuser</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">user_name</span><span class="p">){</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span> <span class="s2">"System"</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"No user name provided, disconnecting"</span><span class="p">});</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* what to do if we are sent a message from another user.  Here</span>
<span class="cm">       ``rampart.event.on`` registers a callback function to be</span>
<span class="cm">       executed.  The callback function will take two parameters: a</span>
<span class="cm">       variable provided by "event.on" and a provided by "trigger".  The</span>
<span class="cm">       function is registered with the event name "msgev" and the</span>
<span class="cm">       function name "userfunc_x" where x is the unique websocketId for</span>
<span class="cm">       this connection.  The varable "req" is passed to the</span>
<span class="cm">       proc_incoming_message as its first argument.  */</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class=
"s2">"msgev"</span><span class="p">,</span> <span class="s2">"userfunc_"</span><span class="o">+</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">receive_message</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>

    <span class=
"c1">// set up function for when this user disconnects (either by browser disconnect or req.wsEnd() )</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsOnDisconnect</span><span class=
"p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// msg -&gt; everyone listening</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="o">+</span><span class=
"s2">" has left the conversation"</span><span class="p">});</span>
        <span class="c1">// remove our function unique to this use from the event</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">off</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="s2">"userfunc_"</span><span class=
"o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class=
"p">);</span>
    <span class="p">});</span>

    <span class="cm">/* send a notification to all listening that we've joined the conversation */</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="o">+</span><span class=
"s2">" has joined the conversation"</span><span class="p">});</span>

    <span class="c1">// send a welcome message to client from the "System".</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class=
"s2">"System"</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"sb">`Welcome </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span> <span class=
"p">);</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                      <p>
                        The <code class="docutils literal notranslate"><span class=
                        "pre">setup_event_listen()</span></code> function is run only upon first connecting. When it is
                        done, the server sends any pending messages and then waits for either 1) a message from our
                        client (which we will forward to other clients in the code below), 2) for some other client or
                        script to “trigger” our event with <code class="docutils literal notranslate"><span class=
                        "pre">rampart.event.trigger("msgev",...)</span></code> or 3) some other event, HTTP request,
                        other websocket connections and any other asynchronous function, such as <code class=
                        "docutils literal notranslate"><span class="pre">setTimeout</span></code> or asynchronous
                        functions in <a class="reference internal" href=
                        "rampart-redis.html#the-rampart-redis-module"><span class="std std-ref">the rampart-redis
                        module</span></a>). This all happens within the Rampart event loop.
                      </p>
                    </div>
                    <div class="section" id="receiving-from-client-and-forward">
                      <h3>
                        Receiving from Client and Forward<a class="headerlink" href=
                        "#receiving-from-client-and-forward" title="Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        Next we will use the <code class="docutils literal notranslate"><span class=
                        "pre">forward_message()</span></code> function to format and forward messages from the client
                        and send them to other connected clients using <code class=
                        "docutils literal notranslate"><span class="pre">rampart.event.trigger</span></code>.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">function</span> <span class=
                          "nx">forward_messages</span><span class="p">(</span><span class="nx">req</span><span class=
                          "p">)</span> <span class="p">{</span>

    <span class="c1">// only accepting text messages</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">wsIsBin</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//send the plain text message to whoever is listening</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class=
"o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">'%s'</span><span class=
"p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">msg</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">body</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                      <p>
                        Here we trigger the <code class="docutils literal notranslate"><span class=
                        "pre">msgev</span></code> event. Every connected client, including the current one, and every
                        script running, having registered the <code class="docutils literal notranslate"><span class=
                        "pre">msgev</span></code> event, will be triggered and run the registered functions.
                      </p>
                    </div>
                    <div class="section" id="receiving-from-other-clients">
                      <h3>
                        Receiving from other Clients<a class="headerlink" href="#receiving-from-other-clients" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        Here we will fill in the function registered with <code class=
                        "docutils literal notranslate"><span class="pre">rampart.event.on("msgev",</span> <span class=
                        "pre">...)</span></code>. Its job is to forward messages sent by other clients (via
                        <code class="docutils literal notranslate"><span class=
                        "pre">rampart.event.trigger</span></code>) to the browser for display. Since the client-side
                        script does its own echo, we will filter out messages from our own client.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class=
                          "cm">/* process incoming message as sent below in ev.trigger() with data set to</span>
<span class="cm">   { from: user_name, id: user_id, [ msg: "a message" | file: binary_file_data] }</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">receive_message</span><span class="p">(</span><span class=
"nx">req</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">id</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">)</span> <span class="p">{</span><span class=
"c1">//don't echo our own message</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
            <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
            <span class="nx">msg</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">msg</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="full-script">
                      <h3>
                        Full Script<a class="headerlink" href="#full-script" title="Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        Our script so far:
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="nx">rampart</span><span class="p">.</span><span class=
                          "nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class=
                          "p">.</span><span class="nx">utils</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ev</span> <span class="o">=</span> <span class=
"nx">rampart</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">getuser</span><span class="p">(</span><span class=
"nx">req</span><span class="p">){</span>
    <span class="c1">// no real user management here</span>
    <span class="c1">// just use the cookie set in client-side script</span>
    <span class="c1">// however here is where you could add an authentication scheme</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">cookies</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NOTES:</span>
<span class="cm"> * The module.exports function is run for every incoming websocket message.</span>
<span class="cm"> * The first run (req.count==0) will have an empty body and represents the initial connection.</span>
<span class="cm"> * The req object is reused with req.body updated for each incoming message.</span>
<span class="cm"> * Sending data back is done with req.wsSend().</span>
<span class="cm"> * Any data printed or put using req.printf/req.put will also be sent when</span>
<span class="cm"> *   req.wsSend() is called or when the module.exports function returns</span>
<span class="cm"> * req.count == number of times function has been called since connection was made.</span>
<span class=
"cm"> * req.wsOnDisconnect is a function that is run when you disconnect or you are disconnected by the client.</span>
<span class="cm"> * req.wsEnd forces a disconnect (but runs callback first);</span>
<span class="cm"> * req.websocketId is a unique number to identify the current connection to a single client.</span>
<span class="cm"> * req.wsIsBin is true if the client sends binary data.  Data will be in req.body</span>
<span class="cm"> * req.body is always a buffer.  If req.wsIsBin is false, it can be converted to a string.</span>
<span class="cm"> *   using rampart.utils.sprintf('%s',req.body) or rampart.utils.bufferToString(req.body)</span>
<span class="cm"> */</span>


<span class="cm">/* process incoming message as sent below in ev.trigger() with data set to</span>
<span class="cm">   { from: user_name, id: user_id, [ msg: "a message" | file: binary_file_data] }</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">receive_message</span><span class="p">(</span><span class=
"nx">req</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">id</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">)</span> <span class="p">{</span><span class=
"c1">//don't echo our own message</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
            <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
            <span class="nx">msg</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">msg</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">setup_event_listen</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* check for username */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">=</span><span class="nx">getuser</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">user_name</span><span class="p">){</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span> <span class="s2">"System"</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"No user name provided, disconnecting"</span><span class="p">});</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* what to do if we are sent a message from another user.  Here</span>
<span class="cm">       ``rampart.event.on`` registers a callback function to be</span>
<span class="cm">       executed.  The callback function will take two parameters: a</span>
<span class="cm">       variable provided by "event.on" and a provided by "trigger".  The</span>
<span class="cm">       function is registered with the event name "msgev" and the</span>
<span class="cm">       function name "userfunc_x" where x is the unique websocketId for</span>
<span class="cm">       this connection.  The varable "req" is passed to the</span>
<span class="cm">       proc_incoming_message as its first argument.  */</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class=
"s2">"msgev"</span><span class="p">,</span> <span class="s2">"userfunc_"</span><span class="o">+</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">receive_message</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>

    <span class=
"c1">// set up function for when this user disconnects (either by browser disconnect or req.wsEnd() )</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsOnDisconnect</span><span class=
"p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// msg -&gt; everyone listening</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="o">+</span><span class=
"s2">" has left the conversation"</span><span class="p">});</span>
        <span class="c1">// remove our function unique to this use from the event</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">off</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="s2">"userfunc_"</span><span class=
"o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class=
"p">);</span>
    <span class="p">});</span>

    <span class="cm">/* send a notification to all listening that we've joined the conversation */</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="o">+</span><span class=
"s2">" has joined the conversation"</span><span class="p">});</span>

    <span class="c1">// send a welcome message to client from the "System".</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class=
"s2">"System"</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"sb">`Welcome </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span> <span class=
"p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">forward_messages</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// only accepting text messages</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">wsIsBin</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//send the plain text message to whoever is listening</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class=
"o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">'%s'</span><span class=
"p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">msg</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">body</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// exporting a single function</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class=
"o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class=
"p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* first run upon connect, req.body is empty</span>
<span class="cm">           Here is where we will set up the event to listen for</span>
<span class="cm">           incoming message from other users</span>
<span class="cm">         */</span>
        <span class="nx">setup_event_listen</span><span class="p">(</span><span class="nx">req</span><span class=
"p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* second and subsequent runs below.  Client has sent a message</span>
<span class="cm">           and we need to process and forward it to others who are</span>
<span class="cm">           listening via rampart.event.on above</span>
<span class="cm">         */</span>
        <span class="nx">forward_messages</span><span class="p">(</span><span class="nx">req</span><span class=
"p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="section" id="handling-binary-data">
                    <h2>
                      Handling Binary Data<a class="headerlink" href="#handling-binary-data" title=
                      "Permalink to this headline">¶</a>
                    </h2>
                    <p>
                      What we have so far works well for chatting. However, users might want to send files or images as
                      well. So we will add that functionality.
                    </p>
                    <div class="section" id="client-side-additions">
                      <h3>
                        Client-side Additions<a class="headerlink" href="#client-side-additions" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        We will alter our client-side script to handle drag-and-drop of files and send them to the
                        server. Again, a full explanation of how this works is beyond the scope of this tutorial.
                      </p>
                      <div class="highlight-html notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class=
"o">=</span><span class="s">"UTF-8"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>chat<span class=
"p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="nt">html</span><span class="o">,</span><span class="nt">body</span> <span class="p">{</span>
    <span class="k">height</span><span class="p">:</span><span class="mi">100</span><span class=
"kt">%</span><span class="p">;</span>
    <span class="k">font-family</span><span class="p">:</span><span class="n">Arial</span><span class=
"p">,</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="kc">sans-serif</span><span class=
"p">;</span>
    <span class="k">margin</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">container</span><span class="p">{</span>
    <span class="k">border</span><span class="p">:</span><span class="mi">5</span><span class=
"kt">px</span> <span class="kc">solid</span> <span class="kc">grey</span><span class="p">;</span>
    <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
    <span class="k">margin-top</span> <span class="p">:</span> <span class="mi">10</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="k">padding</span><span class="p">:</span><span class="mi">10</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="k">bottom</span><span class="p">:</span><span class="mi">30</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="k">top</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span><span class=
"p">;</span>
    <span class="k">right</span><span class="p">:</span><span class="mi">20</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="k">left</span><span class="p">:</span><span class="mi">20</span><span class="kt">px</span><span class=
"p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">chatdiv</span><span class="p">{</span>
    <span class="k">padding</span><span class="p">:</span><span class="mi">5</span><span class=
"kt">px</span><span class="p">;</span>
    <span class="k">border</span><span class="p">:</span><span class="mi">2</span><span class=
"kt">px</span> <span class="kc">solid</span> <span class="kc">gray</span><span class="p">;</span>
    <span class="k">height</span><span class="p">:</span> <span class="nb">calc</span><span class=
"p">(</span><span class="mi">100</span><span class="kt">%</span> <span class="o">-</span> <span class=
"mi">175</span><span class="kt">px</span><span class="p">);</span>
    <span class="k">overflow-y</span><span class="p">:</span> <span class="kc">scroll</span><span class="p">;</span>
    <span class="k">margin</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">margin-top</span><span class="p">:</span> <span class="mi">5</span><span class=
"kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">.</span><span class="nc">event</span> <span class="p">{</span>
    <span class="k">color</span><span class="p">:</span><span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">.</span><span class="nc">n</span> <span class="p">{</span>
    <span class="k">color</span><span class="p">:</span><span class="mh">#393</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">.</span><span class="nc">i</span> <span class="p">{</span>
    <span class="k">vertical-align</span><span class="p">:</span> <span class="kc">top</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">.</span><span class="nc">s</span> <span class="p">{</span>
    <span class="k">color</span><span class="p">:</span><span class="mh">#933</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">wrapper</span><span class="p">{</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class=
"kt">%</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">name</span><span class="p">{</span>
    <span class="k">width</span><span class="p">:</span><span class="mi">220</span><span class=
"kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">chatdiv</span><span class="p">.</span><span class=
"nc">dropping</span> <span class="p">{</span>
    <span class="k">border</span><span class="p">:</span> <span class="mi">2</span><span class=
"kt">px</span> <span class="kc">blue</span> <span class="kc">dashed</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">chatin</span><span class="p">{</span>
    <span class="k">width</span><span class="p">:</span> <span class="nb">calc</span><span class=
"p">(</span><span class="mi">100</span><span class="kt">%</span> <span class="o">-</span> <span class=
"mi">120</span><span class="kt">px</span><span class="p">);</span>
    <span class="k">height</span><span class="p">:</span> <span class="mf">1.5</span><span class=
"kt">em</span><span class="p">;</span>
    <span class="k">margin-top</span><span class="p">:</span> <span class="mi">7</span><span class=
"kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class=
"o">=</span><span class="s">"https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"</span><span class=
"p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class=
"nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class=
"p">{</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">name</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">reconnected</span><span class="o">=</span><span class=
"kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cd</span> <span class="o">=</span> <span class=
"nx">$</span><span class="p">(</span><span class="s1">'#chatdiv'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">prot</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">htmlEscape</span><span class="o">=</span><span class=
"kc">true</span><span class="p">;</span>

    <span class="c1">// check our protocol, set matching websocket version</span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/^https:/</span><span class=
"p">.</span><span class="nx">test</span><span class="p">(</span><span class="nb">window</span><span class=
"p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class=
"p">))</span>
        <span class="nx">prot</span><span class="o">=</span><span class="s1">'wss://'</span>
    <span class="k">else</span>
        <span class="nx">prot</span><span class="o">=</span><span class="s1">'ws://'</span>

    <span class="c1">// check if connection is open</span>
    <span class="kd">function</span> <span class="nx">isOpen</span><span class="p">(</span><span class=
"nx">ws</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class=
"nx">ws</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class=
"nx">ws</span><span class="p">.</span><span class="nx">OPEN</span> <span class="p">}</span>

    <span class="c1">// display image, or link other types of binary files</span>
    <span class="kd">function</span> <span class="nx">displayfile</span><span class="p">(</span><span class=
"nx">data</span><span class="p">,</span> <span class="nx">blob</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">finfo</span><span class="o">=</span><span class=
"nx">data</span><span class="p">.</span><span class="nx">file</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class=
"nx">blob</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class=
"mi">0</span><span class="p">,</span> <span class="nx">blob</span><span class="p">.</span><span class=
"nx">size</span><span class="p">,</span> <span class="nx">finfo</span><span class="p">.</span><span class=
"nx">type</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">linkurl</span> <span class="o">=</span> <span class=
"nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class=
"nx">b</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="sr">/^image/</span><span class=
"p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">finfo</span><span class=
"p">.</span><span class="nx">type</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="nx">cd</span><span class="p">.</span><span class="nx">append</span><span class=
"p">(</span><span class="s1">'&lt;span class="s i"&gt;'</span> <span class="o">+</span> <span class=
"nx">data</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span>
            <span class="s1">':&lt;/span&gt; &lt;img style="height: 300px"&gt;&lt;br&gt;'</span><span class=
"p">);</span>
            <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class=
"nx">cd</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class=
"s1">'img'</span><span class="p">).</span><span class="nx">last</span><span class="p">();</span>
            <span class="nx">img</span><span class="p">.</span><span class="nx">attr</span><span class=
"p">({</span><span class="s1">'src'</span><span class="o">:</span> <span class="nx">linkurl</span><span class=
"p">,</span> <span class="s1">'alt'</span><span class="o">:</span> <span class="nx">finfo</span><span class=
"p">.</span><span class="nx">name</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">cd</span><span class="p">.</span><span class="nx">append</span><span class=
"p">(</span><span class="s1">'&lt;span class="s"&gt;'</span> <span class="o">+</span> <span class=
"nx">data</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span>  <span class=
"s1">':&lt;/span&gt; FILE: &lt;a&gt;'</span><span class="o">+</span><span class="nx">finfo</span><span class=
"p">.</span><span class="nx">name</span><span class="o">+</span><span class=
"s1">'&lt;/a&gt;&lt;br&gt;'</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class=
"nx">cd</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class=
"s1">'a'</span><span class="p">).</span><span class="nx">last</span><span class="p">();</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">attr</span><span class=
"p">({</span><span class="s2">"href"</span><span class="o">:</span><span class="nx">linkurl</span><span class=
"p">,</span> <span class="s2">"download"</span><span class="o">:</span><span class="nx">finfo</span><span class=
"p">.</span><span class="nx">name</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">cd</span><span class="p">.</span><span class="nx">scrollTop</span><span class=
"p">(</span><span class="nx">cd</span><span class="p">.</span><span class="nx">height</span><span class=
"p">()</span> <span class="o">+</span> <span class="mi">300</span><span class="p">);</span>
        <span class="nx">data</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// what to do when a file is dropped on conversation div</span>
    <span class="kd">function</span> <span class="nx">handle_drop</span><span class="p">(</span><span class=
"nx">e</span><span class="p">){</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class=
"p">();</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class=
"p">();</span>
        <span class="nx">cd</span><span class="p">.</span><span class="nx">removeClass</span><span class=
"p">(</span><span class="s2">"dropping"</span><span class="p">);</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class=
"p">.</span><span class="nx">originalEvent</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">isOpen</span><span class="p">(</span><span class="nx">socket</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span><span class="c1">//fix me.</span>

        <span class="c1">// send file to server, display it in conversation div</span>
        <span class="kd">function</span> <span class="nx">sendfile</span><span class="p">(</span><span class=
"nx">file</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class=
"k">new</span> <span class="nx">FileReader</span><span class="p">()</span>
            <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class=
"o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class=
"p">)</span> <span class="p">{</span>
                <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class=
"p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class=
"p">.</span><span class="nx">result</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class=
"p">(</span><span class="nx">file</span><span class="p">);</span>
            <span class="c1">// we get to see the file too</span>
            <span class="nx">displayfile</span><span class="p">({</span><span class="nx">from</span><span class=
"o">:</span><span class="nx">name</span><span class="p">,</span><span class="nx">file</span><span class=
"o">:</span><span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class=
"nx">type</span><span class="o">:</span><span class="nx">file</span><span class="p">.</span><span class=
"nx">type</span><span class="p">}},</span> <span class="nx">file</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// depending on browser API, send file metadata, then send file</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class=
"nx">dataTransfer</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span> <span class=
"p">{</span>
            <span class="c1">// Use DataTransferItemList interface to access the file(s)</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class=
"nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class=
"nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">.</span><span class=
"nx">dataTransfer</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class=
"nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class=
"p">)</span> <span class="p">{</span>
                <span class="c1">// If dropped items aren't files, reject them</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class=
"p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">items</span><span class=
"p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">kind</span> <span class=
"o">===</span> <span class="s1">'file'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class=
"nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class=
"nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class=
"nx">getAsFile</span><span class="p">();</span>
                    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class=
"nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class=
"nx">file</span><span class="o">:</span><span class="p">{</span><span class="nx">name</span><span class=
"o">:</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class=
"p">,</span><span class="nx">type</span><span class="o">:</span><span class="nx">file</span><span class=
"p">.</span><span class="nx">type</span><span class="p">}});</span>
                    <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class=
"p">(</span><span class="nx">json</span><span class="p">);</span> <span class="c1">// first send metadata</span>
                    <span class="nx">sendfile</span><span class="p">(</span><span class="nx">file</span><span class=
"p">);</span>    <span class="c1">// second send actual file</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Use DataTransfer interface to access the file(s)</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class=
"nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class=
"nx">i</span> <span class="o">&lt;</span> <span class="nx">e</span><span class="p">.</span><span class=
"nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class=
"nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class=
"p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class=
"nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class=
"nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class=
"p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class=
"p">({</span><span class="nx">file</span><span class="o">:</span><span class="nx">file</span><span class=
"p">}));</span>
                <span class="nx">sendfile</span><span class="p">(</span><span class="nx">file</span><span class=
"p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getcookie</span><span class="p">(</span><span class=
"nx">cname</span><span class="p">){</span>
        <span class="c1">//https://www.30secondsofcode.org/js/s/parse-cookie</span>
        <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class=
"nb">document</span><span class="p">.</span><span class="nx">cookie</span>
            <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class=
"s1">';'</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class=
"nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class=
"nx">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">reduce</span>
            <span class="p">(</span> <span class="p">(</span><span class="nx">acc</span><span class=
"p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">acc</span><span class="p">[</span><span class=
"nb">decodeURIComponent</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class=
"mi">0</span><span class="p">].</span><span class="nx">trim</span><span class="p">())]</span> <span class=
"o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">v</span><span class=
"p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">());</span>
                <span class="k">return</span> <span class="nx">acc</span><span class="p">;</span>
                <span class="p">},</span> <span class="p">{}</span>
            <span class="p">);</span>
        <span class="k">return</span> <span class="nx">cookies</span><span class="p">[</span><span class=
"nx">cname</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">showMessage</span><span class="p">(</span><span class=
"nx">data</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">htmlEscape</span><span class="p">)</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">msg</span> <span class=
"o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'&lt;div/&gt;'</span><span class=
"p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">msg</span><span class="p">).</span><span class="nx">html</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="o">==</span><span class="s2">"System"</span><span class=
"p">)</span>
            <span class="nx">cd</span><span class="p">.</span><span class="nx">append</span><span class=
"p">(</span><span class="s1">'&lt;span class="s"&gt;'</span> <span class="o">+</span> <span class=
"nx">data</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span> <span class=
"s2">":&lt;/span&gt; "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class=
"nx">msg</span> <span class="o">+</span><span class="s1">'&lt;br&gt;'</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nx">cd</span><span class="p">.</span><span class="nx">append</span><span class=
"p">(</span><span class="s1">'&lt;span class="n"&gt;'</span> <span class="o">+</span> <span class=
"nx">data</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span> <span class=
"s2">":&lt;/span&gt; "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class=
"nx">msg</span> <span class="o">+</span><span class="s1">'&lt;br&gt;'</span><span class="p">);</span>
        <span class="nx">cd</span><span class="p">.</span><span class="nx">scrollTop</span><span class=
"p">(</span><span class="nx">cd</span><span class="p">.</span><span class="nx">height</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">ExpectedFileData</span><span class="o">=</span><span class=
"p">[];</span>

    <span class="kd">function</span> <span class="nx">procmess</span> <span class="p">(</span><span class=
"nx">msg</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">ExpectedFileData</span><span class=
"p">.</span><span class="nx">length</span> <span class="o">&amp;&</span> <span class="nx">msg</span><span class=
"p">.</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">Blob</span><span class=
"p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">fdata</span> <span class="o">=</span> <span class=
"nx">ExpectedFileData</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
            <span class="nx">displayfile</span><span class="p">(</span><span class="nx">fdata</span><span class=
"p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class=
"p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class=
"p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class=
"nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cd</span><span class="p">.</span><span class="nx">append</span><span class=
"p">(</span><span class=
"s1">'&lt;span style="color:red;"&gt;error parsing message&lt;/span&gt;&lt;br&gt;'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// if reconnected, skip welcome message.</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">reconnected</span><span class="p">){</span>
            <span class="nx">reconnected</span><span class="o">=</span><span class="kc">false</span><span class=
"p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">file</span><span class="p">)</span>
                <span class="nx">ExpectedFileData</span><span class="p">.</span><span class=
"nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nx">showMessage</span><span class="p">(</span><span class="nx">data</span><span class=
"p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">send</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">text</span><span class="o">=</span><span class=
"nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class="p">).</span><span class=
"nx">val</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">text</span><span class=
"o">==</span><span class="s2">""</span><span class="p">){</span>
            <span class="k">return</span> <span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">data</span><span class="o">=</span> <span class="p">{</span>
            <span class="nx">msg</span><span class="o">:</span> <span class="nx">text</span><span class="p">,</span>
            <span class="nx">from</span><span class="o">:</span> <span class="nx">name</span>
        <span class="p">};</span>

        <span class="k">try</span><span class="p">{</span>
            <span class="c1">// attempt reconnect if discoonnected</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">isOpen</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class=
"o">&amp;&</span> <span class="o">!</span><span class="nx">reconnected</span><span class="p">)</span> <span class=
"p">{</span>
                <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class=
"nx">WebSocket</span><span class="p">(</span><span class="nx">prot</span> <span class="o">+</span> <span class=
"nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class=
"nx">host</span> <span class="o">+</span> <span class="s2">"/wsapps/wschat.json"</span><span class="p">);</span>
                <span class="nx">socket</span><span class="p">.</span><span class=
"nx">addEventListener</span><span class="p">(</span><span class="s1">'open'</span><span class="p">,</span> <span class=
"kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
                    <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class=
"p">(</span><span class="nx">text</span><span class="p">);</span>
                    <span class="nx">reconnected</span><span class="o">=</span><span class="kc">true</span><span class=
"p">;</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">""</span><span class="p">);</span>
                    <span class="nx">showMessage</span><span class="p">(</span><span class="nx">data</span><span class=
"p">);</span>
                    <span class="nx">socket</span><span class="p">.</span><span class=
"nx">onmessage</span> <span class="o">=</span> <span class="nx">procmess</span><span class="p">;</span>
                <span class="p">});</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//send it</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class=
"p">(</span><span class="nx">text</span><span class="p">);</span>
            <span class="c1">//echo it</span>
            <span class="nx">showMessage</span><span class="p">(</span><span class="nx">data</span><span class=
"p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class=
"nx">e</span><span class="p">){</span>
            <span class="nx">showMessage</span><span class="p">({</span><span class="nx">from</span><span class=
"o">:</span><span class="s2">"System"</span><span class="p">,</span><span class="nx">msg</span><span class=
"o">:</span><span class="s1">'error sending message'</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">""</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">start</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class=
"p">();</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class=
"nx">WebSocket</span><span class="p">(</span><span class="nx">prot</span> <span class="o">+</span> <span class=
"nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class=
"nx">host</span> <span class="o">+</span> <span class="s2">"/wsapps/wschat.json"</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class=
"o">=</span> <span class="nx">procmess</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">setname</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">$</span><span class=
"p">(</span><span class="s1">'#name'</span><span class="p">).</span><span class="nx">val</span><span class=
"p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class=
"o">==</span><span class="s2">""</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class=
"o">=</span> <span class="s2">"username="</span><span class="o">+</span><span class="nx">name</span> <span class=
"o">+</span> <span class="s2">"; path=/; sameSite=Strict"</span><span class="p">;</span>
        <span class="nx">start</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//drag and drop events</span>
    <span class="nx">cd</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class=
"s2">"drop"</span><span class="p">,</span><span class="nx">handle_drop</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class=
"s2">"dragover"</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class=
"nx">e</span><span class="p">){</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class=
"p">();</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class=
"p">();</span>
        <span class="nx">cd</span><span class="p">.</span><span class="nx">addClass</span><span class=
"p">(</span><span class="s2">"dropping"</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class=
"s2">"dragleave"</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class=
"nx">e</span><span class="p">){</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class=
"p">();</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class=
"p">();</span>
        <span class="nx">cd</span><span class="p">.</span><span class="nx">removeClass</span><span class=
"p">(</span><span class="s2">"dropping"</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="c1">// send message to server when &lt;enter&gt; is pressed</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">keypress</span><span class="p">(</span><span class="kd">function</span><span class=
"p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class=
"p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="s1">'13'</span><span class=
"p">)</span> <span class="p">{</span>
            <span class="nx">send</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// sign on</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#name'</span><span class=
"p">).</span><span class="nx">keypress</span><span class="p">(</span><span class="kd">function</span><span class=
"p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class=
"p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="s1">'13'</span><span class=
"p">)</span> <span class="p">{</span>
            <span class="nx">setname</span><span class="p">();</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#namemsg'</span><span class=
"p">).</span><span class="nx">text</span><span class="p">(</span><span class=
"s2">"You are logged in as "</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">focus</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// check if we signed on previously</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">getcookie</span><span class=
"p">(</span><span class="s2">"username"</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class=
"p">{</span>
        <span class="nx">start</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#name'</span><span class=
"p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#namemsg'</span><span class=
"p">).</span><span class="nx">text</span><span class="p">(</span><span class=
"s2">"You are logged in as "</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">'#chatin'</span><span class=
"p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"wrapper"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"container"</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>wschat tutorial<span class=
"p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"namespan"</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"namemsg"</span><span class="p">&gt;</span>Type Your Name and pres <span class=
"ni">&amp;lt;</span>enter<span class="ni">&amp;gt;</span> to begin:<span class="p">&lt;/</span><span class=
"nt">span</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class=
"na">placeholder</span><span class="o">=</span><span class="s">"Type your name and press enter"</span> <span class=
"na">id</span><span class="o">=</span><span class="s">"name"</span> <span class="na">type</span><span class=
"o">=</span><span class="s">"text"</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"chatdiv"</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class=
"o">=</span><span class="s">"chatin"</span> <span class="na">type</span><span class="o">=</span><span class=
"s">"text"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="receiving-files-from-client-and-forward">
                      <h3>
                        Receiving Files from Client and Forward<a class="headerlink" href=
                        "#receiving-files-from-client-and-forward" title="Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        We will add to our <code class="docutils literal notranslate"><span class=
                        "pre">forward_messages()</span></code> function in order to receive files from the websocket
                        client. When a file is dropped in the message area of the web page, the client-side script will
                        first send some JSON metadata in a text message, then send the actual binary file.
                      </p>
                      <p>
                        We will receive the metadata and file in two separate messages (with two separate calls to
                        <code class="docutils literal notranslate"><span class="pre">forward_messages()</span></code>).
                        This means we will have to store the metadata somewhere, and have it accessible when we receive
                        the file. We will then be able to assemble a single <span class="green">Object</span> to pass
                        to <code class="docutils literal notranslate"><span class=
                        "pre">rampart.event.trigger()</span></code>. Since the <code class=
                        "docutils literal notranslate"><span class="pre">req</span></code> <span class=
                        "green">Object</span> is recycled upon every message, we will set <code class=
                        "docutils literal notranslate"><span class="pre">req.files</span></code> to a <span class=
                        "green">Array</span> of <span class="green">Objects</span> (one <span class=
                        "green">Object</span> per file) for this purpose.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">function</span> <span class=
                          "nx">forward_messages</span><span class="p">(</span><span class="nx">req</span><span class=
                          "p">)</span> <span class="p">{</span>
    <span class="cm">/* we are sent a file from the client in two parts: 1) JSON meta info, 2) binary data */</span>
    <span class="kd">var</span> <span class="nx">fileInfo</span><span class="p">;</span>  <span class=
"c1">//variable for JSON meta info</span>
    <span class="kd">var</span> <span class="nx">file</span><span class="p">;</span>  <span class=
"c1">// will hold object with meta data and binary file content</span>

    <span class="cm">/* STEP 1:  Check message type:  Either -</span>
<span class="cm">                   1) metadata for an incoming file</span>
<span class="cm">                   2) binary data for an incoming file</span>
<span class="cm">                   3) text message</span>
<span class="cm">    */</span>

    <span class="c1">// check non binary messages for JSON</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">wsIsBin</span> <span class="o">&amp;&</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* messages are just plain text, but</span>
<span class="cm">           if it is a file, first we get the file meta info in JSON format */</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nx">fileInfo</span><span class="o">=</span><span class="nx">JSON</span><span class=
"p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class=
"nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* it is not binary, or json, so it must be a message */</span>
            <span class="nx">fileInfo</span> <span class="o">=</span> <span class="kc">false</span><span class=
"p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* if it is binary data, we assume it is a file</span>
<span class="cm">       and the file info was already sent            */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">wsIsBin</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span> <span class="o">&amp;&</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//get the first entry of file meta info</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">shift</span><span class=
"p">();</span>
            <span class="c1">// add the body buffer to it</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class=
"o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
            <span class="c1">// tell everyone who it's from</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">from</span><span class=
"o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="c1">// handle unlikely case that metadata is not available.</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span><span class=
"s2">""</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class=
"s2">"application/octet-stream"</span><span class="p">,</span> <span class="nx">content</span><span class=
"o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">fileInfo</span><span class="p">)</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class=
"o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">"%s"</span><span class=
"p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class=
"p">);</span><span class="c1">//It's not binary, convert body buffer to a string</span>


    <span class="cm">/* STEP 2:  Process info from step 1 -</span>
<span class=
"cm">                   1) if it is file metadata, save it in the "req.files" var and wait for next message</span>
<span class=
"cm">                   2) if we have both metadata and file content, trigger event and send to all other users</span>
<span class=
"cm">                   3) if we have a text message, trigger event to send message to all other users</span>
<span class="cm">    */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">fileInfo</span> <span class=
"o">&amp;&</span> <span class="nx">fileInfo</span><span class="p">.</span><span class="nx">file</span><span class=
"p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">)</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">files</span> <span class=
"o">=</span> <span class="p">[];</span>
        <span class="cm">/* store file meta info in req where we will retrieve it next time */</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class=
"p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fileInfo</span><span class=
"p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="c1">// do nothing and get the actual binary file in the next message</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class=
"nx">file</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* we received a file, reassembled its meta info.  Send it to all that are listening */</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">file</span><span class="o">:</span> <span class="nx">file</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class=
"nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//send the plain text message to whoever is listening</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">msg</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">body</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/* Step 3:</span>
<span class="cm">         We received data, but here no data is sent back to the client.  However,</span>
<span class="cm">         it is sent to others using trigger and receive by the rampart.event.on</span>
<span class="cm">         function which they registered in their own connections.  So we can just return</span>
<span class="cm">         here</span>
<span class="cm">    */</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="receiving-files-from-other-clients">
                      <h3>
                        Receiving Files from other Clients<a class="headerlink" href=
                        "#receiving-files-from-other-clients" title="Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        Now we alter the <code class="docutils literal notranslate"><span class=
                        "pre">receive_message()</span></code> function in order to send a file back to the client.
                        Again, it is sent in two parts – metadata then the binary file.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class=
                          "cm">/* process incoming message as sent below in ev.trigger() with data set to</span>
<span class="cm">   { from: user_name, id: user_id, [ msg: "a message" | file: binary_file_data] }</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">receive_message</span><span class="p">(</span><span class=
"nx">req</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">id</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">)</span> <span class="p">{</span><span class=
"c1">//don't echo our own message</span>
        <span class="c1">// is this a file?  Sent two messages.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">file</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//send file metadata, then ...</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
                <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
                <span class="nx">file</span><span class="o">:</span> <span class="p">{</span><span class=
"nx">name</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class=
"nx">type</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">}</span>
            <span class="p">});</span>
            <span class="c1">// ... send actual binary file</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">file</span><span class=
"p">.</span><span class="nx">content</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="c1">// it is a text message</span>
        <span class="p">{</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
                <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
                <span class="nx">msg</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">msg</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="full-script-handling-files">
                      <h3>
                        Full Script Handling Files<a class="headerlink" href="#full-script-handling-files" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="nx">rampart</span><span class="p">.</span><span class=
                          "nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class=
                          "p">.</span><span class="nx">utils</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ev</span> <span class="o">=</span> <span class=
"nx">rampart</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>


<span class="kd">function</span> <span class="nx">getuser</span><span class="p">(</span><span class=
"nx">req</span><span class="p">){</span>
    <span class="c1">// no real user management here</span>
    <span class="c1">// just use the cookie set in client-side script</span>
    <span class="c1">// however here is where you could add an authentication scheme</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">cookies</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NOTES:</span>
<span class="cm"> * The module.exports function is run for every incoming websocket message.</span>
<span class="cm"> * The first run (req.count==0) will have an empty body and represents the initial connection.</span>
<span class="cm"> * The req object is reused with req.body updated for each incoming message.</span>
<span class="cm"> * Sending data back is done with req.wsSend().</span>
<span class="cm"> * Any data printed or put using req.printf/req.put will also be sent when</span>
<span class="cm"> *   req.wsSend() is called or when the module.exports function returns</span>
<span class="cm"> * req.count == number of times function has been called since connection was made.</span>
<span class=
"cm"> * req.wsOnDisconnect is a function that is run when you disconnect or you are disconnected by the client.</span>
<span class="cm"> * req.wsEnd forces a disconnect (but runs callback first);</span>
<span class="cm"> * req.websocketId is a unique number to identify the current connection to a single client.</span>
<span class="cm"> * req.wsIsBin is true if the client sends binary data.  Data will be in req.body</span>
<span class="cm"> * req.body is always a buffer.  If req.wsIsBin is false, it can be converted to a string.</span>
<span class="cm"> *   using rampart.utils.sprintf('%s',req.body) or rampart.utils.bufferToString(req.body)</span>
<span class="cm"> */</span>

<span class="cm">/* process incoming message as sent below in ev.trigger() with data set to</span>
<span class="cm">   { from: user_name, id: user_id, [ msg: "a message" | file: binary_file_data] }</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">receive_message</span><span class="p">(</span><span class=
"nx">req</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">id</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">)</span> <span class="p">{</span><span class=
"c1">//don't echo our own message</span>
        <span class="c1">// is this a file?  Sent two messages.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">file</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//send file metadata, then ...</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
                <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
                <span class="nx">file</span><span class="o">:</span> <span class="p">{</span><span class=
"nx">name</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class=
"nx">type</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">}</span>
            <span class="p">});</span>
            <span class="c1">// ... send actual binary file</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">file</span><span class=
"p">.</span><span class="nx">content</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="c1">// it is a text message</span>
        <span class="p">{</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
                <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
                <span class="nx">msg</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">msg</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">setup_event_listen</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* check for username */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">=</span><span class="nx">getuser</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">user_name</span><span class="p">){</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span> <span class="s2">"System"</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"No user name provided, disconnecting"</span><span class="p">});</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* what to do if we are sent a message from another user.  Here rampart.event.on</span>
<span class="cm">       registers a function to be executed.  The function takes a parameter from "on"</span>
<span class="cm">       and a parameter from "trigger". The function is registered with the event name</span>
<span class="cm">       "msgev" and the function name "userfunc_x" where x is the unique websocketId for</span>
<span class="cm">       this connection. The varable "req" is passed to the proc_incoming_message as its</span>
<span class="cm">       first argument.                                                                   */</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class=
"s2">"msgev"</span><span class="p">,</span> <span class="s2">"userfunc_"</span><span class="o">+</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">receive_message</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>

    <span class=
"c1">// set up function for when this user disconnects (either by browser disconnect or req.wsEnd() )</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsOnDisconnect</span><span class=
"p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// msg -&gt; everyone listening</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="o">+</span><span class=
"s2">" has left the conversation"</span><span class="p">});</span>
        <span class="c1">// remove our function unique to this use from the event</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">off</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="s2">"userfunc_"</span><span class=
"o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class=
"p">);</span>
    <span class="p">});</span>

    <span class="cm">/* send a notification to all listening that we've joined the conversation */</span>
    <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="o">+</span><span class=
"s2">" has joined the conversation"</span><span class="p">});</span>

    <span class="c1">// send a welcome message to client from the "System".</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class=
"s2">"System"</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"sb">`Welcome </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span> <span class=
"p">);</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">forward_messages</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* we are sent a file from the client in two parts: 1) JSON meta info, 2) binary data */</span>
    <span class="kd">var</span> <span class="nx">fileInfo</span><span class="p">;</span>  <span class=
"c1">//variable for JSON meta info</span>
    <span class="kd">var</span> <span class="nx">file</span><span class="p">;</span>  <span class=
"c1">// will hold object with meta data and binary file content</span>

    <span class="cm">/* STEP 1:  Check message type:  Either -</span>
<span class="cm">                   1) metadata for an incoming file</span>
<span class="cm">                   2) binary data for an incoming file</span>
<span class="cm">                   3) text message</span>
<span class="cm">    */</span>

    <span class="c1">// check non binary messages for JSON</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">wsIsBin</span> <span class="o">&amp;&</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* messages are just plain text, but</span>
<span class="cm">           if it is a file, first we get the file meta info in JSON format */</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nx">fileInfo</span><span class="o">=</span><span class="nx">JSON</span><span class=
"p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class=
"nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* it is not binary, or json, so it must be a message */</span>
            <span class="nx">fileInfo</span> <span class="o">=</span> <span class="kc">false</span><span class=
"p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* if it is binary data, we assume it is a file</span>
<span class="cm">       and the file info was already sent            */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">wsIsBin</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span> <span class="o">&amp;&</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//get the first entry of file meta info</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">shift</span><span class=
"p">();</span>
            <span class="c1">// add the body buffer to it</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class=
"o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
            <span class="c1">// tell everyone who it's from</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">from</span><span class=
"o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="c1">// handle unlikely case that metadata is not available.</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span><span class=
"s2">""</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class=
"s2">"application/octet-stream"</span><span class="p">,</span> <span class="nx">content</span><span class=
"o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">fileInfo</span><span class="p">)</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class=
"o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">"%s"</span><span class=
"p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class=
"p">);</span><span class="c1">//It's not binary, convert body buffer to a string</span>


    <span class="cm">/* STEP 2:  Process info from step 1 -</span>
<span class=
"cm">                   1) if it is file metadata, save it in the "req.files" var and wait for next message</span>
<span class=
"cm">                   2) if we have both metadata and file content, trigger event and send to all other users</span>
<span class=
"cm">                   3) if we have a text message, trigger event to send message to all other users</span>
<span class="cm">    */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">fileInfo</span> <span class=
"o">&amp;&</span> <span class="nx">fileInfo</span><span class="p">.</span><span class="nx">file</span><span class=
"p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">)</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">files</span> <span class=
"o">=</span> <span class="p">[];</span>
        <span class="cm">/* store file meta info in req where we will retrieve it next time */</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class=
"p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fileInfo</span><span class=
"p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="c1">// do nothing and get the actual binary file in the next message</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class=
"nx">file</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* we received a file, reassembled its meta info.  Send it to all that are listening */</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">file</span><span class="o">:</span> <span class="nx">file</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class=
"nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//send the plain text message to whoever is listening</span>
        <span class="nx">ev</span><span class="p">.</span><span class="nx">trigger</span><span class=
"p">(</span><span class="s2">"msgev"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">msg</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">body</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/* Step 3:</span>
<span class="cm">         We received data, but here no data is sent back to the client.  However,</span>
<span class="cm">         it is sent to others using trigger and receive by the rampart.event.on</span>
<span class="cm">         function which they registered in their own connections.  So we can just return</span>
<span class="cm">         here</span>
<span class="cm">    */</span>
<span class="p">}</span>

<span class="c1">// exporting a single function</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class=
"o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class=
"p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* first run upon connect, req.body is empty</span>
<span class="cm">           Here is where we will set up the event to listen for</span>
<span class="cm">           incoming message from other users</span>
<span class="cm">         */</span>
        <span class="nx">setup_event_listen</span><span class="p">(</span><span class="nx">req</span><span class=
"p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* second and subsequent runs below.  Client has sent a message</span>
<span class="cm">           and we need to process and forward it to others who are</span>
<span class="cm">           listening via rampart.event.on above</span>
<span class="cm">         */</span>
        <span class="nx">forward_messages</span><span class="p">(</span><span class="nx">req</span><span class=
"p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="section" id="chat-with-history-using-redis">
                    <h2>
                      Chat with History using Redis<a class="headerlink" href="#chat-with-history-using-redis" title=
                      "Permalink to this headline">¶</a>
                    </h2>
                    <p>
                      There are many enhancements you might want to make when using the above examples as a template
                      for a robust chat. However it will be difficult to allow users to refresh the page or log back
                      and see old messages unless there is some databasing. Below we will use Redis to both save
                      messages and replace <code class="docutils literal notranslate"><span class=
                      "pre">rampart.event</span></code>.
                    </p>
                    <p>
                      We will set up our new version by copying the files <code class=
                      "docutils literal notranslate"><span class=
                      "pre">webserver/html/websockets-chat/index.html</span></code> and <code class=
                      "docutils literal notranslate"><span class="pre">webserver/wsapps/wschat.js</span></code> to
                      <code class="docutils literal notranslate"><span class=
                      "pre">webserver/html/websockets-chat/index-redis-chat.html</span></code> and <code class=
                      "docutils literal notranslate"><span class="pre">webserver/wsapps/wschat-redis.js</span></code>
                      respectively.
                    </p>
                    <div class="section" id="client-side-changes">
                      <h3>
                        Client-Side changes<a class="headerlink" href="#client-side-changes" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        The client-side script (now at <code class="docutils literal notranslate"><span class=
                        "pre">webserver/html/websockets-chat/index-redis-chat.html</span></code>) only needs a minimal
                        update. Simply replace the two references to <code class=
                        "docutils literal notranslate"><span class="pre">/wsapps/wschat.json</span></code> to
                        <code class="docutils literal notranslate"><span class=
                        "pre">/wsapps/wschat-redis.json</span></code>.
                      </p>
                    </div>
                    <div class="section" id="starting-redis">
                      <h3>
                        Starting Redis<a class="headerlink" href="#starting-redis" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        We will start by editing the copied <code class="docutils literal notranslate"><span class=
                        "pre">`webserver/wsapps/wschat-redis.js</span></code> script.
                      </p>
                      <p>
                        Here, we will have Redis running on the same machine and started by the <code class=
                        "docutils literal notranslate"><span class="pre">wschat-redis.js</span></code> script as
                        necessary. It is worth noting that Redis could be running on a different machine with our
                        script potentially running on several machines, since Redis does all of its communication over
                        a socket.
                      </p>
                      <p>
                        The startup function checks for an existing handle to Redis attached to the <code class=
                        "docutils literal notranslate"><span class="pre">req</span></code> handle. If it doesn’t exist,
                        it makes the connection to Redis and saves the handle as a property of <code class=
                        "docutils literal notranslate"><span class="pre">req</span></code>. If that fails (i.e. Redis
                        is not running), <code class="docutils literal notranslate"><span class=
                        "pre">redis-server</span></code> is located and started with a simple configuration that is
                        passed to it via <code class="docutils literal notranslate"><span class=
                        "pre">stdin</span></code>. At any point, if there is an error, that error will be returned. If
                        all is successful, it returns undefined.
                      </p>
                      <p>
                        So we add the following to our script:
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">var</span> <span class="nx">redis</span><span class=
                          "o">=</span><span class="nx">require</span><span class="p">(</span><span class=
                          "s2">"rampart-redis"</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">rcl</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">redisDir</span><span class="o">=</span><span class=
"nx">serverConf</span><span class="p">.</span><span class="nx">dataRoot</span> <span class="o">+</span> <span class=
"s1">'/redis_chat'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">redisConf</span> <span class="o">=</span> <span class=
"s2">"bind 127.0.0.1 -::1\n"</span>                      <span class="o">+</span>
                    <span class="s2">"port 23741\n"</span>                               <span class="o">+</span>
                    <span class="s2">"pidfile "</span> <span class="o">+</span> <span class=
"nx">redisDir</span> <span class="o">+</span> <span class="s2">"/redis_23741.pid\n"</span> <span class="o">+</span>
                    <span class="s2">"dir "</span> <span class="o">+</span> <span class=
"nx">redisDir</span> <span class="o">+</span> <span class="s2">"\n"</span><span class="p">;</span>

    <span class="cm">/* make the directory for redis */</span>
    <span class="kd">var</span> <span class="nx">dirstat</span> <span class="o">=</span> <span class=
"nx">stat</span><span class="p">(</span><span class="nx">redisDir</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">dirstat</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class=
"p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">redisDir</span><span class=
"p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class=
"nx">e</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/***** Test if Redis is already running *****/</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"o">=</span><span class="k">new</span> <span class="nx">redis</span><span class="p">.</span><span class=
"nx">init</span><span class="p">(</span><span class="mi">23741</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class=
"p">){}</span>

    <span class="cm">/***** LAUNCH REDIS *********/</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class=
"nx">shell</span><span class="p">(</span><span class="s2">"which redis-server"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class=
"nx">exitStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class=
"p">{</span>
        <span class="k">return</span> <span class="s2">"Could not find redis-server in PATH"</span><span class=
"p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">rdexec</span> <span class="o">=</span> <span class=
"nx">trim</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class=
"nx">stdout</span><span class="p">);</span>

    <span class="nx">ret</span> <span class="o">=</span> <span class="nx">exec</span><span class=
"p">(</span><span class="s2">"nohup"</span><span class="p">,</span> <span class="nx">rdexec</span><span class=
"p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">background</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class=
"nx">stdin</span><span class="o">:</span><span class="nx">redisConf</span><span class="p">});</span>
    <span class="kd">var</span> <span class="nx">rpid</span> <span class="o">=</span> <span class=
"nx">ret</span><span class="p">.</span><span class="nx">pid</span><span class="p">;</span>

    <span class="nx">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">kill</span><span class=
"p">(</span><span class="nx">rpid</span><span class="p">,</span> <span class="mi">0</span><span class=
"p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"Failed to start redis-server"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"o">=</span><span class="k">new</span> <span class="nx">redis</span><span class="p">.</span><span class=
"nx">init</span><span class="p">(</span><span class="mi">23741</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class=
"p">){</span>
        <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="replacing-event-functions">
                      <h3>
                        Replacing Event Functions<a class="headerlink" href="#replacing-event-functions" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        Redis has pub/sub commands. However they do not save the data for later use. It also has
                        <a class="reference external" href=
                        "https://www.redis.io/docs/manual/data-types/streams/">streams</a> that save the data and can
                        be listened to using the <code class="docutils literal notranslate"><span class=
                        "pre">x</span></code> commands (<code class="docutils literal notranslate"><span class=
                        "pre">xadd</span></code>, <code class="docutils literal notranslate"><span class=
                        "pre">xread</span></code>, etc.). Rampart’s redis client additionally includes the <a class=
                        "reference internal" href="rampart-redis.html#xread-auto-async"><span class=
                        "std std-ref">xread_auto_async</span></a> command, which monitors one or more Redis Streams
                        without having to reissue the <code class="docutils literal notranslate"><span class=
                        "pre">xread</span></code> command or track the last id seen. This makes it work more like
                        pub/sub with the ability to save recent messages.
                      </p>
                      <p>
                        We will use <a class="reference internal" href=
                        "rampart-redis.html#xread-auto-async"><span class="std std-ref">xread_auto_async</span></a> and
                        <a class="reference internal" href="rampart-redis.html#supported-commands"><span class=
                        "std std-ref">xadd</span></a> to replace <code class=
                        "docutils literal notranslate"><span class="pre">rampart.event.on</span></code> and
                        <code class="docutils literal notranslate"><span class=
                        "pre">rampart.event.trigger</span></code> respectively.
                      </p>
                      <p>
                        First, unlike <code class="docutils literal notranslate"><span class=
                        "pre">rampart.event</span></code>, data encapsulated in <span class="green">Objects</span>
                        needs to be converted to and from JSON when sending it to the Redis server. Conversion to JSON
                        is handled automatically.
                      </p>
                      <p>
                        However there are two caveats:
                      </p>
                      <blockquote>
                        <div>
                          <ul class="simple">
                            <li>
                              <p>
                                Since Redis can store data of many types, we will need to manually parse the received
                                JSON data from Redis.
                              </p>
                            </li>
                            <li>
                              <p>
                                JSON is not the ideal format for binary buffer data, so we will encode the file to a
                                base64 string. Note that an alternative would be to use <a class="reference external"
                                href="https://duktape.org/guide.html#builtin-cbor">CBOR</a> encoding.
                              </p>
                            </li>
                          </ul>
                        </div>
                      </blockquote>
                      <p>
                        We’ll create a function to do just that when sending data back to the client with <code class=
                        "docutils literal notranslate"><span class="pre">req.wsSend()</span></code>:
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">function</span> <span class=
                          "nx">sendWsMsg</span><span class="p">(</span><span class="nx">req</span><span class=
                          "p">,</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// sending a file</span>
        <span class="c1">// JSON from redis must be decoded.</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">file</span> <span class=
"o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class=
"p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class=
"nx">e</span><span class="p">){}</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">data</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class=
"nx">content</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//send file metadata, then ...</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
            <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
            <span class="nx">file</span><span class="o">:</span> <span class="p">{</span><span class=
"nx">name</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class=
"nx">type</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">}</span>
        <span class="p">});</span>
        <span class="c1">// ... send actual binary file</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span><span class="nx">bprintf</span><span class="p">(</span><span class="s1">'%!B'</span><span class=
"p">,</span><span class="nx">data</span><span class="p">.</span><span class="nx">file</span><span class=
"p">.</span><span class="nx">content</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="c1">// it is a text message</span>
    <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
            <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
            <span class="nx">msg</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">msg</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                      <p>
                        With <code class="docutils literal notranslate"><span class=
                        "pre">rampart.event.on</span></code> we could pass the <code class=
                        "docutils literal notranslate"><span class="pre">req</span></code> variable to be used in the
                        registered callback function. Using Redis, we don’t have that option, so instead we will embed
                        the <code class="docutils literal notranslate"><span class=
                        "pre">receive_message()</span></code> function inside the <code class=
                        "docutils literal notranslate"><span class="pre">setup_event_listen</span></code> function.
                        That way <code class="docutils literal notranslate"><span class="pre">req</span></code> will be
                        in scope and available.
                      </p>
                      <p>
                        Also, since we now have the <code class="docutils literal notranslate"><span class=
                        "pre">sendWsMsg()</span></code> function, we can use it in place of the <code class=
                        "docutils literal notranslate"><span class="pre">req.wsSend()</span></code> logic we were
                        previously using.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">function</span> <span class=
                          "nx">receive_message</span><span class="p">(</span><span class="nx">strdata</span><span class=
                          "p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">strdata</span><span class="p">){</span> <span class="c1">// undefined on disconnect</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"you are now disconnected."</span><span class="p">})</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class=
"nx">strdata</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class=
"mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">id</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">)</span>
        <span class="nx">sendWsMsg</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span><span class="nx">data</span><span class="p">);</span>
 <span class="p">}</span>
</pre>
                        </div>
                      </div>
                      <p>
                        Now we need to replace <code class="docutils literal notranslate"><span class=
                        "pre">rampart.event.trigger</span></code> with <code class=
                        "docutils literal notranslate"><span class="pre">xadd</span></code>. We’ll make a function for
                        that as well. We will assume that we want to limit the number of messages we save to around
                        2000. See the <a class="reference external" href=
                        "https://www.redis.io/commands/xadd/#capped-streams">xadd capped strings discussion</a> for
                        more information on limiting the number of messages in a stream.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">function</span> <span class=
                          "nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
                          "p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"p">.</span><span class="nx">xadd</span><span class="p">(</span><span class="nx">stream</span><span class=
"p">,</span> <span class="s2">"MAXLEN"</span><span class="p">,</span> <span class="s1">'~'</span><span class=
"p">,</span> <span class="s1">'2000'</span><span class="p">,</span> <span class="s2">"*"</span><span class=
"p">,</span> <span class="nx">obj</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class=
"p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
            <span class="nx">from</span><span class="o">:</span> <span class="s2">"System"</span><span class=
"p">,</span>
            <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span>
            <span class="nx">msg</span><span class="o">:</span> <span class="nx">sprintf</span><span class=
"p">(</span><span class="s2">"Error sending msg: %s"</span><span class="p">,</span> <span class=
"nx">e</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                      <p>
                        Note that if the Redis server cannot be reached, or some other error happens, the <code class=
                        "docutils literal notranslate"><span class="pre">req.rcl.xadd</span></code> command will throw
                        an error. Here we merely send that error back to the client.
                      </p>
                    </div>
                    <div class="section" id="listening-for-messages">
                      <h3>
                        Listening for Messages<a class="headerlink" href="#listening-for-messages" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        At this point, we are ready to make changed to the <code class=
                        "docutils literal notranslate"><span class="pre">setup_event_listen</span></code> function,
                        using the changes above.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">var</span> <span class="nx">stream</span> <span class=
                          "o">=</span> <span class="s2">"mystream"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">setup_event_listen</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* check for username */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">=</span><span class="nx">getuser</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">user_name</span><span class="p">){</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span> <span class="s2">"System"</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"No user name provided, disconnecting"</span><span class="p">});</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class=
"p">(){</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
        <span class="p">},</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">receive_message</span><span class="p">(</span><span class=
"nx">strdata</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">strdata</span><span class="p">){</span> <span class="c1">// undefined on disconnect</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"you are now disconnected."</span><span class="p">})</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class=
"nx">strdata</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class=
"mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">id</span> <span class="o">!=</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">)</span>
            <span class="nx">sendWsMsg</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span><span class="nx">data</span><span class="p">);</span>
     <span class="p">}</span>

    <span class="cm">/* what to do if we are sent a message from another user. */</span>
    <span class="kd">var</span> <span class="nx">subscriptions</span> <span class="o">=</span> <span class=
"p">{};</span>
    <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">stream</span><span class=
"p">]</span><span class="o">=</span><span class="s1">'$'</span><span class="p">;</span> <span class=
"c1">//only listening for one stream</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class="p">.</span><span class=
"nx">xread_auto_async</span><span class="p">(</span><span class="nx">subscriptions</span><span class=
"p">,</span> <span class="nx">receive_message</span><span class="p">);</span>

    <span class=
"c1">// set up function for when this user disconnects (either by browser disconnect or req.wsEnd() )</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsOnDisconnect</span><span class=
"p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,{</span><span class="nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">+</span><span class="s2">" has left the conversation"</span><span class="p">});</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="cm">/* send a notification to all listening that we've joined the conversation */</span>
    <span class="c1">// msg -&gt; everyone listening</span>
    <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span><span class=
"s1">'System'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">msg</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="o">+</span><span class="s2">" has joined the conversation"</span><span class=
"p">});</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class=
"s2">"System"</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"sb">`Welcome </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span> <span class=
"p">);</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                      <p>
                        However, when the client first connects, we also want to send a few of the old messages, so the
                        client can see what they missed. We will use another Redis Stream command <code class=
                        "docutils literal notranslate"><span class="pre">xrevrange</span></code> and wrap it in a
                        <code class="docutils literal notranslate"><span class="pre">try{}</span> <span class=
                        "pre">catch(e){}</span></code> block as well.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">function</span> <span class=
                          "nx">setup_event_listen</span><span class="p">(</span><span class="nx">req</span><span class=
                          "p">)</span> <span class="p">{</span>
    <span class="cm">/* check for username */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">=</span><span class="nx">getuser</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">user_name</span><span class="p">){</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span> <span class="s2">"System"</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"No user name provided, disconnecting"</span><span class="p">});</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class=
"p">(){</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
        <span class="p">},</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">receive_message</span><span class="p">(</span><span class=
"nx">strdata</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">strdata</span><span class="p">){</span> <span class="c1">// undefined on disconnect</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"you are now disconnected."</span><span class="p">})</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class=
"nx">strdata</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class=
"mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">id</span> <span class="o">!=</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">)</span>
            <span class="nx">sendWsMsg</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span><span class="nx">data</span><span class="p">);</span>
     <span class="p">}</span>

    <span class="cm">/* what to do if we are sent a message from another user. */</span>
    <span class="kd">var</span> <span class="nx">subscriptions</span> <span class="o">=</span> <span class=
"p">{};</span>
    <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">stream</span><span class=
"p">]</span><span class="o">=</span><span class="s1">'$'</span><span class="p">;</span> <span class=
"c1">//only listening for one stream</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class="p">.</span><span class=
"nx">xread_auto_async</span><span class="p">(</span><span class="nx">subscriptions</span><span class=
"p">,</span> <span class="nx">receive_message</span><span class="p">);</span>

    <span class=
"c1">// set up function for when this user disconnects (either by browser disconnect or req.wsEnd() )</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsOnDisconnect</span><span class=
"p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,{</span><span class="nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">+</span><span class="s2">" has left the conversation"</span><span class="p">});</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="cm">/* send a notification to all listening that we've joined the conversation */</span>
    <span class="c1">// msg -&gt; everyone listening</span>
    <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span><span class=
"s1">'System'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">msg</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="o">+</span><span class="s2">" has joined the conversation"</span><span class=
"p">});</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">//send the last &lt;=50 messages</span>
        <span class="kd">var</span> <span class="nx">msgRange</span> <span class="o">=</span> <span class=
"nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class="p">.</span><span class=
"nx">xrevrange</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class=
"s1">'+'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class=
"s2">"COUNT"</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class=
"nx">i</span><span class="o">=</span><span class="nx">msgRange</span><span class="p">.</span><span class=
"nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class=
"nx">i</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">;</span> <span class=
"nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class=
"nx">msgRange</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class=
"p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">from</span><span class=
"o">!=</span><span class="s1">'System'</span><span class="p">)</span>
                <span class="nx">sendWsMsg</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// send a welcome message to client from the "System".</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class=
"s2">"System"</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"sb">`Welcome </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span> <span class=
"p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class=
"p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class=
"s2">"System"</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">sprintf</span><span class="p">(</span><span class="s2">"Error getting messages: %s"</span><span class=
"p">,</span><span class="nx">e</span><span class="p">)</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="forwarding-messages">
                      <h3>
                        Forwarding Messages<a class="headerlink" href="#forwarding-messages" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <p>
                        Using our <code class="docutils literal notranslate"><span class="pre">rtrigger()</span></code>
                        function above, we can also alter our <code class="docutils literal notranslate"><span class=
                        "pre">forward_messages()</span></code> function. There are two changes from the <code class=
                        "docutils literal notranslate"><span class="pre">rampart.event</span></code> version : 1)
                        <code class="docutils literal notranslate"><span class="pre">ev.trigger</span></code> is
                        replaced with <code class="docutils literal notranslate"><span class=
                        "pre">rtrigger</span></code> and when sending a file, we base64 encode it using <code class=
                        "docutils literal notranslate"><span class="pre">sprintf("%B")</span></code>.
                      </p>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="kd">function</span> <span class=
                          "nx">forward_messages</span><span class="p">(</span><span class="nx">req</span><span class=
                          "p">)</span> <span class="p">{</span>
    <span class="cm">/* we are sent a file from the client in two parts: 1) JSON meta info, 2) binary data */</span>
    <span class="kd">var</span> <span class="nx">fileInfo</span><span class="p">;</span>  <span class=
"c1">//variable for JSON meta info</span>
    <span class="kd">var</span> <span class="nx">file</span><span class="p">;</span>  <span class=
"c1">// will hold object with meta data and binary file content</span>

    <span class="cm">/* STEP 1:  Check message type:  Either -</span>
<span class="cm">                   1) metadata for an incoming file</span>
<span class="cm">                   2) binary data for an incoming file</span>
<span class="cm">                   3) text message</span>
<span class="cm">    */</span>

    <span class="c1">// check non binary messages for JSON</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">wsIsBin</span> <span class="o">&amp;&</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* messages are just plain text, but</span>
<span class="cm">           if it is a file, first we get the file meta info in JSON format */</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nx">fileInfo</span><span class="o">=</span><span class="nx">JSON</span><span class=
"p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class=
"nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* it is not binary, or json, so it must be a message */</span>
            <span class="nx">fileInfo</span> <span class="o">=</span> <span class="kc">false</span><span class=
"p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* if it is binary data, we assume it is a file</span>
<span class="cm">       and the file info was already sent            */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">wsIsBin</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span> <span class="o">&amp;&</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//get the first entry of file meta info</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">shift</span><span class=
"p">();</span>
            <span class="c1">// add the body buffer to it</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class=
"o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">"%B"</span><span class=
"p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
            <span class="c1">// tell everyone who it's from</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">from</span><span class=
"o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="c1">// handle unlikely case that metadata is not available.</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span><span class=
"s2">""</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class=
"s2">"application/octet-stream"</span><span class="p">,</span> <span class="nx">content</span><span class=
"o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">fileInfo</span><span class="p">)</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class=
"o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">"%s"</span><span class=
"p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class=
"p">);</span><span class="c1">//It's not binary, convert body buffer to a string</span>


    <span class="cm">/* STEP 2:  Process info from step 1 -</span>
<span class=
"cm">                   1) if it is file metadata, save it in the "req.files" var and wait for next message</span>
<span class=
"cm">                   2) if we have both metadata and file content, trigger event and send to all other users</span>
<span class=
"cm">                   3) if we have a text message, trigger event to send message to all other users</span>
<span class="cm">    */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">fileInfo</span> <span class=
"o">&amp;&</span> <span class="nx">fileInfo</span><span class="p">.</span><span class="nx">file</span><span class=
"p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">)</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">files</span> <span class=
"o">=</span> <span class="p">[];</span>
        <span class="cm">/* store file meta info in req where we will retrieve it next time */</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class=
"p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fileInfo</span><span class=
"p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="c1">// do nothing and get the actual binary file in the next message</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class=
"nx">file</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* we received a file, reassembled its meta info.  Send it to all that are listening */</span>
        <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">file</span><span class="o">:</span> <span class=
"nx">file</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class=
"nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//send the plain text message to whoever is listening</span>
        <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/* Step 3:</span>
<span class="cm">         We received data, but here no data is sent back to the client.  However,</span>
<span class="cm">         it is sent to others using trigger and receive by the rampart.event.on</span>
<span class="cm">         function which they registered in their own connections.  So we can just return</span>
<span class="cm">         here</span>
<span class="cm">    */</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="full-script-with-redis">
                      <h3>
                        Full Script with Redis<a class="headerlink" href="#full-script-with-redis" title=
                        "Permalink to this headline">¶</a>
                      </h3>
                      <div class="highlight-javascript notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="nx">rampart</span><span class="p">.</span><span class=
                          "nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class=
                          "p">.</span><span class="nx">utils</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">redis</span><span class="o">=</span><span class=
"nx">require</span><span class="p">(</span><span class="s2">"rampart-redis"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class=
"s2">"mystream"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">rcl</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">redisDir</span><span class="o">=</span><span class=
"nx">serverConf</span><span class="p">.</span><span class="nx">dataRoot</span> <span class="o">+</span> <span class=
"s1">'/redis_chat'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">redisConf</span> <span class="o">=</span> <span class=
"s2">"bind 127.0.0.1 -::1\n"</span>                      <span class="o">+</span>
                    <span class="s2">"port 23741\n"</span>                               <span class="o">+</span>
                    <span class="s2">"pidfile "</span> <span class="o">+</span> <span class=
"nx">redisDir</span> <span class="o">+</span> <span class="s2">"/redis_23741.pid\n"</span> <span class="o">+</span>
                    <span class="s2">"dir "</span> <span class="o">+</span> <span class=
"nx">redisDir</span> <span class="o">+</span> <span class="s2">"\n"</span><span class="p">;</span>

    <span class="cm">/* make the directory for redis */</span>
    <span class="kd">var</span> <span class="nx">dirstat</span> <span class="o">=</span> <span class=
"nx">stat</span><span class="p">(</span><span class="nx">redisDir</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">dirstat</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class=
"p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">redisDir</span><span class=
"p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class=
"nx">e</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/***** Test if Redis is already running *****/</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"o">=</span><span class="k">new</span> <span class="nx">redis</span><span class="p">.</span><span class=
"nx">init</span><span class="p">(</span><span class="mi">23741</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class=
"p">){}</span>

    <span class="cm">/***** LAUNCH REDIS *********/</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class=
"nx">shell</span><span class="p">(</span><span class="s2">"which redis-server"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class=
"nx">exitStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class=
"p">{</span>
        <span class="k">return</span> <span class="s2">"Could not find redis-server in PATH"</span><span class=
"p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">rdexec</span> <span class="o">=</span> <span class=
"nx">trim</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class=
"nx">stdout</span><span class="p">);</span>

    <span class="nx">ret</span> <span class="o">=</span> <span class="nx">exec</span><span class=
"p">(</span><span class="s2">"nohup"</span><span class="p">,</span> <span class="nx">rdexec</span><span class=
"p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="p">{</span><span class=
"nx">background</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class=
"nx">stdin</span><span class="o">:</span><span class="nx">redisConf</span><span class="p">});</span>
    <span class="kd">var</span> <span class="nx">rpid</span> <span class="o">=</span> <span class=
"nx">ret</span><span class="p">.</span><span class="nx">pid</span><span class="p">;</span>

    <span class="nx">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">kill</span><span class=
"p">(</span><span class="nx">rpid</span><span class="p">,</span> <span class="mi">0</span><span class=
"p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"Failed to start redis-server"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"o">=</span><span class="k">new</span> <span class="nx">redis</span><span class="p">.</span><span class=
"nx">init</span><span class="p">(</span><span class="mi">23741</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class=
"p">){</span>
        <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getuser</span><span class="p">(</span><span class=
"nx">req</span><span class="p">){</span>
    <span class="cm">/* Here is where you can look at headers, cookies or whatever</span>
<span class="cm">       to find user name. */</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">cookies</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">sendWsMsg</span><span class="p">(</span><span class=
"nx">req</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// sending a file</span>
        <span class="c1">// JSON from redis must be decoded.</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">file</span> <span class=
"o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class=
"p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class=
"nx">e</span><span class="p">){}</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">data</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class=
"nx">content</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//send file metadata, then ...</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
            <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
            <span class="nx">file</span><span class="o">:</span> <span class="p">{</span><span class=
"nx">name</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class=
"nx">type</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class=
"nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">}</span>
        <span class="p">});</span>
        <span class="c1">// ... send actual binary file</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span><span class="nx">bprintf</span><span class="p">(</span><span class="s1">'%!B'</span><span class=
"p">,</span><span class="nx">data</span><span class="p">.</span><span class="nx">file</span><span class=
"p">.</span><span class="nx">content</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="c1">// it is a text message</span>
    <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
            <span class="nx">from</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">from</span><span class="p">,</span>
            <span class="nx">msg</span><span class="o">:</span> <span class="nx">data</span><span class=
"p">.</span><span class="nx">msg</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">rtrigger</span><span class="p">(</span><span class=
"nx">req</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"p">.</span><span class="nx">xadd</span><span class="p">(</span><span class="nx">stream</span><span class=
"p">,</span> <span class="s2">"MAXLEN"</span><span class="p">,</span> <span class="s1">'~'</span><span class=
"p">,</span> <span class="s1">'2000'</span><span class="p">,</span> <span class="s2">"*"</span><span class=
"p">,</span> <span class="nx">obj</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class=
"p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class="p">({</span>
            <span class="nx">from</span><span class="o">:</span> <span class="s2">"System"</span><span class=
"p">,</span>
            <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span>
            <span class="nx">msg</span><span class="o">:</span> <span class="nx">sprintf</span><span class=
"p">(</span><span class="s2">"Error sending msg: %s"</span><span class="p">,</span> <span class=
"nx">e</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">setup_event_listen</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* check for username */</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">=</span><span class="nx">getuser</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">user_name</span><span class="p">){</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span> <span class="s2">"System"</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"No user name provided, disconnecting"</span><span class="p">});</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class=
"p">(){</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
        <span class="p">},</span><span class="mi">5</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">receive_message</span><span class="p">(</span><span class=
"nx">strdata</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">strdata</span><span class="p">){</span> <span class="c1">// undefined on disconnect</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">({</span><span class="nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="s2">"you are now disconnected."</span><span class="p">})</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">wsEnd</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class=
"nx">strdata</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class=
"mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class=
"p">.</span><span class="nx">id</span> <span class="o">!=</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">)</span>
            <span class="nx">sendWsMsg</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span><span class="nx">data</span><span class="p">);</span>
     <span class="p">}</span>

    <span class="cm">/* what to do if we are sent a message from another user. */</span>
    <span class="kd">var</span> <span class="nx">subscriptions</span> <span class="o">=</span> <span class=
"p">{};</span>
    <span class="nx">subscriptions</span><span class="p">[</span><span class="nx">stream</span><span class=
"p">]</span><span class="o">=</span><span class="s1">'$'</span><span class="p">;</span> <span class=
"c1">//only listening for one stream</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class="p">.</span><span class=
"nx">xread_auto_async</span><span class="p">(</span><span class="nx">subscriptions</span><span class=
"p">,</span> <span class="nx">receive_message</span><span class="p">);</span>

    <span class=
"c1">// set up function for when this user disconnects (either by browser disconnect or req.wsEnd() )</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">wsOnDisconnect</span><span class=
"p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,{</span><span class="nx">from</span><span class="o">:</span><span class="s1">'System'</span><span class=
"p">,</span> <span class="nx">id</span><span class="o">:</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class=
"o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"o">+</span><span class="s2">" has left the conversation"</span><span class="p">});</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class=
"p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="cm">/* send a notification to all listening that we've joined the conversation */</span>
    <span class="c1">// msg -&gt; everyone listening</span>
    <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span><span class=
"s1">'System'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">websocketId</span><span class="p">,</span> <span class=
"nx">msg</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="o">+</span><span class="s2">" has joined the conversation"</span><span class=
"p">});</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">//send the last &lt;=50 messages</span>
        <span class="kd">var</span> <span class="nx">msgRange</span> <span class="o">=</span> <span class=
"nx">req</span><span class="p">.</span><span class="nx">rcl</span><span class="p">.</span><span class=
"nx">xrevrange</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class=
"s1">'+'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class=
"s2">"COUNT"</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class=
"nx">i</span><span class="o">=</span><span class="nx">msgRange</span><span class="p">.</span><span class=
"nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class=
"nx">i</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">;</span> <span class=
"nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class=
"nx">msgRange</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class=
"p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">from</span><span class=
"o">!=</span><span class="s1">'System'</span><span class="p">)</span>
                <span class="nx">sendWsMsg</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// send a welcome message to client from the "System".</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class=
"s2">"System"</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"sb">`Welcome </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span> <span class=
"p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class=
"p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">wsSend</span><span class=
"p">(</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class=
"s2">"System"</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">sprintf</span><span class="p">(</span><span class="s2">"Error getting messages: %s"</span><span class=
"p">,</span><span class="nx">e</span><span class="p">)</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">forward_messages</span><span class="p">(</span><span class=
"nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* we are sent a file from the client in two parts: 1) JSON meta info, 2) binary data */</span>
    <span class="kd">var</span> <span class="nx">fileInfo</span><span class="p">;</span>  <span class=
"c1">//variable for JSON meta info</span>
    <span class="kd">var</span> <span class="nx">file</span><span class="p">;</span>  <span class=
"c1">// will hold object with meta data and binary file content</span>

    <span class="cm">/* STEP 1:  Check message type:  Either -</span>
<span class="cm">                   1) metadata for an incoming file</span>
<span class="cm">                   2) binary data for an incoming file</span>
<span class="cm">                   3) text message</span>
<span class="cm">    */</span>

    <span class="c1">// check non binary messages for JSON</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">wsIsBin</span> <span class="o">&amp;&</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* messages are just plain text, but</span>
<span class="cm">           if it is a file, first we get the file meta info in JSON format */</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nx">fileInfo</span><span class="o">=</span><span class="nx">JSON</span><span class=
"p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class=
"nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* it is not binary, or json, so it must be a message */</span>
            <span class="nx">fileInfo</span> <span class="o">=</span> <span class="kc">false</span><span class=
"p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* if it is binary data, we assume it is a file</span>
<span class="cm">       and the file info was already sent            */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">wsIsBin</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span> <span class="o">&amp;&</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//get the first entry of file meta info</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class=
"p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">shift</span><span class=
"p">();</span>
            <span class="c1">// add the body buffer to it</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class=
"o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">"%B"</span><span class=
"p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
            <span class="c1">// tell everyone who it's from</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">from</span><span class=
"o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class=
"p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="c1">// handle unlikely case that metadata is not available.</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="p">{</span><span class=
"nx">from</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">user_name</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span><span class=
"s2">""</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class=
"s2">"application/octet-stream"</span><span class="p">,</span> <span class="nx">content</span><span class=
"o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">fileInfo</span><span class="p">)</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class=
"o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">"%s"</span><span class=
"p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class=
"p">);</span><span class="c1">//It's not binary, convert body buffer to a string</span>


    <span class="cm">/* STEP 2:  Process info from step 1 -</span>
<span class=
"cm">                   1) if it is file metadata, save it in the "req.files" var and wait for next message</span>
<span class=
"cm">                   2) if we have both metadata and file content, trigger event and send to all other users</span>
<span class=
"cm">                   3) if we have a text message, trigger event to send message to all other users</span>
<span class="cm">    */</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">fileInfo</span> <span class=
"o">&amp;&</span> <span class="nx">fileInfo</span><span class="p">.</span><span class="nx">file</span><span class=
"p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">)</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">files</span> <span class=
"o">=</span> <span class="p">[];</span>
        <span class="cm">/* store file meta info in req where we will retrieve it next time */</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class=
"p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fileInfo</span><span class=
"p">.</span><span class="nx">file</span><span class="p">);</span>
        <span class="c1">// do nothing and get the actual binary file in the next message</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class=
"nx">file</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* we received a file, reassembled its meta info.  Send it to all that are listening */</span>
        <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">file</span><span class="o">:</span> <span class=
"nx">file</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class=
"nx">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//send the plain text message to whoever is listening</span>
        <span class="nx">rtrigger</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">user_name</span><span class="p">,</span> <span class=
"nx">id</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">websocketId</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span><span class=
"nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/* Step 3:</span>
<span class="cm">         We received data, but here no data is sent back to the client.  However,</span>
<span class="cm">         it is sent to others using trigger and receive by the rampart.event.on</span>
<span class="cm">         function which they registered in their own connections.  So we can just return</span>
<span class="cm">         here</span>
<span class="cm">    */</span>
<span class="p">}</span>

<span class="c1">// exporting a single function</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class=
"o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class=
"p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class=
"nx">init</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class=
"p">{</span>
        <span class="nx">sendWsMsg</span><span class="p">(</span><span class="nx">req</span><span class=
"p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span><span class=
"s1">'System'</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class=
"nx">sprintf</span><span class="p">(</span><span class="s1">'%s'</span><span class="p">,</span><span class=
"nx">err</span><span class="p">)});</span>
        <span class="nx">fprintf</span><span class="p">(</span><span class="nx">stderr</span><span class=
"p">,</span> <span class="s1">'%s'</span><span class="p">,</span> <span class="nx">err</span><span class=
"p">);</span>  <span class="c1">//this will go to error log if logging is set on</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class=
"nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* first run upon connect, req.body is empty</span>
<span class="cm">           Here is where we will set up the event to listen for</span>
<span class="cm">           incoming message from other users</span>
<span class="cm">         */</span>
        <span class="nx">setup_event_listen</span><span class="p">(</span><span class="nx">req</span><span class=
"p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* second and subsequent runs below.  Client has sent a message</span>
<span class="cm">           and we need to process and forward it to others who are</span>
<span class="cm">           listening via rampart.event.on above</span>
<span class="cm">         */</span>
        <span class="nx">forward_messages</span><span class="p">(</span><span class="nx">req</span><span class=
"p">);</span>
    <span class="p">}</span>


    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="section" id="improvements">
                    <h2>
                      Improvements<a class="headerlink" href="#improvements" title="Permalink to this headline">¶</a>
                    </h2>
                    <p>
                      We purposely kept these examples very simple in order to clearly demonstrate the concepts we
                      covered, so it has a long way to go to be used in production.
                    </p>
                    <p>
                      There are several ways you could improve the above scripts on your way to building a full app.
                      Some of the more obvious ones include:
                    </p>
                    <ul class="simple">
                      <li>
                        <p>
                          Create a user management system.
                        </p>
                      </li>
                      <li>
                        <p>
                          Improve the look and functionality of the client-side script.
                        </p>
                      </li>
                      <li>
                        <p>
                          Using multiple Redis Streams to add Direct Messaging and Channels.
                        </p>
                      </li>
                      <li>
                        <p>
                          Adding search by storing old messages in a <a class="reference internal" href=
                          "rampart-sql.html#preface"><span class="std std-ref">rampart-sql</span></a> database with a
                          Full Text Index.
                        </p>
                      </li>
                    </ul>
                    <p>
                      Enjoy!
                    </p>
                  </div>
                </div>
              </div>
            </div>
            <footer>
              <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
                <a href="tutorial-pi_news.html" class="btn btn-neutral float-right" title=
                "Building a Pi News Aggregator" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
                <a href="tutorial-citysearch.html" class="btn btn-neutral" title=
                "Find Cities and their Closest Neighbors" accesskey="p"><span class="fa fa-arrow-circle-left"></span>
                Previous</a>
              </div>
              <hr>
              <div role="contentinfo">
                <p>
                  © Copyright 2022, Moat Crossing Systems.
                </p>
              </div>Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️ using a custom <a href=
              "https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the
              Docs</a>.
            </footer>
          </div>
        </div>
      </section>
    </div>
    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script> 
    <script type="text/javascript" src="_static/jquery.js"></script> 
    <script type="text/javascript" src="_static/underscore.js"></script> 
    <script type="text/javascript" src="_static/doctools.js"></script> 
    <script type="text/javascript" src="_static/language_data.js"></script> 
    <script type="text/javascript" src=
    "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script> 
    <script type="text/javascript" src="_static/js/theme.js"></script> 
    <script type="text/javascript">

      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
    </script>
    <script src=
    "https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js"></script>
    <script id="rampart-search" src="_static/client_search.js"></script>
  </body>
</html>
