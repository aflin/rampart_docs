

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Find Cities and their Closest Neighbors &mdash; Rampart 0.2.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="_static/hacks.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Rampart 0.2.1 documentation" href="index.html"/>
        <link rel="up" title="Tutorials" href="tutorialtoc.html"/>
        <link rel="next" title="Using Websockets to Build a Chat" href="tutorial-wschat.html"/>
        <link rel="prev" title="Tutorials" href="tutorialtoc.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Rampart
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="rampart-main.html">Rampart JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-utils.html">Rampart Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-thread.html">Rampart Thread Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="sqltoc.html">The rampart-sql module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-server.html">The rampart-server module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-net.html">The rampart-net module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-html.html">The rampart-html module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-crypto.html">The rampart-crypto module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-curl.html">The rampart-curl module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-lmdb.html">The rampart-lmdb module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-redis.html">The rampart-redis module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-python.html">The rampart-python module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-robots.html">The rampart-robots module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-cmark.html">The rampart-cmark module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-url.html">The rampart-url module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-extras.html">Extras</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorialtoc.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Find Cities and their Closest Neighbors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preface">Preface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#concepts">Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-started">Getting Started</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#web-server-layout">Web Server Layout</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#importing-the-data">Importing the Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#examine-your-csv">Examine your CSV</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-table">Creating the table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#importing-the-csv">Importing the CSV</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-indexes">Building Indexes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-final-import-script">The Final Import Script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#web-server-script">Web Server Script</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#web-server-script-mapping">Web Server Script Mapping</a></li>
<li class="toctree-l4"><a class="reference internal" href="#delivering-static-content">Delivering Static Content</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-nearest-city-results">The Nearest City Results</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-auto-complete-results">The Auto-Complete Results</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-complete-server-side-script">The Complete Server-Side Script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-complete-script">The Complete Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial-wschat.html">Using Websockets to Build a Chat</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial-pi_news.html">Building a Pi News Aggregator</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Rampart</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorialtoc.html">Tutorials</a> &raquo;</li>
        
      <li>Find Cities and their Closest Neighbors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorial-citysearch.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="find-cities-and-their-closest-neighbors">
<h1>Find Cities and their Closest Neighbors<a class="headerlink" href="#find-cities-and-their-closest-neighbors" title="Permalink to this headline">¶</a></h1>
<div class="section" id="preface">
<h2>Preface<a class="headerlink" href="#preface" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we will use the <a class="reference internal" href="sqltoc.html#the-rampart-sql-module"><span class="std std-ref">SQL module</span></a>
and the <a class="reference internal" href="rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">Server module</span></a>, along
with some client side scripting to create a search of city names, which also
lists the nearest cities to the selected city.</p>
<p>You can download the complete project from our
<a class="reference external" href="https://github.com/aflin/rampart_tutorials">Tutorial Repository</a>
in the <a class="reference external" href="https://github.com/aflin/rampart_tutorials/tree/main/citysearch">citysearch directory</a>.</p>
<div class="section" id="license">
<h3>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h3>
<p>The code related to this tutorial is released under the MIT license.
The data used to populate the database is licensed under a
<a class="reference external" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons License</a>.</p>
</div>
</div>
<div class="section" id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<p>This module will demonstrate:</p>
<ul class="simple">
<li>Using the <a class="reference internal" href="sqltoc.html#the-rampart-sql-module"><span class="std std-ref">SQL module</span></a> to
<a class="reference internal" href="rampart-sql.html#importcsvfile"><span class="std std-ref">import</span></a> csv data.</li>
<li>Using the <a class="reference internal" href="sqltoc.html#the-rampart-sql-module"><span class="std std-ref">SQL module</span></a> to create a Fulltext search for
the client side autocomplete search.</li>
<li>Using the <a class="reference internal" href="sql-server-funcs.html#geographical-coordinate-functions"><span class="std std-ref">SQL geocode functions</span></a>
to encode latitude/longitude pairs for each entry in the database, and to
find the closest cities to any given latitude/longitude pair.</li>
</ul>
<p>In order to complete this tutorial, you should have basic knowledge of
JavaScript, SQL and client side scripting using JavaScript (a passing
knowledge of jQuery is also helpful).  This tutorial will not provide an
in-depth explanation of how client-side scripting works.</p>
</div>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>In order to search by name and by location, we need to create a database
that contains both place names and latitude/longitude information.
Fortunately, the good folks at <a class="reference external" href="http://www.geonames.org/">GeoNames.org</a>
and <a class="reference external" href="https://public.opendatasoft.com/">OpenDataSoft</a>
have available a CSV formatted file that accomplishes that and which is
licensed under a
<a class="reference external" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons License</a>.</p>
<p>You can navigate to
<a class="reference external" href="https://public.opendatasoft.com/explore/dataset/geonames-all-cities-with-a-population-1000/export/">https://public.opendatasoft.com/explore/dataset/geonames-all-cities-with-a-population-1000/export/</a>
and choose the CSV file.</p>
<p>Your first task will be to create a directory structure for this project.</p>
<div class="section" id="web-server-layout">
<h3>Web Server Layout<a class="headerlink" href="#web-server-layout" title="Permalink to this headline">¶</a></h3>
<p>In the Rampart binary distribution is a sample web server tree.  For our
purposes here, we assume you have downloaded and unzipped the Rampart binary
distribution into a directory named <code class="docutils literal notranslate"><span class="pre">~/downloads/rampart</span></code>. We will use
that for this project.
<a class="reference internal" href="rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">The rampart-server HTTP module</span></a>
is configured and loaded from the included <code class="docutils literal notranslate"><span class="pre">web_server/web_server_conf.js</span></code>
script.  It defines <code class="docutils literal notranslate"><span class="pre">web_server/html</span></code> as the default directory for static
html, <code class="docutils literal notranslate"><span class="pre">web_server/apps</span></code> as the default directory for scripts and
<code class="docutils literal notranslate"><span class="pre">web_server/data</span></code> as a standard location for databases.</p>
<p>To get started, copy the <code class="docutils literal notranslate"><span class="pre">web_server</span></code> directory to a convenient place for
this project. Also, for our purposes, we do not need
anything in the <code class="docutils literal notranslate"><span class="pre">web_server/apps/test_modules</span></code> or
<code class="docutils literal notranslate"><span class="pre">web_server/apps/wsapps</span></code> directories, so you can delete the copy of those
files. We will also add an empty file for our import script and web interface at
<code class="docutils literal notranslate"><span class="pre">web_server/apps/citysearch.js</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>user@localhost:~$ mkdir citysearch
user@localhost:~$ cd citysearch
user@localhost:~/citysearch$ cp -a ~/downloads/rampart/web_server ./
user@localhost:~/citysearch$ cd web_server/
user@localhost:~/citysearch/web_server$ rm -rf apps/test_modules wsapps/* html/index.html
user@localhost:~/citysearch/web_server$ touch ./apps/citysearch.js
user@localhost:~/citysearch/web_server$ find .
user@localhost:~/citysearch/web_server$ curl -o data/geonames-all-cities-with-a-population-1000.csv \
   &#39;https://public.opendatasoft.com/explore/dataset/geonames-all-cities-with-a-population-1000/download/?format=csv&amp;timezone=America/Los_Angeles&amp;lang=en&amp;use_labels_for_header=true&amp;csv_separator=%3B&#39;
./web_server
./web_server/apps
./web_server/apps/citysearch.js
./web_server/html
./web_server/html/images
./web_server/html/images/inigo-not-found.jpg
./web_server/data
./web_server/data/geonames-all-cities-with-a-population-1000.csv
./web_server/logs
./web_server/start_web_server.sh
./web_server/wsapps
./web_server/web_server_conf.js
</pre></div>
</div>
</div>
</div>
<div class="section" id="importing-the-data">
<h2>Importing the Data<a class="headerlink" href="#importing-the-data" title="Permalink to this headline">¶</a></h2>
<div class="section" id="examine-your-csv">
<h3>Examine your CSV<a class="headerlink" href="#examine-your-csv" title="Permalink to this headline">¶</a></h3>
<p>The first step for importing a CSV file is to have a look at the format of the
data in the file.  CSV can vary quite a bit, and to import it, we will want to
know a few thing such as (but not limited to):</p>
<ul class="simple">
<li>Does every column contain the same type?</li>
<li>Are text columns quoted?</li>
<li>Are single quotes present inside unquoted text fields?</li>
<li>Are records separated by <code class="docutils literal notranslate"><span class="pre">,</span></code> or by something else?</li>
<li>Is there a header row as the first line in the file?</li>
</ul>
<p>Let’s examine some rows of <code class="docutils literal notranslate"><span class="pre">geonames-all-cities-with-a-population-1000.csv</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ head -n 5 geonames-all-cities-with-a-population-1000.csv
Geoname ID;Name;ASCII Name;Alternate Names;Feature Class;Feature Code;Country Code;Country name EN;Country Code 2;Admin1 Code;Admin2 Code;Admin3 Code;Admin4 Code;Population;Elevation;DIgital Elevation Model;Timezone;Modification date;LABEL EN;Coordinates
8396129;Sanjiang;Sanjiang;Sanjiang,Sanjiang Jiedao,Sanjiang Qu,san jiang,san jiang jie dao,san jiang qu,三江,三江区,三江街道;P;PPLA3;CN;China;;01;3402;;;0;;14;Asia/Shanghai;2021-09-19;China;31.34813,118.36132
8405692;Xinmin;Xinmin;Xinmin,Xinmin Zhen,xin min,xin min zhen,新民,新民镇;P;PPLA4;CN;China;;33;8739734;;;28033;;402;Asia/Shanghai;2022-04-12;China;30.39759,107.3895
8416824;Jindaoxia;Jindaoxia;Jindaoxia,Jindaoxia Zhen,jin dao xia,jin dao xia zhen,金刀峡,金刀峡镇;P;PPLA4;CN;China;;33;8739734;;;13752;;323;Asia/Shanghai;2022-04-01;China;30.00528,106.65187
8420197;Jianlong;Jianlong;Jianlong,Jianlong Xiang,jian long,jian long xiang,健龙,健龙乡;P;PPLA4;CN;China;;33;8739734;;;18151;;276;Asia/Shanghai;2022-04-01;China;29.3586,106.18522

$ grep &quot;United States&quot; geonames-all-cities-with-a-population-1000.csv | head -n 5
5095312;Atlantic Highlands;Atlantic Highlands;Atlantic Highlands,Atlantik Khajlands,Portland Point,Portland Poynt,atlantyk haylndz  nywjrsy,Атлантик Хайландс,Атлантик Хајландс,آتلانتیک هایلندز، نیوجرسی;P;PPL;US;United States;;NJ;025;02110;;4311;11;14;America/New_York;2017-05-23;United States;40.40789,-74.03431
5095335;Avon-by-the-Sea;Avon-by-the-Sea;Avon,Avon-by-the-Sea,Ehvan-baj-zeh-Si,Key East,aywn-bay-d-sy  nywjrsy,Эван-бай-зэ-Си,ایون-بای-د-سی، نیوجرسی;P;PPL;US;United States;;NJ;025;02440;;1794;4;6;America/New_York;2017-05-23;United States;40.19234,-74.01597
5095561;Belmar;Belmar;BLM,Behlmar,Belmar,Ocean Beach,blmar  nywjrsy,Белмар,Бэлмар,بلمار، نیوجرسی;P;PPL;US;United States;;NJ;025;04930;;5712;4;6;America/New_York;2017-05-23;United States;40.17845,-74.0218
5096289;Carlstadt;Carlstadt;Carlstadt,Karlshtad,Karlstadt,Tailor Town,karlastadt  nywjrsy,Карлстадт,Карлштад,کارلاستادت، نیوجرسی;P;PPL;US;United States;;NJ;003;10480;;6279;55;55;America/New_York;2017-05-23;United States;40.84038,-74.0907
5097627;Elmwood Park;Elmwood Park;Dundee Lake,East Paterson,Ehlmvud Park,Elmvud Park,Elmwood Park,almwwd park  nywjrsy,Елмвуд Парк,Элмвуд Парк,الموود پارک، نیوجرسی;P;PPL;US;United States;;NJ;003;21300;;20279;14;14;America/New_York;2017-05-23;United States;40.90399,-74.11848
</pre></div>
</div>
<p>Immediately we can see that records are separated by semi-colons (<code class="docutils literal notranslate"><span class="pre">;</span></code>), that the
“Admin1” column has both number and text types and that text fields are not quoted.
Also the first row appears to be column names, and not data.</p>
<p>Next let’s check if there are embedded single quotes in text fields:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ grep &quot;&#39;&quot; geonames-all-cities-with-a-population-1000.csv | head -n 2
8992324;Nu’erbage;Nu&#39;erbage;Hetian Shi,Nu&#39;erbage,Nu&#39;erbage Jiedao,Nu’erbage,Nu’erbage Jiedao,he tian shi,nu er ba ge,nu er ba ge jie dao,努尔巴格,努尔巴格街道,和田市;P;PPLA3;CN;China;;13;6532;;;0;;1379;Asia/Urumqi;2021-09-20;China;37.1134,79.91034
12450872;Yingye&#39;er;Yingye&#39;er;;P;PPLA4;CN;China;;13;6532;;;11485;;1315;Asia/Urumqi;2022-03-31;China;37.37312,79.77745
</pre></div>
</div>
<p>And indeed there are single quotes in city names.</p>
<p>So to answer our earlier questions:</p>
<ul class="simple">
<li>Does every column contain the same type? – <span class="red">NO</span></li>
<li>Are text columns quoted?  – <span class="red">NO</span></li>
<li>Are single quotes present inside unquoted text fields? – <span class="green">YES</span></li>
<li>Are records separated by <code class="docutils literal notranslate"><span class="pre">,</span></code>?  – <span class="red">NO</span>, <span class="green">Uses semicolons</span></li>
<li>Is there a header row as the first line in the file? <span class="green">YES</span></li>
</ul>
<p>Note that although the file is separated by semi-colons, we will continue to use the term
<code class="docutils literal notranslate"><span class="pre">CSV</span></code>.</p>
<p>Armed with this knowledge, we are ready to create a script that imports our data.</p>
</div>
<div class="section" id="creating-the-table">
<h3>Creating the table<a class="headerlink" href="#creating-the-table" title="Permalink to this headline">¶</a></h3>
<p>The data will need to be imported in two stages.  Stage one will be as-is from the
CSV into a temporary table.  Stage two will combine City, Admin1 and Country
names into one field, separate and convert “Latitude,Longitute” to Numbers
and compute a geocode we will use later for a bounded area search.</p>
<p>So let’s create a script that will make our table by opening
<code class="docutils literal notranslate"><span class="pre">~/citysearch/web_server/apps/citysearch.js</span></code> in your text editor.</p>
<p>To begin, we need to load the SQL module and open a database;</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Sql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="s2">&quot;~/citysearch/web_server/data/cities&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</pre></div>
</div>
<p>In the above code, the <code class="docutils literal notranslate"><span class="pre">var</span> <span class="pre">Sql</span> <span class="pre">=</span> <span class="pre">require(&quot;rampart-sql&quot;);</span></code> line
loads the SQL module that is distributed with Rampart as
<code class="docutils literal notranslate"><span class="pre">rampart-sql.so</span></code>.  The second line,
<code class="docutils literal notranslate"><span class="pre">var</span> <span class="pre">sql</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">Sql.init(&quot;~/citysearch/web_server/data/cities&quot;,</span> <span class="pre">true);</span></code> opens the database.</p>
<p>Note the <code class="docutils literal notranslate"><span class="pre">true</span></code> in <code class="docutils literal notranslate"><span class="pre">Sql.init()</span></code>.  It signifies that if the database
does not exist, create the directory and the metadata files necessary
for a new, blank database.</p>
<p>When creating a new database, be sure that:</p>
<ul class="simple">
<li>The directory does not (yet) exist (it will be created).  If
it exists and does not contain the metadata files, the opening
of the database will fail.</li>
<li>The parent directory (in this case <code class="docutils literal notranslate"><span class="pre">~/citysearch/web_server/data/</span></code>)
<strong>does</strong> exist, and that you have read/write permissions.</li>
</ul>
<p>So now that we have the code to open, and optionally create our
database, let’s make our table.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">create_tmp_table</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table cities_tmp (&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Geoname_ID              varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Name                    varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;ASCII_Name              varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Alternate_Names         varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Feature_Class           varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Feature_Code            varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Country_Code            varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Country_name_EN         varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Country_Code_2          varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Admin1_Code             varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Admin2_Code             varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Admin3_Code             varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Admin4_Code             varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Population              int, &quot;</span>        <span class="o">+</span>
            <span class="s2">&quot;Elevation               int, &quot;</span>        <span class="o">+</span>
            <span class="s2">&quot;Digital_Elevation_Model int, &quot;</span>        <span class="o">+</span>
            <span class="s2">&quot;Timezone                varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Modification_date       varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;LABEL_EN                varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Coordinates             varchar(8)&quot;</span>   <span class="o">+</span>
            <span class="s2">&quot;);&quot;</span>  <span class="p">);</span>
<span class="p">}</span>

<span class="nx">create_tmp_table</span><span class="p">();</span>
</pre></div>
</div>
<p>This should all be self expanatory.  If not, please brush up on
your <a class="reference external" href="https://www.w3schools.com/sql/sql_create_table.asp">SQL</a>.</p>
<p>Note though that <code class="docutils literal notranslate"><span class="pre">varchar(x)</span></code> in Texis SQL, the size <code class="docutils literal notranslate"><span class="pre">x</span></code> is
merely a suggestion.  If the text put into this field is larger
that what is specified, it will not truncate the text or affect any indexing.</p>
<p>Now we have our table.  Let’s get that data in!</p>
</div>
<div class="section" id="importing-the-csv">
<h3>Importing the CSV<a class="headerlink" href="#importing-the-csv" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-settings">
<h4>The Settings<a class="headerlink" href="#the-settings" title="Permalink to this headline">¶</a></h4>
<p>The SQL module has a convenient function to import CSV data.  It has many options
and often takes careful examination of the data to be imported to get it correct.
Fortunately the large number of options allows us to get well formatted
CSV data imported correctly.</p>
<p>See the section for <a class="reference internal" href="rampart-sql.html#importcsvfile"><span class="std std-ref">importCsvFile()</span></a> for a full
listing.</p>
<p>Knowing what we discovered when we examined the <code class="docutils literal notranslate"><span class="pre">allCountries.txt</span></code> file above, we
can make our <code class="docutils literal notranslate"><span class="pre">importCsvFile()</span></code> call look like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">csvFile</span> <span class="o">=</span> <span class="s2">&quot;../data/geonames-all-cities-with-a-population-1000.csv&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">import_csv</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">total</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">importCsvFile</span><span class="p">(</span>
        <span class="nx">csvFile</span><span class="p">,</span>  <span class="c1">//file to import</span>
        <span class="p">{</span>
            <span class="nx">tableName</span><span class="o">:</span>       <span class="s1">&#39;cities_tmp&#39;</span><span class="p">,</span>
            <span class="nx">singleQuoteNest</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">hasHeaderRow</span><span class="o">:</span>    <span class="kc">true</span><span class="p">,</span>
            <span class="nx">delimiter</span><span class="o">:</span>       <span class="s1">&#39;;&#39;</span><span class="p">,</span>
            <span class="nx">normalize</span><span class="o">:</span>       <span class="kc">false</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n%d rows in total.\n&#39;</span><span class="p">,</span><span class="nx">total</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>So the <span class="green">Object</span> of settings passed to <code class="docutils literal notranslate"><span class="pre">importCsvFile()</span></code> addresses the answers to all our
questions above (<code class="docutils literal notranslate"><span class="pre">singleQuoteNest:</span> <span class="pre">false</span></code> is because there are single quotes present AND they
are not quoted in double quotes – one setting for those two questions).</p>
<p>We are ready to import the data.  But before we do, we know this will take a bit of time.
Let’s set up a function to monitor the progress so we aren’t staring at a blank screen
wondering when the import will be finished.</p>
</div>
<div class="section" id="monitoring-the-import">
<h4>Monitoring the Import<a class="headerlink" href="#monitoring-the-import" title="Permalink to this headline">¶</a></h4>
<p>There are two major stages at which we can monitor the import.  The first
is while <code class="docutils literal notranslate"><span class="pre">importCsvFile()</span></code> is analysing the data, and the second is
as the data is being inserted into the SQL table.</p>
<p>In the first, analysis stage, a monitoring function is passed two parameters:
<code class="docutils literal notranslate"><span class="pre">monitor_import(count,</span> <span class="pre">stage)</span></code>.  The analysis takes at least two passes.
If <code class="docutils literal notranslate"><span class="pre">normalize</span></code>, is set <code class="docutils literal notranslate"><span class="pre">true</span></code>, two more passes are added for each column.</p>
<p>Note that the first stage is significantly faster than the second.  Therefore if your
dataset is not very large, you might want to skip reporting on the progress
of the first page.</p>
<p>In the second, insert stage, a monitoring function is passed only one parameter:
<code class="docutils literal notranslate"><span class="pre">monitor_import(count)</span></code>.  There is only one pass for the second stage.</p>
<p>Knowing this, we can write a single function to print out our progress, which may be used
at either of or both of the major stages.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// cuz no one likes writing out &#39;rampart.utils.printf()&#39;</span>
<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">total</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//we won&#39;t know the total until we finish the first pass of importCsvFile</span>
<span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//set in importCsvFile(), only report every 100th row</span>

<span class="cm">/* a single function to monitor the import for both pre-processing (progressFunc)</span>
<span class="cm">   and import (callback function supplied to sql.importCsvFile as a paramater)   */</span>
<span class="kd">function</span> <span class="nx">monitor_import</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stage</span> <span class="o">=</span> <span class="s2">&quot;Import&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">)</span> <span class="c1">// progressfunc</span>
        <span class="nx">stage</span><span class="o">=</span><span class="nx">stg</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//differentiate between 0 and undefined</span>
    <span class="p">{</span>
        <span class="nx">total</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span> <span class="c1">//update our total in the first stage.</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d       \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d of %d      \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="transforming-the-data">
<h4>Transforming the Data<a class="headerlink" href="#transforming-the-data" title="Permalink to this headline">¶</a></h4>
<p>At this point we can import the data into the temporary table.  Now
it needs to be transformed into its final form and put in the final
table.</p>
<p>So we will use the following to create the table and transform
the data.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">create_final_table</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table cities (&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;id                      counter, &quot;</span>    <span class="o">+</span>
            <span class="s2">&quot;place                   varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;alt_names               varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;population              int, &quot;</span>        <span class="o">+</span>
            <span class="s2">&quot;latitude                double, &quot;</span>     <span class="o">+</span>
            <span class="s2">&quot;longitude           double, &quot;</span>     <span class="o">+</span>
            <span class="s2">&quot;geocode             long, &quot;</span>       <span class="o">+</span>
            <span class="s2">&quot;timezone                varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;country                 varchar(8) &quot;</span>  <span class="o">+</span>
            <span class="s2">&quot;);&quot;</span>  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">makerow</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ret</span><span class="o">=</span><span class="p">{},</span> <span class="nx">tmp</span><span class="p">;</span>

    <span class="nx">ret</span><span class="p">.</span><span class="nx">place</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%s, %s %s(%s)&#39;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Admin1_Code</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_name_EN</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_Code</span><span class="p">);</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">altNames</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Alternate_Names</span><span class="p">;</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">population</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Population</span><span class="p">;</span>
    <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Coordinates</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">lat</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">lon</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">tz</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Timezone</span><span class="p">;</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">country</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_name_EN</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">build_final_table</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;sorting rows\n&quot;</span><span class="p">);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;select * from cities_tmp order by Population DESC&quot;</span><span class="p">,</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;done\nCreating Final Table\n&quot;</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="nx">makerow</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
            <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;insert into cities values( &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;counter, ?place, ?altNames, ?population, ?lat, ?lon, latlon2geocode(?lat, ?lon), ?tz, ?country );&quot;</span><span class="p">,</span>
                <span class="nx">vals</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="nx">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d of %d\r&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
                <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:-</span><span class="mi">1</span><span class="p">}</span>
    <span class="p">);</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">create_final_table</span><span class="p">();</span>
<span class="nx">build_final_table</span><span class="p">();</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">create_final_table()</span></code> function is easily understood.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">makerow()</span></code> function, we take a single row from the temporary table
and create the placename, separate the coordinates and convert them to
numbers and add the other columns we want to keep.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">build_final_table()</span></code> function, we select one row at a time,
transform the row by passing it to <code class="docutils literal notranslate"><span class="pre">makerow()</span></code> and insert it into our
final table.  Rows are returned from the <code class="docutils literal notranslate"><span class="pre">cities_tmp</span></code> table ordered by
population so that we do not need to sort them in the web application.</p>
<p>In addition, we will calculate the geocode necessary
to do bounded geographical searches and insert it into the <code class="docutils literal notranslate"><span class="pre">geocode</span></code>
column.</p>
<p>According to the <a class="reference internal" href="sql-server-funcs.html#latlon2geocode-latlon2geocodearea"><span class="std std-ref">documentation</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>The latlon2geocode function encodes a given latitude/longitude coordinate
into one long return value.  This encoded value – a “geocode” value – can
be indexed and used with a special variant of Texis’ BETWEEN operator for
bounded-area searches of a geographical region.
</pre></div>
</div>
<p>That is exactly what we need to efficiently search for other places close to a given one.</p>
</div>
<div class="section" id="putting-it-together">
<h4>Putting it Together<a class="headerlink" href="#putting-it-together" title="Permalink to this headline">¶</a></h4>
<p>Putting this all together, and using the <code class="docutils literal notranslate"><span class="pre">callbackStep</span></code> and <code class="docutils literal notranslate"><span class="pre">progressStep</span></code>
settings, we end up with this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">create_tmp_table</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table cities_tmp (&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Geoname_ID              varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Name                    varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;ASCII_Name              varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Alternate_Names         varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Feature_Class           varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Feature_Code            varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Country_Code            varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Country_name_EN         varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Country_Code_2          varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Admin1_Code             varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Admin2_Code             varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Admin3_Code             varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Admin4_Code             varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Population              int, &quot;</span>        <span class="o">+</span>
            <span class="s2">&quot;Elevation               int, &quot;</span>        <span class="o">+</span>
            <span class="s2">&quot;Digital_Elevation_Model int, &quot;</span>        <span class="o">+</span>
            <span class="s2">&quot;Timezone                varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Modification_date       varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;LABEL_EN                varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;Coordinates             varchar(8)&quot;</span>   <span class="o">+</span>
            <span class="s2">&quot;);&quot;</span>  <span class="p">);</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">total</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//we won&#39;t know the total until we finish the first pass of importCsvFile</span>
<span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//set in importCsvFile(), only report every 100th row</span>

<span class="cm">/* a single function to monitor the import for both pre-processing (progressFunc)</span>
<span class="cm">   and import (callback function supplied to sql.importCsvFile as a paramater)   */</span>
<span class="kd">function</span> <span class="nx">monitor_import</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stage</span> <span class="o">=</span> <span class="s2">&quot;Import&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">)</span> <span class="c1">// progressfunc</span>
        <span class="nx">stage</span><span class="o">=</span><span class="nx">stg</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//differentiate between 0 and undefined</span>
    <span class="p">{</span>
        <span class="nx">total</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span> <span class="c1">//update our total in the first stage.</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d       \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d of %d      \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">import_csv</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">total</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">importCsvFile</span><span class="p">(</span>
        <span class="nx">csvFile</span><span class="p">,</span>  <span class="c1">//file to import</span>
        <span class="p">{</span>
            <span class="nx">tableName</span><span class="o">:</span>       <span class="s1">&#39;cities_tmp&#39;</span><span class="p">,</span>
            <span class="nx">singleQuoteNest</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">hasHeaderRow</span><span class="o">:</span>    <span class="kc">true</span><span class="p">,</span>
            <span class="nx">delimiter</span><span class="o">:</span>       <span class="s1">&#39;;&#39;</span><span class="p">,</span>
            <span class="nx">normalize</span><span class="o">:</span>       <span class="kc">false</span><span class="p">,</span>
            <span class="nx">callbackStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//callback run every 100th row</span>
            <span class="nx">progressStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//progressfunc run every 100th row for each stage</span>
            <span class="nx">progressFunc</span><span class="o">:</span>    <span class="nx">monitor_import</span> <span class="c1">//progress function while processing csv</span>
        <span class="p">},</span>
        <span class="nx">monitor_import</span> <span class="c1">//callback function upon actual import</span>
    <span class="p">);</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n%d rows in total.\n&#39;</span><span class="p">,</span><span class="nx">total</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">create_final_table</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table cities (&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;id                      counter, &quot;</span>    <span class="o">+</span>
            <span class="s2">&quot;place                   varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;alt_names               varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;population              int, &quot;</span>        <span class="o">+</span>
            <span class="s2">&quot;latitude                double, &quot;</span>     <span class="o">+</span>
            <span class="s2">&quot;longitude           double, &quot;</span>     <span class="o">+</span>
            <span class="s2">&quot;geocode             long, &quot;</span>       <span class="o">+</span>
            <span class="s2">&quot;timezone                varchar(8), &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;country                 varchar(8) &quot;</span>  <span class="o">+</span>
            <span class="s2">&quot;);&quot;</span>  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">makerow</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ret</span><span class="o">=</span><span class="p">{},</span> <span class="nx">tmp</span><span class="p">;</span>

    <span class="nx">ret</span><span class="p">.</span><span class="nx">place</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%s, %s %s(%s)&#39;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Admin1_Code</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_name_EN</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_Code</span><span class="p">);</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">altNames</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Alternate_Names</span><span class="p">;</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">population</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Population</span><span class="p">;</span>
    <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Coordinates</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">lat</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">lon</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">tz</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Timezone</span><span class="p">;</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">country</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_name_EN</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">build_final_table</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;sorting rows\n&quot;</span><span class="p">);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;select * from cities_tmp order by Population DESC&quot;</span><span class="p">,</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;done\nCreating Final Table\n&quot;</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="nx">makerow</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
            <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;insert into cities values( &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;counter, ?place, ?altNames, ?population, ?lat, ?lon, latlon2geocode(?lat, ?lon), ?tz, ?country );&quot;</span><span class="p">,</span>
                <span class="nx">vals</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="nx">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d of %d\r&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
                <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:-</span><span class="mi">1</span><span class="p">}</span>
    <span class="p">);</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">create_tmp_table</span><span class="p">();</span>
<span class="nx">import_csv</span><span class="p">();</span>
<span class="nx">create_final_table</span><span class="p">();</span>
<span class="nx">build_final_table</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="building-indexes">
<h3>Building Indexes<a class="headerlink" href="#building-indexes" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-geocode-index">
<h4>The geocode index<a class="headerlink" href="#the-geocode-index" title="Permalink to this headline">¶</a></h4>
<p>We need to create an index to speed up the bounded “geocode” search we will
use in our web application.
And we should do that in our script.  And once again, we are going to wrap
it in a function.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">make_geocode_index</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on geocode\n&quot;</span><span class="p">);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index cities_geocode_x on cities(geocode) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A couple of things to note:</p>
<p>First – when this index is made, it will backed by a
file named <code class="docutils literal notranslate"><span class="pre">cities_geocode_x.btr</span></code>.  It is so named because it will be
easy to find using <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-l</span></code> (it will come right before the table, named
<code class="docutils literal notranslate"><span class="pre">cities.tbl</span></code>, and it lets you know the field indexed (<code class="docutils literal notranslate"><span class="pre">_geocode</span></code>) and
the type of index (<code class="docutils literal notranslate"><span class="pre">_x</span></code> for plain index, i.e.  - not Fulltext or unique).
Your methodology for naming indexes is not as important as making sure you
are consistent, can read it and know what the index is for without having to
resort to looking it up.</p>
<p>However if you do not know what an index is for, you can always look it up in the System
Catalog:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tsql -d ../data/cities/ &quot;select * from SYSINDEX where NAME=&#39;cities_geocode_x&#39;&quot;

    NAME        TBNAME       FNAME       COLLSEQ        TYPE      NON_UNIQUE     FIELDS       PARAMS
------------+------------+------------+------------+------------+------------+------------+------------+
cities_geocode_x cities       cities_geocode_x A            B                      01 geocode      stringcomparemode=unicodemulti,respectcase;
</pre></div>
</div>
<p>Second –  note the <code class="docutils literal notranslate"><span class="pre">WITH</span> <span class="pre">INDEXMETER</span> <span class="pre">'on'</span></code> in the SQL statement.  This will tell
Texis to print a pretty meter to let you know the progress of your index creation.</p>
</div>
<div class="section" id="the-id-index">
<h4>The id index<a class="headerlink" href="#the-id-index" title="Permalink to this headline">¶</a></h4>
<p>Eventually, when we write our web application script, we will want to look up records based on the
<code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">counter</span></code> field.  So we will make a function to make an index on that as well.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">make_id_index</span><span class="p">(){</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on id\n&quot;</span><span class="p">);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index cities_id_x on cities(id) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-fulltext-index">
<h4>The Fulltext index<a class="headerlink" href="#the-fulltext-index" title="Permalink to this headline">¶</a></h4>
<p>When making a Fulltext index, often it is best to leave most settings as is.  The one exception
is the <a class="reference internal" href="rampart-sql.html#rex"><span class="std std-ref">rex</span></a> expressions used to define what is a word.
Often we want to make sure we include utf-8 encoded text.</p>
<p>The default is <code class="docutils literal notranslate"><span class="pre">\alnum{2,99}</span></code>, which is similar to doing <code class="docutils literal notranslate"><span class="pre">mydoc.match(/[a-zA-Z0-9]+/g)</span></code>.
Since we are processing utf-8 text, and since we have names of places from all over the world,
we had better accommodate bytes larger than <code class="docutils literal notranslate"><span class="pre">0x79</span></code>.</p>
<p>To change the expression used during Fulltext index creation, we can use
<a class="reference internal" href="sql-set.html#delexp"><span class="std std-ref">delExp</span></a> and <a class="reference internal" href="sql-set.html#addexp"><span class="std std-ref">addExp</span></a>.  However
as a shortcut, we can specify the expressions that will be used in the SQL
statement itself by utilizing the <code class="docutils literal notranslate"><span class="pre">WITH</span></code> keyword:</p>
<p><code class="docutils literal notranslate"><span class="pre">WITH</span> <span class="pre">WORDEXPRESSIONS</span> <span class="pre">('[\\alnum\\x80-\\xFF]{2,99}')</span></code></p>
<p>That will find words consisting of 7-bit ascii letters and numbers, plus utf-8 multibyte characters as well.</p>
<p>Now we also have a database that does not contain normal text.  It is worth
thinking about where this might bite us when we perform a search.  Let’s
look at the <a class="reference internal" href="sql-set.html#noiselist"><span class="std std-ref">list of noise words</span></a>.  The excluded
<code class="docutils literal notranslate"><span class="pre">us</span></code>, <code class="docutils literal notranslate"><span class="pre">to</span></code> and <code class="docutils literal notranslate"><span class="pre">in</span></code> look suspect.  They are the same as some of our
country codes.  And <code class="docutils literal notranslate"><span class="pre">or</span></code> is an <code class="docutils literal notranslate"><span class="pre">Admin1</span></code> abbreviation for Oregon.</p>
<p>Normally when searching normal English text, removing all the noise words
would hurt performance.  However, in this very specific circumstance, noise
words serve no purpose.  Further, they will exclude some codes we want in
our index.  So we will delete the noiseList.</p>
<p>You should always have a very good reason for altering or deleting the
noiseList.  For English text, there is rarely a need to do so and it can
have adverse consequences on performance and quality of results.  However,
this time we do have a good reason.</p>
<p>Now - what exactly do we want to index?  Naturally we want to be able to
look up a place based upon the <code class="docutils literal notranslate"><span class="pre">place</span></code> column.  So we will create one
index on it.  However we also have alternate names, which we will want
to search if there are no matches from <code class="docutils literal notranslate"><span class="pre">place</span></code>.  Thus we will
create a separate index on <code class="docutils literal notranslate"><span class="pre">alt_names</span></code> as well.</p>
<p>So, let’s see our SQL statements to create the Fulltext indexes in its own function:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">make_text_indexes</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating indexes on place names\n&quot;</span><span class="p">);</span>

    <span class="c1">// noiselist as detailed at https://rampart.dev/docs/sql-set.html#noiselist</span>
    <span class="c1">// This is not English text and some geographic abbreviations like OR IN DO TO SO and US</span>
    <span class="c1">// are also on the noise words list.  Setting to empty will allow such words in the index.</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">noiseList</span><span class="o">:</span><span class="p">[]});</span>

    <span class="c1">// make compact index.  Sorting by population, not by likep rank.  See like3 search below.</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create fulltext index cities_place_ftx on cities(place)&quot;</span><span class="o">+</span>
        <span class="s2">&quot; WITH WORDEXPRESSIONS (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;) INDEXMETER &#39;on&#39; WORDPOSITIONS &#39;off&#39;;&quot;</span><span class="p">);</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create fulltext index cities_altNames_ftx on cities(alt_names)&quot;</span><span class="o">+</span>
        <span class="s2">&quot; WITH WORDEXPRESSIONS (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;) INDEXMETER &#39;on&#39; WORDPOSITIONS &#39;off&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that we also have <code class="docutils literal notranslate"><span class="pre">WORDPOSITIONS</span> <span class="pre">'off'</span></code>.  This omits the position of
the indexed words and creates a smaller index.  Normally we would want this
information in order to rank by relevance, taking into account word
proximity, order and placement in the document.  However in our web
application we will be ordering by population, so this information is not
needed.</p>
<p>See <a class="reference internal" href="rampart-sql.html#fulltext-indexes"><span class="std std-ref">the documentation</span></a> for more information.</p>
</div>
</div>
<div class="section" id="the-final-import-script">
<h3>The Final Import Script<a class="headerlink" href="#the-final-import-script" title="Permalink to this headline">¶</a></h3>
<p>We put it all together, wrap it in a function, and it looks something like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// cuz no one likes writing out &#39;rampart.utils.printf()&#39;</span>
<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Sql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="s2">&quot;~/citysearch/web_server/data/cities&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">csvFile</span> <span class="o">=</span> <span class="s2">&quot;../data/geonames-all-cities-with-a-population-1000.csv&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">import_data</span><span class="p">(){</span>
    <span class="kd">function</span> <span class="nx">create_tmp_table</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table cities_tmp (&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Geoname_ID              varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Name                    varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;ASCII_Name              varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Alternate_Names         varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Feature_Class           varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Feature_Code            varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Country_Code            varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Country_name_EN         varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Country_Code_2          varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Admin1_Code             varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Admin2_Code             varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Admin3_Code             varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Admin4_Code             varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Population              int, &quot;</span>        <span class="o">+</span>
                <span class="s2">&quot;Elevation               int, &quot;</span>        <span class="o">+</span>
                <span class="s2">&quot;Digital_Elevation_Model int, &quot;</span>        <span class="o">+</span>
                <span class="s2">&quot;Timezone                varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Modification_date       varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;LABEL_EN                varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Coordinates             varchar(8)&quot;</span>   <span class="o">+</span>
                <span class="s2">&quot;);&quot;</span>  <span class="p">);</span>
    <span class="p">}</span>


    <span class="kd">var</span> <span class="nx">total</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//we won&#39;t know the total until we finish the first pass of importCsvFile</span>
    <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//set in importCsvFile(), only report every 100th row</span>

    <span class="cm">/* a single function to monitor the import for both pre-processing (progressFunc)</span>
<span class="cm">       and import (callback function supplied to sql.importCsvFile as a paramater)   */</span>
    <span class="kd">function</span> <span class="nx">monitor_import</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stg</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stage</span> <span class="o">=</span> <span class="s2">&quot;Import&quot;</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">stg</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">)</span> <span class="c1">// progressfunc</span>
            <span class="nx">stage</span><span class="o">=</span><span class="nx">stg</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">stg</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//differentiate between 0 and undefined</span>
        <span class="p">{</span>
            <span class="nx">total</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span> <span class="c1">//update our total in the first stage.</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d       \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d of %d      \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">import_csv</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">total</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">importCsvFile</span><span class="p">(</span>
            <span class="nx">csvFile</span><span class="p">,</span>  <span class="c1">//file to import</span>
            <span class="p">{</span>
                <span class="nx">tableName</span><span class="o">:</span>       <span class="s1">&#39;cities_tmp&#39;</span><span class="p">,</span>
                <span class="nx">singleQuoteNest</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">hasHeaderRow</span><span class="o">:</span>    <span class="kc">true</span><span class="p">,</span>
                <span class="nx">delimiter</span><span class="o">:</span>       <span class="s1">&#39;;&#39;</span><span class="p">,</span>
                <span class="nx">normalize</span><span class="o">:</span>       <span class="kc">false</span><span class="p">,</span>
                <span class="nx">callbackStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//callback run every 100th row</span>
                <span class="nx">progressStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//progressfunc run every 100th row for each stage</span>
                <span class="nx">progressFunc</span><span class="o">:</span>    <span class="nx">monitor_import</span> <span class="c1">//progress function while processing csv</span>
            <span class="p">},</span>
            <span class="nx">monitor_import</span> <span class="c1">//callback function upon actual import</span>
        <span class="p">);</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n%d rows in total.\n&#39;</span><span class="p">,</span><span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">create_final_table</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table cities (&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;id                      counter, &quot;</span>    <span class="o">+</span>
                <span class="s2">&quot;place                   varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;alt_names               varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;population              int, &quot;</span>        <span class="o">+</span>
                <span class="s2">&quot;latitude                double, &quot;</span>     <span class="o">+</span>
                <span class="s2">&quot;longitude           double, &quot;</span>     <span class="o">+</span>
                <span class="s2">&quot;geocode             long, &quot;</span>       <span class="o">+</span>
                <span class="s2">&quot;timezone                varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;country                 varchar(8) &quot;</span>  <span class="o">+</span>
                <span class="s2">&quot;);&quot;</span>  <span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">makerow</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ret</span><span class="o">=</span><span class="p">{},</span> <span class="nx">tmp</span><span class="p">;</span>

        <span class="nx">ret</span><span class="p">.</span><span class="nx">place</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%s, %s %s(%s)&#39;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Admin1_Code</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_name_EN</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_Code</span><span class="p">);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">altNames</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Alternate_Names</span><span class="p">;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">population</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Population</span><span class="p">;</span>
        <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Coordinates</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">lat</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">lon</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">tz</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Timezone</span><span class="p">;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">country</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_name_EN</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">build_final_table</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;sorting rows\n&quot;</span><span class="p">);</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;select * from cities_tmp order by Population DESC&quot;</span><span class="p">,</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;done\nCreating Final Table\n&quot;</span><span class="p">);</span>

                <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="nx">makerow</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
                <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;insert into cities values( &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;counter, ?place, ?altNames, ?population, ?lat, ?lon, latlon2geocode(?lat, ?lon), ?tz, ?country );&quot;</span><span class="p">,</span>
                    <span class="nx">vals</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="nx">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d of %d\r&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
                    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span><span class="nx">maxRows</span><span class="o">:-</span><span class="mi">1</span><span class="p">}</span>
        <span class="p">);</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">make_geocode_index</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on geocode\n&quot;</span><span class="p">);</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index cities_geocode_x on cities(geocode) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">make_id_index</span><span class="p">(){</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on id\n&quot;</span><span class="p">);</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index cities_id_x on cities(id) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">make_text_indexes</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating indexes on place names\n&quot;</span><span class="p">);</span>

        <span class="c1">// noiselist as detailed at https://rampart.dev/docs/sql-set.html#noiselist</span>
        <span class="c1">// This is not English text and some geographic abbreviations like OR IN DO TO SO and US</span>
        <span class="c1">// are also on the noise words list.  Setting to empty will allow such words in the index.</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">noiseList</span><span class="o">:</span><span class="p">[]});</span>

        <span class="c1">// make compact index.  Sorting by population, not by likep rank.  See like3 search below.</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create fulltext index cities_place_ftx on cities(place)&quot;</span><span class="o">+</span>
            <span class="s2">&quot; WITH WORDEXPRESSIONS (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;) INDEXMETER &#39;on&#39; WORDPOSITIONS &#39;off&#39;;&quot;</span><span class="p">);</span>

        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create fulltext index cities_altNames_ftx on cities(alt_names)&quot;</span><span class="o">+</span>
            <span class="s2">&quot; WITH WORDEXPRESSIONS (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;) INDEXMETER &#39;on&#39; WORDPOSITIONS &#39;off&#39;;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">drop_tmp_table</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;drop table cities_tmp&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">create_tmp_table</span><span class="p">();</span>
    <span class="nx">import_csv</span><span class="p">();</span>
    <span class="nx">create_final_table</span><span class="p">();</span>
    <span class="nx">build_final_table</span><span class="p">();</span>
    <span class="nx">make_geocode_index</span><span class="p">();</span>
    <span class="nx">make_id_index</span><span class="p">();</span>
    <span class="nx">make_text_indexes</span><span class="p">();</span>
    <span class="nx">drop_tmp_table</span><span class="p">();</span>

<span class="p">}</span>

<span class="nx">import_data</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="web-server-script">
<h2>Web Server Script<a class="headerlink" href="#web-server-script" title="Permalink to this headline">¶</a></h2>
<div class="section" id="web-server-script-mapping">
<h3>Web Server Script Mapping<a class="headerlink" href="#web-server-script-mapping" title="Permalink to this headline">¶</a></h3>
<p>We will start by adding to the <code class="docutils literal notranslate"><span class="pre">apps/citysearch.js</span></code> file in order to map
functions to urls for use with <a class="reference internal" href="rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">Server module</span></a>.
So we add the following stub script to what we have above to get started:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>

<span class="c1">// var to hold the client-side javascript</span>
<span class="kd">var</span> <span class="nx">client_script</span><span class="p">;</span>

<span class="c1">// var to hold a format string containing the top of the page</span>
<span class="c1">// html and a place for the query string.</span>
<span class="kd">var</span> <span class="nx">pageTopFmt</span><span class="p">;</span>

<span class="c1">// the bottom of our html page</span>
<span class="kd">var</span> <span class="nx">pageBottom</span><span class="p">;</span>

<span class="c1">// function stubs</span>
<span class="kd">function</span> <span class="nx">htmlpage</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>


<span class="c1">// module and module.exports are set when called from the webserver</span>
<span class="k">if</span><span class="p">(</span><span class="nx">module</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// url to function mapping</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;/&quot;</span><span class="o">:</span>               <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/</span>
        <span class="s2">&quot;/index.html&quot;</span><span class="o">:</span>     <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/index.html</span>
        <span class="s2">&quot;/autocomp.json&quot;</span><span class="o">:</span>  <span class="nx">autocomp</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/autocomp.json</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// called from the command line.  Build the database.</span>
    <span class="nx">import_data</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">module.exports</span></code> is set to an <span class="green">Object</span>.  This allows a
single module script to serve pages at multiple URLs.  Here <code class="docutils literal notranslate"><span class="pre">/</span></code> and
<code class="docutils literal notranslate"><span class="pre">/index.html</span></code> will be used to return html and <code class="docutils literal notranslate"><span class="pre">/autocomp.json</span></code>
will be used for AJAX requests and will return JSON.</p>
</div>
<div class="section" id="delivering-static-content">
<h3>Delivering Static Content<a class="headerlink" href="#delivering-static-content" title="Permalink to this headline">¶</a></h3>
<p>Looking at the stub script above, there are two distinct times that the code
therein will be run: 1) once upon module load and 2) upon each request from
a client as mapped in the <code class="docutils literal notranslate"><span class="pre">module.exports</span></code> <span class="green">Object</span>.  For security
purposes, it is important to keep this in mind as you write scripts.
Variables set in the module outside of the <code class="docutils literal notranslate"><span class="pre">htmlpage()</span></code>, and
<code class="docutils literal notranslate"><span class="pre">autocomp()</span></code> functions are long lived and span multiple requests.</p>
<p>That being said, we can set a few variables in the script to deliver
the static content.  They only need to be loaded once as they contains the
HTML and client side JavaScript that will be delivered to every client, and
they do not change.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// the autocomplete plugin from  https://github.com/devbridge/jQuery-Autocomplete</span>
<span class="c1">// jquery and plugin included from cloudflare in &lt;script src=&quot;xyz&quot;&gt; tags below in pageTopFmt.</span>
<span class="kd">var</span> <span class="nx">client_script</span> <span class="o">=</span> <span class="sb">`</span>
<span class="sb">$(document).ready(function(){</span>
<span class="sb">    $(&#39;#cstextbox&#39;).autocomplete(</span>
<span class="sb">        {</span>
<span class="sb">            serviceUrl: &#39;/apps/citysearch/autocomp.json&#39;,</span>
<span class="sb">            minChars: 2,</span>
<span class="sb">            autoSelectFirst: true,</span>
<span class="sb">            showNoSuggestionNotice: true,</span>
<span class="sb">            triggerSelectOnValidInput: false,</span>
<span class="sb">            onSelect: function(sel) { window.location.assign(&quot;./?id=&quot;+sel.id); }</span>
<span class="sb">        }</span>
<span class="sb">    );</span>

<span class="sb">    $(&#39;#cstextbox&#39;).on(&#39;keypress&#39;, function(e){</span>
<span class="sb">        var key = e.charCode || e.keyCode || 0;</span>
<span class="sb">        if (key == 13) {       // on &lt;return&gt; don&#39;t submit form</span>
<span class="sb">            e.preventDefault();</span>
<span class="sb">            return false;</span>
<span class="sb">        }</span>
<span class="sb">    });</span>
<span class="sb">});</span>
<span class="sb">`</span><span class="p">;</span>

<span class="c1">// pageTopFmt is defined once upon script load here rather than upon each request in</span>
<span class="c1">// htmlpage() below. format code %w removes leading white space.</span>
<span class="kd">var</span> <span class="nx">pageTopFmt</span><span class="o">=</span><span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%w&#39;</span><span class="p">,</span><span class="sb">`&lt;!DOCTYPE HTML&gt;</span>
<span class="sb">&lt;html&gt;</span>
<span class="sb">    &lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;style&gt;</span>
<span class="sb">        body,h1,h2,h3,h4,h5,h6 {font-family: &quot;Varela Round&quot;, Sans-Serif;}</span>
<span class="sb">        .autocomplete-suggestions {border: 1px solid #999; background: #FFF; overflow: auto; width: auto !important; padding-right:5px;}</span>
<span class="sb">        .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }</span>
<span class="sb">        .autocomplete-suggestions strong {font-weight: normal; color: #3399FF; }</span>
<span class="sb">        .autocomplete-group strong { display: block; border-bottom: 1px solid #000; }</span>
<span class="sb">        .autocomplete-selected { background: #F0F0F0; }</span>
<span class="sb">        .autocomplete-group { padding: 2px 5px; }</span>
<span class="sb">        #main {background-color: white;margin: auto;min-height: 300px;width: 600px;}</span>
<span class="sb">        #idiv { width:500px;height:39px;border-bottom: lightGray 1px solid;padding:15px 0px 15px 0px;}</span>
<span class="sb">        #cstextbox {min-width:150px;width:100%%;height:30px;font:normal 18px arial,sans-serif;padding: 1px 3px;border: 2px solid #ccc;box-sizing: bord</span>
<span class="sb">    &lt;/style&gt;</span>
<span class="sb">    &lt;title&gt;City Search Tutorial&lt;/title&gt;</span>
<span class="sb">    &lt;/head&gt;</span>
<span class="sb">    &lt;body&gt;</span>
<span class="sb">    &lt;div id=&quot;main&quot;&gt;</span>
<span class="sb">      &lt;form id=&quot;mf&quot;&gt;</span>
<span class="sb">          &lt;div id=&quot;idiv&quot;&gt;</span>
<span class="sb">              &lt;input type=&quot;text&quot; id=&quot;cstextbox&quot; name=&quot;q&quot; value=&quot;%s&quot; placeholder=&quot;Search for a city&quot;&gt;</span>
<span class="sb">          &lt;/div&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">      &lt;div id=&quot;res&quot;&gt;`</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">pageBottom</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="sb">`&lt;/div&gt;&lt;/body&gt;&lt;script&gt;</span>
<span class="sb">%w</span>
<span class="sb">&lt;/script&gt;&lt;/html&gt;`</span><span class="p">,</span> <span class="nx">client_script</span><span class="p">);</span>
</pre></div>
</div>
<p>The variable <code class="docutils literal notranslate"><span class="pre">pageTopFmt</span></code> is set to a basic web page with a form and text box for
searching.  The format code <code class="docutils literal notranslate"><span class="pre">&quot;%s'</span></code> in the input text box will be filled
with the current query.  Note because this is a format string, all other
literal percent signs (<code class="docutils literal notranslate"><span class="pre">%</span></code>) must be escaped as <code class="docutils literal notranslate"><span class="pre">%%</span></code>.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">pageBottom,</span> <span class="pre">we</span> <span class="pre">will</span> <span class="pre">include</span> <span class="pre">our</span> <span class="pre">client-side</span> <span class="pre">JavaScript</span> <span class="pre">from</span> <span class="pre">the</span>
<span class="pre">variable</span> <span class="pre">``client_script</span></code>.</p>
<p>Note the use of the format code <code class="docutils literal notranslate"><span class="pre">%w</span></code>.  This removes leading white space
so that our source can be indented, but we don’t send unneeded white space
to the client.</p>
<p>We will use the text input in the form to search for cities and load the
nearest cities, displaying the results in the <code class="docutils literal notranslate"><span class="pre">&lt;div</span> <span class="pre">id=&quot;res&quot;&gt;&lt;/div&gt;</span></code> div
at the bottom of the page.</p>
<p>Next we need to fill in our actual functions that deliver the HTML as well
as JSON via AJAX for a type-ahead search.</p>
</div>
<div class="section" id="the-nearest-city-results">
<h3>The Nearest City Results<a class="headerlink" href="#the-nearest-city-results" title="Permalink to this headline">¶</a></h3>
<p>The main page is delivered via normal HTTP request and returns results
formatted as HTML.  It will display the nearest 30 cities to the one set in
the query string parameter <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
<p>To do so, we need to construct an appropriate SQL statement that
looks up our city by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">place</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span>
<span class="k">FROM</span> <span class="n">cities</span> <span class="k">WHERE</span>
<span class="n">id</span><span class="o">=?</span><span class="p">;</span>
</pre></div>
</div>
<p>After retrieving the latitude and longitude of the current city,
we will need another SQL statement to find the closest cities to
it.  Here, <code class="docutils literal notranslate"><span class="pre">?lat</span></code>/<code class="docutils literal notranslate"><span class="pre">?lon</span></code> correspond to the latitude and longitude
retrieved from the above SQL statement, while <code class="docutils literal notranslate"><span class="pre">latitude</span></code>/<code class="docutils literal notranslate"><span class="pre">longitude</span></code>
correspond to the latitude and longitude in the currently selected
row.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
<span class="n">place</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span>
<span class="n">DISTLATLON</span><span class="p">(</span><span class="o">?</span><span class="n">lat</span><span class="p">,</span> <span class="o">?</span><span class="n">lon</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">)</span> <span class="n">dist</span><span class="p">,</span>
<span class="n">AZIMUTH2COMPASS</span><span class="p">(</span> <span class="n">AZIMUTHLATLON</span><span class="p">(</span><span class="o">?</span><span class="n">lat</span><span class="p">,</span> <span class="o">?</span><span class="n">lon</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">),</span> <span class="mi">3</span> <span class="p">)</span> <span class="n">heading</span>
<span class="k">FROM</span> <span class="n">cities</span> <span class="k">WHERE</span>
<span class="n">geocode</span> <span class="k">BETWEEN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">LATLON2GEOCODEAREA</span><span class="p">(</span><span class="o">?</span><span class="n">lat</span><span class="p">,</span> <span class="o">?</span><span class="n">lon</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">))</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">6</span> <span class="k">ASC</span><span class="p">;</span>
</pre></div>
</div>
<p>Taking it line by line:</p>
<p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code> - We are looking up and returning rows in the table.</p>
<p><code class="docutils literal notranslate"><span class="pre">place</span></code> - Our preformatted place name.</p>
<p><code class="docutils literal notranslate"><span class="pre">id,</span> <span class="pre">latitude,</span> <span class="pre">longitude,</span> <span class="pre">population</span></code> - Other columns we need.</p>
<p><code class="docutils literal notranslate"><span class="pre">DISTLATLON(?lat,</span> <span class="pre">?lon,</span> <span class="pre">latitude,</span> <span class="pre">longitude)</span> <span class="pre">dist</span></code> - The distance from our
current city to the one in this row.</p>
<p><code class="docutils literal notranslate"><span class="pre">AZIMUTH2COMPASS(</span> <span class="pre">AZIMUTHLATLON(?lat,</span> <span class="pre">?lon,</span> <span class="pre">latitude,</span> <span class="pre">longitude),</span> <span class="pre">3</span> <span class="pre">)</span> <span class="pre">heading</span></code>
– The heading (direction) from our current city to the one in this row.</p>
<p><code class="docutils literal notranslate"><span class="pre">FROM</span> <span class="pre">cities</span> <span class="pre">WHERE</span></code> - The name of the table, and <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> for the
search on the next line.</p>
<p><code class="docutils literal notranslate"><span class="pre">geocode</span> <span class="pre">BETWEEN</span> <span class="pre">(SELECT</span> <span class="pre">LATLON2GEOCODEAREA(?lat,</span> <span class="pre">?lon,</span> <span class="pre">1.0))</span></code> - select
only rows within a certain dist from <code class="docutils literal notranslate"><span class="pre">lat</span></code>/<code class="docutils literal notranslate"><span class="pre">lon</span></code> (one degree).</p>
<p><code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">6</span> <span class="pre">ASC</span></code> – order by the 6th selected field in the SQL statement. In
this case that is <code class="docutils literal notranslate"><span class="pre">dist</span></code>.</p>
<p>With that, we can write the function to find the closest cities to
<code class="docutils literal notranslate"><span class="pre">?id=&lt;cityid&gt;</span></code> and format the results in HTML.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">useKilometers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">distconv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;miles&quot;</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">useKilometers</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">distconv</span><span class="o">=</span><span class="mf">1.60934</span><span class="p">;</span>
    <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;kilometers&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">htmlpage</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">;</span>

    <span class="c1">// check if we already have a place id.</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
        <span class="nx">id_res</span><span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;SELECT place, latitude, longitude &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;FROM cities WHERE id=?;&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
        <span class="p">);</span>
        <span class="c1">// yes, then set lat,lon vars</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id_res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lon</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
            <span class="nx">lat</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// no, just print the blank search form</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>  <span class="c1">// add top of page to return buffer without a query.</span>
        <span class="k">return</span><span class="p">({</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">});</span>  <span class="c1">// add bottom of page, return with &#39;content-type:text/html&#39;</span>
    <span class="p">}</span>

    <span class="c1">// what to do if the query_string id is not found in the db</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">lon</span> <span class="o">||</span> <span class="o">!</span><span class="nx">lat</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;No entry for id &quot;%s&quot;.&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        <span class="k">return</span><span class="p">({</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/* here we select rows based on their distance from the place specified by &#39;id&#39;,</span>
<span class="cm">       calculate the distance and direction between id and the selected city,</span>
<span class="cm">       then sort by the distance from &#39;id&#39; (field 6 in our sql statement) */</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place, id, latitude, longitude, population,</span>
<span class="sb">        DISTLATLON(?lat, ?lon, latitude, longitude) dist,</span>
<span class="sb">        AZIMUTH2COMPASS( AZIMUTHLATLON(?lat, ?lon, latitude, longitude), 3 ) heading</span>
<span class="sb">        FROM cities WHERE geocode BETWEEN (SELECT LATLON2GEOCODEAREA(?lat, ?lon, 1.0))</span>
<span class="sb">        ORDER BY 6 ASC;`</span><span class="p">,</span>
        <span class="p">{</span><span class="nx">lat</span><span class="o">:</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="o">:</span><span class="nx">lon</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:</span> <span class="mi">31</span><span class="p">},</span> <span class="c1">// first row is same city</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// foreach city retrieved:</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// this is our &#39;id&#39; city, as it is closest to itself.</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">);</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;h3 style=&quot;margin-bottom:0px&quot;&gt;%s&lt;/h3&gt;&lt;ul style=&quot;margin-top:0px&quot;&gt;&#39;</span><span class="p">,</span><span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// all other nearby cities we will print the direction and distance:</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;?id=%s&quot;&gt;%s&lt;/a&gt;&lt;br&gt;&lt;ul&gt;&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;&lt;li&gt;Direction:  %.2f %s to the %s&lt;/li&gt;&#39;</span><span class="p">,</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">dist</span> <span class="o">*</span> <span class="nx">distconv</span><span class="p">,</span> <span class="nx">distvar</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">heading</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// some useful information to go along with the city name</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;&lt;li&gt;Population: %s&lt;/li&gt;&quot;</span> <span class="o">+</span>
                <span class="s1">&#39;&lt;li&gt;Location: &lt;a target=&quot;_blank&quot; href=&quot;https://maps.google.com/maps?z=11&amp;q=%U&amp;ll=%f,%f&quot;&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;google maps (%.4f,%.4f)&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&#39;</span><span class="p">,</span>
                <span class="nx">Sql</span><span class="p">.</span><span class="nx">stringFormat</span><span class="p">(</span><span class="s1">&#39;%ki&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">population</span><span class="p">),</span> <span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">longitude</span> <span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="nx">req</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;&lt;hr&gt;&lt;h3&gt;Closest Cities:&lt;/h3&gt;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">};</span> <span class="c1">//pageBottom is added to same buffer as is used with req.printf()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Also added is the variable <code class="docutils literal notranslate"><span class="pre">useKilometers</span></code>, which will
flag the conversion of miles to kilometers.</p>
</div>
<div class="section" id="the-auto-complete-results">
<h3>The Auto-Complete Results<a class="headerlink" href="#the-auto-complete-results" title="Permalink to this headline">¶</a></h3>
<p>The ajax portion of the script allows for suggestions/type-ahead
to be displayed in the HTML text box, making it easier to find
a city name.  This is done over an AJAX request, returning JSON to the
<code class="docutils literal notranslate"><span class="pre">jQuery-Autocomplete</span></code> script included in the HTML from CloudFlare.</p>
<p>First step will be to construct our SQL statement and query in order
to get a list of cities that are closest to a city or lat/lon requested.</p>
<p>When we made our Fulltext indexes on our table, we used the field <code class="docutils literal notranslate"><span class="pre">place</span></code>
for the primary search and <code class="docutils literal notranslate"><span class="pre">alt_names</span></code> for a follow-up search, if
necessary.</p>
<p>Our first search uses the following SQL</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">place</span> <span class="n">value</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">population</span>
<span class="k">FROM</span> <span class="n">cities</span> <span class="k">WHERE</span>
<span class="n">place</span> <span class="n">LIKE3</span> <span class="o">?</span> <span class="p">;</span>
</pre></div>
</div>
<p>Taking it line by line:</p>
<p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code> - We are looking up and returning rows in the table.</p>
<p><code class="docutils literal notranslate"><span class="pre">place</span></code> - Our preformatted place name.</p>
<p><code class="docutils literal notranslate"><span class="pre">id,</span> <span class="pre">latitude,</span> <span class="pre">longitude,</span> <span class="pre">population</span></code> - Other columns we need.</p>
<p><code class="docutils literal notranslate"><span class="pre">FROM</span> <span class="pre">cities</span> <span class="pre">WHERE</span></code> - The name of the table, and <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> for the
search on the next line.</p>
<p><code class="docutils literal notranslate"><span class="pre">place</span></code>
- Specifying the field upon which the Fulltext index is build.</p>
<p><code class="docutils literal notranslate"><span class="pre">LIKE3</span></code> - This signifies a Fulltext search where word positions are
<strong>not</strong> significant.  Usually <code class="docutils literal notranslate"><span class="pre">LIKEP</span></code> will be your most used type of
<code class="docutils literal notranslate"><span class="pre">like</span></code> search for normal Fulltext queries.  However, here we made an index
without word positions and are pre-sort by population.  Thus <code class="docutils literal notranslate"><span class="pre">LIKE3</span></code> is
appropriate.  See <a class="reference internal" href="rampart-sql.html#fulltext-indexes"><span class="std std-ref">The documentation</span></a>
for more information.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">?</span></code> corresponds to a variable we will give <code class="docutils literal notranslate"><span class="pre">sql.exec()</span></code>, as explained below.</p>
<p>The second SQL statement will be similar except it searches against the <code class="docutils literal notranslate"><span class="pre">alt_names</span></code>
column should no match be found in the first query.</p>
<p>Finally the results are formatted as required by <code class="docutils literal notranslate"><span class="pre">jQuery-Autocomplete</span></code>
and returned to the client as JSON.</p>
<p>We will also format the incoming query to allow for a partial string match.
Using the example of <code class="docutils literal notranslate"><span class="pre">be</span></code> as a search, our script will add a <code class="docutils literal notranslate"><span class="pre">*</span></code> to it
and pass it to <code class="docutils literal notranslate"><span class="pre">sql.exec()</span></code>.</p>
<p>Texis’ Fulltext search will first search its index for all words beginning
with <code class="docutils literal notranslate"><span class="pre">be</span></code> and add them to the query.  Since this could potentially be
thousands of words added to our query, we need to make a few adjustments to
the default limits.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
    <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
    <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                            <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
<span class="p">});</span>
</pre></div>
</div>
<p>We also want to continue to ignore noise words.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
    <span class="nx">noiseList</span>      <span class="o">:</span> <span class="p">[],</span>    <span class="c1">// allow search for &#39;the&#39;, &#39;us&#39;, &#39;or&#39;, etc.</span>
    <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
    <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                            <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Our completed AJAX function now looks like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// For autocomp. This needs to be set only once</span>
<span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
    <span class="nx">noiseList</span>      <span class="o">:</span> <span class="p">[],</span>    <span class="c1">// allow search for &#39;the&#39;, &#39;us&#39;, &#39;or&#39;, etc.</span>
    <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
    <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                            <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
<span class="p">});</span>

<span class="cm">/* autocomp() results must be formatted as such:</span>
<span class="cm">{</span>
<span class="cm">    &quot;suggestions&quot;: [</span>
<span class="cm">        {&quot;value&quot;:&quot;Vaulion, Canton de Vaud, CH&quot;,&quot;id&quot;:&quot;6233eaf65bd&quot;,&quot;latitude&quot;:46.6848,&quot;longitude&quot;:6.3832, ...},</span>
<span class="cm">        {&quot;value&quot;:&quot;Vallorbe, Canton de Vaud, CH&quot;,&quot;id&quot;:&quot;6233eaf65c6&quot;,&quot;latitude&quot;:46.7078,&quot;longitude&quot;:6.3714, ...},</span>
<span class="cm">        ...</span>
<span class="cm">    ]</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

    <span class="c1">// remove any spaces at the beginning of q</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

    <span class="c1">// if query is only one char, return an empty set</span>
    <span class="c1">//   (even though client-side autocomplete is set to 2 char min)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="p">[]}}</span>

    <span class="c1">// we will need at least two chars in our last word since it will get a &#39;*&#39; wildcard added to it</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ \S$/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>

    <span class="c1">// if last character is not a space, add wildcard</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nx">q</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>

    <span class="c1">// perform a like3 (no rank) pre-sorted by pop text search, and return a list of best matching locations</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;SELECT place value, id, latitude, longitude, population FROM cities WHERE &quot;</span><span class="o">+</span>
                    <span class="s2">&quot;place LIKE3 ? ;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">q</span><span class="p">]</span> <span class="p">);</span>

    <span class="c1">//if no results, try again using alt_names</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">rowCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;SELECT place value, alt_names,id, latitude, longitude, population FROM cities WHERE &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;alt_names LIKE3 ? ;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">q</span><span class="p">]</span> <span class="p">);</span>
        <span class="c1">// add alt name to &quot;value&quot; for type ahead display</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">ql</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">anames</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">alt_names</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">anames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">aname</span> <span class="o">=</span> <span class="nx">anames</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">aname</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ql</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">row</span><span class="p">.</span><span class="nx">value</span> <span class="o">+=</span> <span class="s1">&#39; (aka: &#39;</span> <span class="o">+</span>  <span class="nx">aname</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">}};</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-complete-server-side-script">
<h3>The Complete Server-Side Script<a class="headerlink" href="#the-complete-server-side-script" title="Permalink to this headline">¶</a></h3>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>

<span class="kd">var</span> <span class="nx">useKilometers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">distconv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;miles&quot;</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">useKilometers</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">distconv</span><span class="o">=</span><span class="mf">1.60934</span><span class="p">;</span>
    <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;kilometers&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">htmlpage</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">;</span>

    <span class="c1">// check if we already have a place id.</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
        <span class="nx">id_res</span><span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;SELECT place, latitude, longitude &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;FROM cities WHERE id=?;&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
        <span class="p">);</span>
        <span class="c1">// yes, then set lat,lon vars</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id_res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lon</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
            <span class="nx">lat</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// no, just print the blank search form</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>  <span class="c1">// add top of page to return buffer without a query.</span>
        <span class="k">return</span><span class="p">({</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">});</span>  <span class="c1">// add bottom of page, return with &#39;content-type:text/html&#39;</span>
    <span class="p">}</span>

    <span class="c1">// what to do if the query_string id is not found in the db</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">lon</span> <span class="o">||</span> <span class="o">!</span><span class="nx">lat</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;No entry for id &quot;%s&quot;.&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        <span class="k">return</span><span class="p">({</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/* here we select rows based on their distance from the place specified by &#39;id&#39;,</span>
<span class="cm">       calculate the distance and direction between id and the selected city,</span>
<span class="cm">       then sort by the distance from &#39;id&#39; (field 6 in our sql statement) */</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place, id, latitude, longitude, population,</span>
<span class="sb">        DISTLATLON(?lat, ?lon, latitude, longitude) dist,</span>
<span class="sb">        AZIMUTH2COMPASS( AZIMUTHLATLON(?lat, ?lon, latitude, longitude), 3 ) heading</span>
<span class="sb">        FROM cities WHERE geocode BETWEEN (SELECT LATLON2GEOCODEAREA(?lat, ?lon, 1.0))</span>
<span class="sb">        ORDER BY 6 ASC;`</span><span class="p">,</span>
        <span class="p">{</span><span class="nx">lat</span><span class="o">:</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="o">:</span><span class="nx">lon</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:</span> <span class="mi">31</span><span class="p">},</span> <span class="c1">// first row is same city</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// foreach city retrieved:</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// this is our &#39;id&#39; city, as it is closest to itself.</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">);</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;h3 style=&quot;margin-bottom:0px&quot;&gt;%s&lt;/h3&gt;&lt;ul style=&quot;margin-top:0px&quot;&gt;&#39;</span><span class="p">,</span><span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// all other nearby cities we will print the direction and distance:</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;?id=%s&quot;&gt;%s&lt;/a&gt;&lt;br&gt;&lt;ul&gt;&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;&lt;li&gt;Direction:  %.2f %s to the %s&lt;/li&gt;&#39;</span><span class="p">,</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">dist</span> <span class="o">*</span> <span class="nx">distconv</span><span class="p">,</span> <span class="nx">distvar</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">heading</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// some useful information to go along with the city name</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;&lt;li&gt;Population: %s&lt;/li&gt;&quot;</span> <span class="o">+</span>
                <span class="s1">&#39;&lt;li&gt;Location: &lt;a target=&quot;_blank&quot; href=&quot;https://maps.google.com/maps?z=11&amp;q=%U&amp;ll=%f,%f&quot;&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;google maps (%.4f,%.4f)&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&#39;</span><span class="p">,</span>
                <span class="nx">Sql</span><span class="p">.</span><span class="nx">stringFormat</span><span class="p">(</span><span class="s1">&#39;%ki&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">population</span><span class="p">),</span> <span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">longitude</span> <span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="nx">req</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;&lt;hr&gt;&lt;h3&gt;Closest Cities:&lt;/h3&gt;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">};</span> <span class="c1">//pageBottom is added to same buffer as is used with req.printf()</span>
<span class="p">}</span>

<span class="c1">// For autocomp. This needs to be set only once</span>
<span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
    <span class="nx">noiseList</span>      <span class="o">:</span> <span class="p">[],</span>    <span class="c1">// allow search for &#39;the&#39;, &#39;us&#39;, &#39;or&#39;, etc.</span>
    <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
    <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                            <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
<span class="p">});</span>

<span class="cm">/* autocomp() results must be formatted as such:</span>
<span class="cm">{</span>
<span class="cm">    &quot;suggestions&quot;: [</span>
<span class="cm">        {&quot;value&quot;:&quot;Vaulion, Canton de Vaud, CH&quot;,&quot;id&quot;:&quot;6233eaf65bd&quot;,&quot;latitude&quot;:46.6848,&quot;longitude&quot;:6.3832, ...},</span>
<span class="cm">        {&quot;value&quot;:&quot;Vallorbe, Canton de Vaud, CH&quot;,&quot;id&quot;:&quot;6233eaf65c6&quot;,&quot;latitude&quot;:46.7078,&quot;longitude&quot;:6.3714, ...},</span>
<span class="cm">        ...</span>
<span class="cm">    ]</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

    <span class="c1">// remove any spaces at the beginning of q</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

    <span class="c1">// if query is only one char, return an empty set</span>
    <span class="c1">//   (even though client-side autocomplete is set to 2 char min)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="p">[]}}</span>

    <span class="c1">// we will need at least two chars in our last word since it will get a &#39;*&#39; wildcard added to it</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ \S$/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>

    <span class="c1">// if last character is not a space, add wildcard</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nx">q</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>

    <span class="c1">// perform a like3 (no rank) pre-sorted by pop text search, and return a list of best matching locations</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;SELECT place value, id, latitude, longitude, population FROM cities WHERE &quot;</span><span class="o">+</span>
                    <span class="s2">&quot;place LIKE3 ? ;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">q</span><span class="p">]</span> <span class="p">);</span>

    <span class="c1">//if no results, try again using alt_names</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">rowCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;SELECT place value, alt_names,id, latitude, longitude, population FROM cities WHERE &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;alt_names LIKE3 ? ;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">q</span><span class="p">]</span> <span class="p">);</span>
        <span class="c1">// add alt name to &quot;value&quot; for type ahead display</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">ql</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">anames</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">alt_names</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">anames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">aname</span> <span class="o">=</span> <span class="nx">anames</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">aname</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ql</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">row</span><span class="p">.</span><span class="nx">value</span> <span class="o">+=</span> <span class="s1">&#39; (aka: &#39;</span> <span class="o">+</span>  <span class="nx">aname</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">}};</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-complete-script">
<h2>The Complete Script<a class="headerlink" href="#the-complete-script" title="Permalink to this headline">¶</a></h2>
<p>We now have all we need to perform the autocomplete search and nearest
city search.  This is the final script which, as layed out may be accessed
at <code class="docutils literal notranslate"><span class="pre">http://localhost:8088/apps/citysearch/</span></code>.  It will also build the
database when run from the command line as <code class="docutils literal notranslate"><span class="pre">rampart</span> <span class="pre">citysearch.js</span></code>.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// cuz no one likes writing out &#39;rampart.utils.printf()&#39;</span>
<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Sql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="s2">&quot;~/citysearch/web_server/data/cities&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">csvFile</span> <span class="o">=</span> <span class="s2">&quot;../data/geonames-all-cities-with-a-population-1000.csv&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">import_data</span><span class="p">(){</span>
    <span class="kd">function</span> <span class="nx">create_tmp_table</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table cities_tmp (&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Geoname_ID              varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Name                    varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;ASCII_Name              varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Alternate_Names         varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Feature_Class           varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Feature_Code            varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Country_Code            varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Country_name_EN         varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Country_Code_2          varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Admin1_Code             varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Admin2_Code             varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Admin3_Code             varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Admin4_Code             varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Population              int, &quot;</span>        <span class="o">+</span>
                <span class="s2">&quot;Elevation               int, &quot;</span>        <span class="o">+</span>
                <span class="s2">&quot;Digital_Elevation_Model int, &quot;</span>        <span class="o">+</span>
                <span class="s2">&quot;Timezone                varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Modification_date       varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;LABEL_EN                varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;Coordinates             varchar(8)&quot;</span>   <span class="o">+</span>
                <span class="s2">&quot;);&quot;</span>  <span class="p">);</span>
    <span class="p">}</span>


    <span class="kd">var</span> <span class="nx">total</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//we won&#39;t know the total until we finish the first pass of importCsvFile</span>
    <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//set in importCsvFile(), only report every 100th row</span>

    <span class="cm">/* a single function to monitor the import for both pre-processing (progressFunc)</span>
<span class="cm">       and import (callback function supplied to sql.importCsvFile as a paramater)   */</span>
    <span class="kd">function</span> <span class="nx">monitor_import</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stg</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stage</span> <span class="o">=</span> <span class="s2">&quot;Import&quot;</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">stg</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">)</span> <span class="c1">// progressfunc</span>
            <span class="nx">stage</span><span class="o">=</span><span class="nx">stg</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">stg</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//differentiate between 0 and undefined</span>
        <span class="p">{</span>
            <span class="nx">total</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span> <span class="c1">//update our total in the first stage.</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d       \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d of %d      \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">import_csv</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">total</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">importCsvFile</span><span class="p">(</span>
            <span class="nx">csvFile</span><span class="p">,</span>  <span class="c1">//file to import</span>
            <span class="p">{</span>
                <span class="nx">tableName</span><span class="o">:</span>       <span class="s1">&#39;cities_tmp&#39;</span><span class="p">,</span>
                <span class="nx">singleQuoteNest</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">hasHeaderRow</span><span class="o">:</span>    <span class="kc">true</span><span class="p">,</span>
                <span class="nx">delimiter</span><span class="o">:</span>       <span class="s1">&#39;;&#39;</span><span class="p">,</span>
                <span class="nx">normalize</span><span class="o">:</span>       <span class="kc">false</span><span class="p">,</span>
                <span class="nx">callbackStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//callback run every 100th row</span>
                <span class="nx">progressStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//progressfunc run every 100th row for each stage</span>
                <span class="nx">progressFunc</span><span class="o">:</span>    <span class="nx">monitor_import</span> <span class="c1">//progress function while processing csv</span>
            <span class="p">},</span>
            <span class="nx">monitor_import</span> <span class="c1">//callback function upon actual import</span>
        <span class="p">);</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n%d rows in total.\n&#39;</span><span class="p">,</span><span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">create_final_table</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table cities (&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;id                      counter, &quot;</span>    <span class="o">+</span>
                <span class="s2">&quot;place                   varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;alt_names               varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;population              int, &quot;</span>        <span class="o">+</span>
                <span class="s2">&quot;latitude                double, &quot;</span>     <span class="o">+</span>
                <span class="s2">&quot;longitude           double, &quot;</span>     <span class="o">+</span>
                <span class="s2">&quot;geocode             long, &quot;</span>       <span class="o">+</span>
                <span class="s2">&quot;timezone                varchar(8), &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;country                 varchar(8) &quot;</span>  <span class="o">+</span>
                <span class="s2">&quot;);&quot;</span>  <span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">makerow</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ret</span><span class="o">=</span><span class="p">{},</span> <span class="nx">tmp</span><span class="p">;</span>

        <span class="nx">ret</span><span class="p">.</span><span class="nx">place</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%s, %s %s(%s)&#39;</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Admin1_Code</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_name_EN</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_Code</span><span class="p">);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">altNames</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Alternate_Names</span><span class="p">;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">population</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Population</span><span class="p">;</span>
        <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Coordinates</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">lat</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">lon</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">tz</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Timezone</span><span class="p">;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">country</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Country_name_EN</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">build_final_table</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;sorting rows\n&quot;</span><span class="p">);</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;select * from cities_tmp order by Population DESC&quot;</span><span class="p">,</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;done\nCreating Final Table\n&quot;</span><span class="p">);</span>

                <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="nx">makerow</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
                <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;insert into cities values( &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;counter, ?place, ?altNames, ?population, ?lat, ?lon, latlon2geocode(?lat, ?lon), ?tz, ?country );&quot;</span><span class="p">,</span>
                    <span class="nx">vals</span> <span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="nx">i</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d of %d\r&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
                    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span><span class="nx">maxRows</span><span class="o">:-</span><span class="mi">1</span><span class="p">}</span>
        <span class="p">);</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">make_geocode_index</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on geocode\n&quot;</span><span class="p">);</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index cities_geocode_x on cities(geocode) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">make_id_index</span><span class="p">(){</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on id\n&quot;</span><span class="p">);</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index cities_id_x on cities(id) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">make_text_indexes</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating indexes on place names\n&quot;</span><span class="p">);</span>

        <span class="c1">// noiselist as detailed at https://rampart.dev/docs/sql-set.html#noiselist</span>
        <span class="c1">// This is not English text and some geographic abbreviations like OR IN DO TO SO and US</span>
        <span class="c1">// are also on the noise words list.  Setting to empty will allow such words in the index.</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">noiseList</span><span class="o">:</span><span class="p">[]});</span>

        <span class="c1">// make compact index.  Sorting by population, not by likep rank.  See like3 search below.</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create fulltext index cities_place_ftx on cities(place)&quot;</span><span class="o">+</span>
            <span class="s2">&quot; WITH WORDEXPRESSIONS (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;) INDEXMETER &#39;on&#39; WORDPOSITIONS &#39;off&#39;;&quot;</span><span class="p">);</span>

        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create fulltext index cities_altNames_ftx on cities(alt_names)&quot;</span><span class="o">+</span>
            <span class="s2">&quot; WITH WORDEXPRESSIONS (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;) INDEXMETER &#39;on&#39; WORDPOSITIONS &#39;off&#39;;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">drop_tmp_table</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;drop table cities_tmp&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">create_tmp_table</span><span class="p">();</span>
    <span class="nx">import_csv</span><span class="p">();</span>
    <span class="nx">create_final_table</span><span class="p">();</span>
    <span class="nx">build_final_table</span><span class="p">();</span>
    <span class="nx">make_geocode_index</span><span class="p">();</span>
    <span class="nx">make_id_index</span><span class="p">();</span>
    <span class="nx">make_text_indexes</span><span class="p">();</span>
    <span class="nx">drop_tmp_table</span><span class="p">();</span>

<span class="p">}</span>

<span class="kd">var</span> <span class="nx">useKilometers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">distconv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;miles&quot;</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">useKilometers</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">distconv</span><span class="o">=</span><span class="mf">1.60934</span><span class="p">;</span>
    <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;kilometers&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// the autocomplete plugin from  https://github.com/devbridge/jQuery-Autocomplete</span>
<span class="c1">// jquery and plugin included from cloudflare in &lt;script src=&quot;xyz&quot;&gt; tags below in pageTopFmt.</span>
<span class="kd">var</span> <span class="nx">client_script</span> <span class="o">=</span> <span class="sb">`</span>
<span class="sb">$(document).ready(function(){</span>
<span class="sb">    $(&#39;#cstextbox&#39;).autocomplete(</span>
<span class="sb">        {</span>
<span class="sb">            serviceUrl: &#39;/apps/citysearch/autocomp.json&#39;,</span>
<span class="sb">            minChars: 2,</span>
<span class="sb">            autoSelectFirst: true,</span>
<span class="sb">            showNoSuggestionNotice: true,</span>
<span class="sb">            triggerSelectOnValidInput: false,</span>
<span class="sb">            onSelect: function(sel) { window.location.assign(&quot;./?id=&quot;+sel.id); }</span>
<span class="sb">        }</span>
<span class="sb">    );</span>

<span class="sb">    $(&#39;#cstextbox&#39;).on(&#39;keypress&#39;, function(e){</span>
<span class="sb">        var key = e.charCode || e.keyCode || 0;</span>
<span class="sb">        if (key == 13) {       // on &lt;return&gt; don&#39;t submit form</span>
<span class="sb">            e.preventDefault();</span>
<span class="sb">            return false;</span>
<span class="sb">        }</span>
<span class="sb">    });</span>
<span class="sb">});</span>
<span class="sb">`</span><span class="p">;</span>

<span class="c1">// pageTopFmt is defined once upon script load here rather than upon each request in</span>
<span class="c1">// htmlpage() below. format code %w removes leading white space.</span>
<span class="kd">var</span> <span class="nx">pageTopFmt</span><span class="o">=</span><span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%w&#39;</span><span class="p">,</span><span class="sb">`&lt;!DOCTYPE HTML&gt;</span>
<span class="sb">&lt;html&gt;</span>
<span class="sb">    &lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;style&gt;</span>
<span class="sb">        body,h1,h2,h3,h4,h5,h6 {font-family: &quot;Varela Round&quot;, Sans-Serif;}</span>
<span class="sb">        .autocomplete-suggestions {border: 1px solid #999; background: #FFF; overflow: auto; width: auto !important; padding-right:5px;}</span>
<span class="sb">        .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }</span>
<span class="sb">        .autocomplete-suggestions strong {font-weight: normal; color: #3399FF; }</span>
<span class="sb">        .autocomplete-group strong { display: block; border-bottom: 1px solid #000; }</span>
<span class="sb">        .autocomplete-selected { background: #F0F0F0; }</span>
<span class="sb">        .autocomplete-group { padding: 2px 5px; }</span>
<span class="sb">        #main {background-color: white;margin: auto;min-height: 300px;width: 600px;}</span>
<span class="sb">        #idiv { width:500px;height:39px;border-bottom: lightGray 1px solid;padding:15px 0px 15px 0px;}</span>
<span class="sb">        #cstextbox {min-width:150px;width:100%%;height:30px;font:normal 18px arial,sans-serif;padding: 1px 3px;border: 2px solid #ccc;box-sizing: bord</span>
<span class="sb">    &lt;/style&gt;</span>
<span class="sb">    &lt;title&gt;City Search Tutorial&lt;/title&gt;</span>
<span class="sb">    &lt;/head&gt;</span>
<span class="sb">    &lt;body&gt;</span>
<span class="sb">    &lt;div id=&quot;main&quot;&gt;</span>
<span class="sb">      &lt;form id=&quot;mf&quot;&gt;</span>
<span class="sb">          &lt;div id=&quot;idiv&quot;&gt;</span>
<span class="sb">              &lt;input type=&quot;text&quot; id=&quot;cstextbox&quot; name=&quot;q&quot; value=&quot;%s&quot; placeholder=&quot;Search for a city&quot;&gt;</span>
<span class="sb">          &lt;/div&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">      &lt;div id=&quot;res&quot;&gt;`</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">pageBottom</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="sb">`&lt;/div&gt;&lt;/body&gt;&lt;script&gt;</span>
<span class="sb">%w</span>
<span class="sb">&lt;/script&gt;&lt;/html&gt;`</span><span class="p">,</span> <span class="nx">client_script</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">htmlpage</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="p">;</span>

    <span class="c1">// check if we already have a place id.</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
        <span class="nx">id_res</span><span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;SELECT place, latitude, longitude &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;FROM cities WHERE id=?;&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
        <span class="p">);</span>
        <span class="c1">// yes, then set lat,lon vars</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id_res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lon</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">longitude</span><span class="p">;</span>
            <span class="nx">lat</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// no, just print the blank search form</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>  <span class="c1">// add top of page to return buffer without a query.</span>
        <span class="k">return</span><span class="p">({</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">});</span>  <span class="c1">// add bottom of page, return with &#39;content-type:text/html&#39;</span>
    <span class="p">}</span>

    <span class="c1">// what to do if the query_string id is not found in the db</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">lon</span> <span class="o">||</span> <span class="o">!</span><span class="nx">lat</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;No entry for id &quot;%s&quot;.&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        <span class="k">return</span><span class="p">({</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/* here we select rows based on their distance from the place specified by &#39;id&#39;,</span>
<span class="cm">       calculate the distance and direction between id and the selected city,</span>
<span class="cm">       then sort by the distance from &#39;id&#39; (field 6 in our sql statement) */</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place, id, latitude, longitude, population,</span>
<span class="sb">        DISTLATLON(?lat, ?lon, latitude, longitude) dist,</span>
<span class="sb">        AZIMUTH2COMPASS( AZIMUTHLATLON(?lat, ?lon, latitude, longitude), 3 ) heading</span>
<span class="sb">        FROM cities WHERE geocode BETWEEN (SELECT LATLON2GEOCODEAREA(?lat, ?lon, 1.0))</span>
<span class="sb">        ORDER BY 6 ASC;`</span><span class="p">,</span>
        <span class="p">{</span><span class="nx">lat</span><span class="o">:</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="o">:</span><span class="nx">lon</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:</span> <span class="mi">31</span><span class="p">},</span> <span class="c1">// first row is same city</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// foreach city retrieved:</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// this is our &#39;id&#39; city, as it is closest to itself.</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">pageTopFmt</span><span class="p">,</span><span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">);</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;h3 style=&quot;margin-bottom:0px&quot;&gt;%s&lt;/h3&gt;&lt;ul style=&quot;margin-top:0px&quot;&gt;&#39;</span><span class="p">,</span><span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// all other nearby cities we will print the direction and distance:</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;?id=%s&quot;&gt;%s&lt;/a&gt;&lt;br&gt;&lt;ul&gt;&#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;&lt;li&gt;Direction:  %.2f %s to the %s&lt;/li&gt;&#39;</span><span class="p">,</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">dist</span> <span class="o">*</span> <span class="nx">distconv</span><span class="p">,</span> <span class="nx">distvar</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">heading</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// some useful information to go along with the city name</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;&lt;li&gt;Population: %s&lt;/li&gt;&quot;</span> <span class="o">+</span>
                <span class="s1">&#39;&lt;li&gt;Location: &lt;a target=&quot;_blank&quot; href=&quot;https://maps.google.com/maps?z=11&amp;q=%U&amp;ll=%f,%f&quot;&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;google maps (%.4f,%.4f)&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&#39;</span><span class="p">,</span>
                <span class="nx">Sql</span><span class="p">.</span><span class="nx">stringFormat</span><span class="p">(</span><span class="s1">&#39;%ki&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">population</span><span class="p">),</span> <span class="nx">res</span><span class="p">.</span><span class="nx">place</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">longitude</span> <span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">longitude</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="nx">req</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;&lt;hr&gt;&lt;h3&gt;Closest Cities:&lt;/h3&gt;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">html</span><span class="o">:</span><span class="nx">pageBottom</span><span class="p">};</span> <span class="c1">//pageBottom is added to same buffer as is used with req.printf()</span>
<span class="p">}</span>

<span class="c1">// For autocomp. This needs to be set only once</span>
<span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
    <span class="nx">noiseList</span>      <span class="o">:</span> <span class="p">[],</span>    <span class="c1">// allow search for &#39;the&#39;, &#39;us&#39;, &#39;or&#39;, etc.</span>
    <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
    <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                            <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
<span class="p">});</span>

<span class="cm">/* autocomp() results must be formatted as such:</span>
<span class="cm">{</span>
<span class="cm">    &quot;suggestions&quot;: [</span>
<span class="cm">        {&quot;value&quot;:&quot;Vaulion, Canton de Vaud, CH&quot;,&quot;id&quot;:&quot;6233eaf65bd&quot;,&quot;latitude&quot;:46.6848,&quot;longitude&quot;:6.3832, ...},</span>
<span class="cm">        {&quot;value&quot;:&quot;Vallorbe, Canton de Vaud, CH&quot;,&quot;id&quot;:&quot;6233eaf65c6&quot;,&quot;latitude&quot;:46.7078,&quot;longitude&quot;:6.3714, ...},</span>
<span class="cm">        ...</span>
<span class="cm">    ]</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

    <span class="c1">// remove any spaces at the beginning of q</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

    <span class="c1">// if query is only one char, return an empty set</span>
    <span class="c1">//   (even though client-side autocomplete is set to 2 char min)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="p">[]}}</span>

    <span class="c1">// we will need at least two chars in our last word since it will get a &#39;*&#39; wildcard added to it</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ \S$/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>

    <span class="c1">// if last character is not a space, add wildcard</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nx">q</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>

    <span class="c1">// perform a like3 (no rank) pre-sorted by pop text search, and return a list of best matching locations</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;SELECT place value, id, latitude, longitude, population FROM cities WHERE &quot;</span><span class="o">+</span>
                    <span class="s2">&quot;place LIKE3 ? ;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">q</span><span class="p">]</span> <span class="p">);</span>

    <span class="c1">//if no results, try again using alt_names</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">rowCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;SELECT place value, alt_names,id, latitude, longitude, population FROM cities WHERE &quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;alt_names LIKE3 ? ;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">q</span><span class="p">]</span> <span class="p">);</span>
        <span class="c1">// add alt name to &quot;value&quot; for type ahead display</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="kd">var</span> <span class="nx">ql</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">anames</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">alt_names</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">anames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">aname</span> <span class="o">=</span> <span class="nx">anames</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">aname</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ql</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">row</span><span class="p">.</span><span class="nx">value</span> <span class="o">+=</span> <span class="s1">&#39; (aka: &#39;</span> <span class="o">+</span>  <span class="nx">aname</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">}};</span>
<span class="p">}</span>

<span class="c1">// module and module.exports are set when called from the webserver</span>
<span class="k">if</span><span class="p">(</span><span class="nx">module</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// url to function mapping</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;/&quot;</span><span class="o">:</span>               <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/</span>
        <span class="s2">&quot;/index.html&quot;</span><span class="o">:</span>     <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/index.html</span>
        <span class="s2">&quot;/autocomp.json&quot;</span><span class="o">:</span>  <span class="nx">autocomp</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/autocomp.json</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// called from the command line.  Build the database.</span>
    <span class="nx">import_data</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Enjoy.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorial-wschat.html" class="btn btn-neutral float-right" title="Using Websockets to Build a Chat" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorialtoc.html" class="btn btn-neutral" title="Tutorials" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, Moat Crossing Systems.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.2.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>