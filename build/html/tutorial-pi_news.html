

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Building a Pi News Aggregator &mdash; Rampart 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="_static/hacks.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Rampart 0.1.0 documentation" href="index.html"/>
        <link rel="up" title="Tutorials" href="tutorialtoc.html"/>
        <link rel="prev" title="Using Websockets to Build a Chat" href="tutorial-wschat.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Rampart
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="rampart-main.html">Rampart JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-utils.html">Rampart Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="sqltoc.html">The rampart-sql module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-server.html">The rampart-server module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-html.html">The rampart-html module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-crypto.html">The rampart-crypto module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-curl.html">The rampart-curl module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-lmdb.html">The rampart-lmdb module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-redis.html">The rampart-redis module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-robots.html">The rampart-robots module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-cmark.html">The rampart-cmark module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-url.html">The rampart-url module</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorialtoc.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tutorial-citysearch.html">Find Cities and their Closest Neighbors</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial-wschat.html">Using Websockets to Build a Chat</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Building a Pi News Aggregator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preface">Preface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#concepts">Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-started">Getting Started</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#web-server-layout">Web Server Layout</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-aggregator">The Aggregator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#examining-the-external-sites">Examining the External Sites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-the-table">Defining the Table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parsing-the-index-page-html">Parsing The Index Page HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inserting-new-urls-into-the-table">Inserting New URLs into the Table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-first-run-grabbing-the-index-pages">The First Run - Grabbing the Index Pages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-runs-grabbing-new-article-urls">Update Runs - Grabbing New Article URLs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-content">Updating Content</a></li>
<li class="toctree-l4"><a class="reference internal" href="#processing-the-articles">Processing the Articles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-final-aggregator-script">The Final Aggregator Script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#client-side-script">Client-Side Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#improvements">Improvements</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Rampart</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorialtoc.html">Tutorials</a> &raquo;</li>
        
      <li>Building a Pi News Aggregator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorial-pi_news.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="building-a-pi-news-aggregator">
<h1>Building a Pi News Aggregator<a class="headerlink" href="#building-a-pi-news-aggregator" title="Permalink to this headline">¶</a></h1>
<div class="section" id="preface">
<h2>Preface<a class="headerlink" href="#preface" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we will use  <a class="reference internal" href="rampart-curl.html#the-rampart-curl-module"><span class="std std-ref">rampart-curl</span></a>
, the <a class="reference internal" href="rampart-sql.html#preface"><span class="std std-ref">rampart-sql</span></a>, the
<a class="reference internal" href="rampart-html.html#the-rampart-html-module"><span class="std std-ref">rampart-html</span></a>,
the <cite>rampart-robots &lt;rampart-robots:The rampart-robots module&gt;</cite>,
the <a class="reference internal" href="rampart-url.html#the-rampart-url-module"><span class="std std-ref">rampart-url</span></a> and the
<a class="reference internal" href="rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">rampart-server</span></a>
modules.  With these we will grab the latest articles from three Raspberry
Pi news sites, process them and build or update a SQL database which will
be used for a landing page and a search.</p>
<p>You can download the complete project from our
<a class="reference external" href="https://github.com/aflin/rampart_tutorials">Tutorial Repository</a> in the
<a class="reference external" href="https://github.com/aflin/rampart_tutorials/tree/main/pi_news">pi_news directory</a>.</p>
<div class="section" id="license">
<h3>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h3>
<p>The code related to this tutorial is released under the MIT license.</p>
</div>
</div>
<div class="section" id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<p>This module will demonstrate:</p>
<ul class="simple">
<li><p>Using <a class="reference internal" href="rampart-curl.html#the-rampart-curl-module"><span class="std std-ref">rampart-curl</span></a> to grab
articles over http.</p></li>
<li><p>Using <a class="reference internal" href="rampart-robots.html#the-rampart-robots-module"><span class="std std-ref">rampart-robots</span></a> to
comply with <a class="reference external" href="https://developers.google.com/search/docs/advanced/robots/intro">robots.txt exclusions</a>.</p></li>
<li><p>Using <a class="reference internal" href="rampart-html.html#the-rampart-html-module"><span class="std std-ref">rampart-html</span></a> to
find article links, images and the main article content.</p></li>
<li><p>Using <a class="reference internal" href="rampart-url.html#the-rampart-url-module"><span class="std std-ref">rampart-url</span></a> to
normalize links extracted from html pages.</p></li>
<li><p>Using <a class="reference internal" href="rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">rampart-server</span></a>
to build a full text searchable database.</p></li>
</ul>
<p>In order to complete this tutorial, you should have basic knowledge of
JavaScript, HTML and SQL.</p>
</div>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<div class="section" id="web-server-layout">
<h3>Web Server Layout<a class="headerlink" href="#web-server-layout" title="Permalink to this headline">¶</a></h3>
<p>In the Rampart binary distribution is a sample web server tree.  For our
purposes here, we assume you have downloaded and unzipped the Rampart binary
distribution into a directory named <code class="docutils literal notranslate"><span class="pre">~/downloads/rampart</span></code>. We will use
that for this project.
The <a class="reference internal" href="rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">The rampart-server HTTP module</span></a>
is configured and loaded from the included <code class="docutils literal notranslate"><span class="pre">web_server/web_server_conf.js</span></code>
script.  It defines <code class="docutils literal notranslate"><span class="pre">web_server/html</span></code> as the default directory for static
html, <code class="docutils literal notranslate"><span class="pre">web_server/apps</span></code> as the default directory for scripts.</p>
<p>To get started, copy the <code class="docutils literal notranslate"><span class="pre">web_server</span></code> directory to a convenient place for
this project.  Also, for our purposes, we do not need
anything in the <code class="docutils literal notranslate"><span class="pre">web_server/apps/test_modules</span></code> or
<code class="docutils literal notranslate"><span class="pre">web_server/apps/wsapps</span></code> directories, so you can delete the copy of those
files. We will also add an empty file at
<code class="docutils literal notranslate"><span class="pre">web_server/wsapps/wschat.js</span></code> and <code class="docutils literal notranslate"><span class="pre">web_server/html/websockets_chat/index.html</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>user@localhost:~$ mkdir pi_news
user@localhost:~$ cd pi_news
user@localhost:~/pi_news$ touch pi_news_aggregator.js
user@localhost:~/pi_news$ cp -a ~/downloads/rampart/web_server ./
user@localhost:~/pi_news$ cd web_server/
user@localhost:~/pi_news/web_server$ rm -rf apps/test_modules wsapps/* html/index.html
user@localhost:~/pi_news/web_server$ mkdir apps/pi_news
user@localhost:~/pi_news/web_server$ touch apps/pi_news/search.js
user@localhost:~/pi_news/web_server$ find .
./wsapps
./start_server.sh
./stop_server.sh
./logs
./apps
./apps/pi_news
./apps/pi_news/search.js
./web_server_conf.js
./html
./html/images
./html/images/inigo-not-fount.jpg
./html/websockets_chat
./html/websockets_chat/index.html
./data
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-aggregator">
<h2>The Aggregator<a class="headerlink" href="#the-aggregator" title="Permalink to this headline">¶</a></h2>
<p>Let’s start with a skeleton script with the needed modules loaded by editing
the <code class="docutils literal notranslate"><span class="pre">pi_news_aggregator.js</span></code> file:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/local/bin/rampart</span>

<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Sql</span>    <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">curl</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-curl&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">html</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-html&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">robots</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-robots&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">urlutil</span><span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-url&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">dbdir</span>  <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">scriptPath</span> <span class="o">+</span> <span class="s2">&quot;/web_server/data/pi_news&quot;</span>

<span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">dbdir</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// The date format we are expecting from http servers</span>
<span class="kd">var</span> <span class="nx">dateFmt</span> <span class="o">=</span> <span class="s2">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">crawlDelay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  <span class="c1">// go slow - delay in seconds between fetches from same site.</span>

<span class="c1">// Columns for our table</span>
<span class="c1">// status, fetch_count, server_date, fetch_date, site, url, img_url, title, text</span>
<span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="s2">&quot;status smallint, fetch_count smallint, server_date date, fetch_date date, &quot;</span> <span class="o">+</span>
             <span class="s2">&quot;site varchar(8), url varchar(64), img_url varchar(64), title varchar(64), &quot;</span> <span class="o">+</span>
             <span class="s2">&quot;text varchar(1024)&quot;</span><span class="p">;</span>

<span class="c1">// running in two stages - first gets all articles from several pages</span>
<span class="c1">//                       - second gets latest articles from main page</span>
<span class="c1">// First stage is done by running with command line argument &#39;--first-run&#39;</span>
<span class="kd">var</span> <span class="nx">firstRun</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;--first-run&#39;</span> <span class="p">)</span>
    <span class="nx">firstRun</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">sites</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">// the names of our sites.</span>
<span class="kd">var</span> <span class="nx">sitenames</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">sites</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// process the index page holding links to articles</span>
<span class="kd">function</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">docBody</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// update a row of data in our table</span>
<span class="kd">function</span> <span class="nx">update_row</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// insert a new row into our table</span>
<span class="kd">function</span> <span class="nx">insert_row</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// check for new articles in the main index page (sites[].url)</span>
<span class="kd">function</span> <span class="nx">check_new_articles</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// on first run, get main index page and a few more index pages</span>
<span class="kd">function</span> <span class="nx">first_run</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// get relevant text and info from article html</span>
<span class="kd">function</span> <span class="nx">procpage</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">dbrow</span><span class="p">,</span> <span class="nx">fetch_res</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">//fetch, process and update table</span>
<span class="kd">function</span> <span class="nx">fetch_article</span><span class="p">(</span><span class="nx">sitename</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">// get article pages</span>
<span class="kd">function</span> <span class="nx">fetch_all_articles</span><span class="p">(){</span>
<span class="p">}</span>

<span class="c1">// get index pages</span>
<span class="k">if</span><span class="p">(</span><span class="nx">firstRun</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">first_run</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">check_new_articles</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// get article pages</span>
<span class="nx">fetch_all_articles</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="examining-the-external-sites">
<h3>Examining the External Sites<a class="headerlink" href="#examining-the-external-sites" title="Permalink to this headline">¶</a></h3>
<p>In order to parse the html to extract links, images and content, we need to
have a peek at the each site’s structure.  This is the portion of the script
which we will need to keep up to date if any of the sites we are scraping
change their format.  But in short, we want to know:</p>
<ul class="simple">
<li><p>The URL of the index page with the links to the latest articles.</p></li>
<li><p>The format of the URL for more of these page, for older content.</p></li>
<li><p>How many of these extra pages to fetch on our first run.</p></li>
<li><p>How to locate the links to articles and, if present, images from within
the index page.</p></li>
<li><p>How to locate the relevant content (and possibly an image link) within the
article pages themselves.</p></li>
<li><p>How to remove unwanted content inside our extracted “relevant content”.</p></li>
</ul>
<p>So, without going into great detail, we will define all of these in our
<code class="docutils literal notranslate"><span class="pre">sites</span></code> <span class="green">Object</span>.  In this case, the relevant HTML tags can be
found using CSS class names:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/* details of each scrape:</span>
<span class="cm">    url                - the index page with links to the latest articles</span>
<span class="cm">    urlNextFmt         - more index pages with links to articles</span>
<span class="cm">    initialPages       - how many pages with links to articles to grab on first run</span>
<span class="cm">    entryClass         - the CSS class of the element holding article links, for index pages</span>
<span class="cm">    entryImgClass      - the CSS class of the element on the index pages with a related image</span>
<span class="cm">    contentClass       - on article page, the CSS of element that holds most relevant text</span>
<span class="cm">    contentImgClass    - the CSS class of the element on the content pages with a related image</span>
<span class="cm">    contentRemoveClass - the CSS class of elements on the content pages inside contentClass that should be removed</span>
<span class="cm">*/</span>

<span class="kd">var</span> <span class="nx">sites</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;hackaday&quot;</span><span class="o">:</span>
    <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;hackaday&quot;</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;https://hackaday.com/category/raspberry-pi-2/&quot;</span><span class="p">,</span>
        <span class="nx">urlNextFmt</span><span class="o">:</span> <span class="s2">&quot;https://hackaday.com/category/raspberry-pi-2/page/%d/&quot;</span><span class="p">,</span>
        <span class="nx">initialPages</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="nx">entryClass</span><span class="o">:</span> <span class="s2">&quot;entry-featured-image&quot;</span><span class="p">,</span>
        <span class="nx">contentImgClass</span><span class="o">:</span> <span class="s2">&quot;entry-featured-image&quot;</span><span class="p">,</span>
        <span class="nx">contentClass</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span>
    <span class="p">},</span>
    <span class="s2">&quot;raspberrypi&quot;</span><span class="o">:</span>
    <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;raspberrypi&quot;</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;https://www.raspberrypi.com/news/&quot;</span><span class="p">,</span>
        <span class="nx">urlNextFmt</span><span class="o">:</span> <span class="s2">&quot;https://www.raspberrypi.com/news/page/%d/&quot;</span><span class="p">,</span>
        <span class="nx">initialPages</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="nx">entryClass</span><span class="o">:</span> <span class="s2">&quot;c-blog-post-card__link&quot;</span><span class="p">,</span>
        <span class="nx">entryImgClass</span><span class="o">:</span> <span class="s2">&quot;c-blog-post-card__image&quot;</span><span class="p">,</span>
        <span class="nx">contentClass</span><span class="o">:</span> <span class="s2">&quot;c-blog-post-content&quot;</span><span class="p">,</span>
        <span class="nx">contentRemoveClass</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;c-blog-post-content__footer&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;makeuseof&quot;</span><span class="o">:</span>
    <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;makeuseof&quot;</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;https://www.makeuseof.com/search/raspberry%20pi/&quot;</span><span class="p">,</span>
        <span class="nx">urlNextFmt</span><span class="o">:</span> <span class="s2">&quot;https://www.makeuseof.com/search/raspberry%%20pi/%d/&quot;</span><span class="p">,</span>
        <span class="nx">initialPages</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="nx">entryClass</span><span class="o">:</span> <span class="s2">&quot;bc-title-link&quot;</span><span class="p">,</span>
        <span class="nx">entryImgClass</span><span class="o">:</span> <span class="s2">&quot;bc-img&quot;</span><span class="p">,</span>
        <span class="nx">contentClass</span><span class="o">:</span> <span class="s2">&quot;article&quot;</span><span class="p">,</span>
        <span class="nx">contentRemoveClass</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;sidebar&quot;</span><span class="p">,</span> <span class="s2">&quot;next-btn&quot;</span><span class="p">,</span> <span class="s2">&quot;sharing&quot;</span><span class="p">,</span> <span class="s2">&quot;letter-from&quot;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now that we have the basic information for each site, we need to set up a
polite way of fetching content, respecting robots.txt.  We will make a
<code class="docutils literal notranslate"><span class="pre">fetch()</span></code> function that automatically does this for us.  Since all HTTP
status codes are positive and greater than 100, (i.e.  <code class="docutils literal notranslate"><span class="pre">200</span></code>), we will use
codes less than 100 for errors related to the fetch, and later store the
code in our table.</p>
<p>In this function, we will load the robots.txt file for each site only once, and
then use it with each new url from that site to check if crawling is allowed.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// status &lt; 0 -- try or retry</span>
<span class="c1">// status &gt; 0 -- don&#39;t retry</span>
<span class="c1">// status = 0 -- first try</span>
<span class="c1">// status &gt; 0 and &lt; 100 - custom codes</span>
<span class="kd">var</span> <span class="nx">statTexts</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;Disallowed by robots.txt&quot;</span><span class="p">,</span>
<span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="s2">&quot;Cannot parse Url&quot;</span><span class="p">,</span>
<span class="s2">&quot;-1&quot;</span><span class="o">:</span> <span class="s2">&quot;Error retrieving robots.txt&quot;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">robotstxt</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">//load these once per run</span>
<span class="kd">var</span> <span class="nx">userAgent</span> <span class="o">=</span> <span class="s2">&quot;rampart_tutorial&quot;</span><span class="p">;</span>  <span class="c1">//our identification</span>

<span class="c1">// fetch with robots.txt check</span>
<span class="kd">function</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">comp</span> <span class="o">=</span> <span class="nx">urlutil</span><span class="p">.</span><span class="nx">components</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">res</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">comp</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">statusText</span><span class="o">:</span> <span class="nx">statTexts</span><span class="p">[</span><span class="mi">2</span><span class="p">]};</span>

    <span class="nx">origin</span><span class="o">=</span><span class="nx">comp</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">])</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">rurl</span> <span class="o">=</span> <span class="nx">origin</span> <span class="o">+</span> <span class="s1">&#39;/robots.txt&#39;</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;fetching %s\r&quot;</span><span class="p">,</span> <span class="nx">rurl</span><span class="p">);</span>
        <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>

        <span class="c1">// body is a buffer.  robots.isAllowed also takes a buffer, so we can dispense with text.</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">curl</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">rurl</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="o">:</span> <span class="nx">userAgent</span><span class="p">,</span> <span class="nx">returnText</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d    - %s\n&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">rurl</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="o">==</span><span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">]</span><span class="o">=</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// there are other possibilities not covered here</span>
            <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">statusText</span><span class="o">:</span> <span class="nx">statTexts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]};</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// if there is a robots.txt, and this url is disallowed, return status=1</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">]</span><span class="o">!=-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">robots</span><span class="p">.</span><span class="nx">isAllowed</span><span class="p">(</span><span class="nx">userAgent</span><span class="p">,</span> <span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">],</span> <span class="nx">url</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">statusText</span><span class="o">:</span> <span class="nx">statTexts</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
    <span class="p">}</span>

    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;fetching %s\r&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">curl</span><span class="p">.</span><span class="nx">fetch</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="o">:</span> <span class="nx">userAgent</span><span class="p">,</span> <span class="nx">returnText</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d    - %s\n&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;</span> <span class="mi">499</span><span class="p">)</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">//return negative on serve error, so we will retry</span>

    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-the-table">
<h3>Defining the Table<a class="headerlink" href="#defining-the-table" title="Permalink to this headline">¶</a></h3>
<p>Defining a schema for the table usually requires a bit of foresight to know
exactly the data you need saved, and how it will be accessed.  If we wanted
to be very flexible, we could include a JSON field in our table, but for the
purposes of this tutorial, that won’t be necessary.</p>
<p>We know we will want a way to uniquely identify each entry.  Since each
entry corresponds to a specific URL, we will have that covered just by
including the URL of the article (which we would do in any case).  We also
want to save the site name and the status code returned from our <code class="docutils literal notranslate"><span class="pre">fetch()</span></code>
function.  In addition, we will be extracting the article’s title, a related
image URL and, of course, the article text.</p>
<p>Other items we may want in the future include the date we fetched the
article, the date of the article as returned by the server (we’ll do both)
and the actual HTML of the article (which we will not do in this example).
Saving the HTML in case we make a mistake or the format changes in the
future is a wise strategy for anything beyond a demo as it allows you to
correct a potentially bad situation without having to re-fetch many pages.</p>
<p>So we will make a schema, plus a couple of functions to create the table
and the indicies on them.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Columns for our table</span>
<span class="c1">// status, fetch_count, server_date, fetch_date, site, url, img_url, title, text</span>
<span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="s2">&quot;status smallint, fetch_count smallint, server_date date, fetch_date date, &quot;</span> <span class="o">+</span>
             <span class="s2">&quot;site varchar(8), url varchar(64), img_url varchar(64), title varchar(64), &quot;</span> <span class="o">+</span>
             <span class="s2">&quot;text varchar(1024)&quot;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">create_table</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// create using schema</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`create table pipages (</span><span class="si">${</span><span class="nx">schema</span><span class="si">}</span><span class="sb">);`</span><span class="p">);</span>
    <span class="c1">// unique index on url, so we don&#39;t have duplicates</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;create unique index pipages_url_ux on pipages(url);&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">    Regular indexes are updated on each insert/update.</span>
<span class="cm">    Text indexes, however, need to be manually updated.</span>
<span class="cm">      -  When a new row is inserted, it still is available for search,</span>
<span class="cm">         but that search is a linear scan of the document, so it is slower.</span>
<span class="cm">      -  A text index can be updated with either:</span>
<span class="cm">          1) sql.exec(&quot;alter index pipages_text_ftx OPTIMIZE&quot;);</span>
<span class="cm">              or</span>
<span class="cm">          2) issuing the same command that created the index as in make_index() below.</span>
<span class="cm">         Here we will issue the same command when creating and updating for simplicity.</span>
<span class="cm">*/</span>

<span class="kd">function</span> <span class="nx">make_index</span><span class="p">(){</span>
    <span class="c1">// we want to match &quot;Check out the new pi 4.&quot; if we search for &quot;pi 4&quot;</span>
    <span class="c1">// so we add an expression for [\s\,]\d+[\s,\.] (in PERLRE), but only matching the number(s)</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span>
        <span class="s2">&quot;create fulltext index pipages_text_ftx on pipages(text) &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;WITH WORDEXPRESSIONS &quot;</span><span class="o">+</span>
        <span class="s2">&quot;(&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;, &#39;[\\space\\,]\\P=\\digit+\\F[\\space,\\.]=&#39;) &quot;</span><span class="o">+</span>
        <span class="s2">&quot;INDEXMETER &#39;on&#39;&quot;</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>We separate the creation of the <code class="docutils literal notranslate"><span class="pre">fulltext</span></code> index into its own function since it will be
run each time we update the content.</p>
</div>
<div class="section" id="parsing-the-index-page-html">
<h3>Parsing The Index Page HTML<a class="headerlink" href="#parsing-the-index-page-html" title="Permalink to this headline">¶</a></h3>
<p>We now need to fetch the use the data stored in <code class="docutils literal notranslate"><span class="pre">sites</span></code> to find links to
the articles and images in the index page of each site.  To that end, we
will use the following function to find the class of the element (or one of
its child elements) that contains the <code class="docutils literal notranslate"><span class="pre">href</span></code> and/or <code class="docutils literal notranslate"><span class="pre">src</span></code> of the
article URL or image URL we need.</p>
<p>Note that the extraction of the image URLs is perhaps not as tidy as we
might like.  MakeUseOf stores it in <code class="docutils literal notranslate"><span class="pre">&lt;source&gt;</span></code> tags, and for HackADay, it
is easier to get the image URL from the article itself.  So we will have to
make accommidations in our function.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// process the index page holding links to articles</span>
<span class="kd">function</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">docBody</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">newDocument</span><span class="p">(</span><span class="nx">docBody</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">entryClass</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">images</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">entryImgClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">images</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">entryImgClass</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">insertRows</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">row</span><span class="o">=</span><span class="p">{</span><span class="nx">site</span><span class="o">:</span> <span class="nx">site</span><span class="p">.</span><span class="nx">name</span><span class="p">};</span>
        <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">atag</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">hasTag</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nx">atag</span><span class="o">=</span><span class="nx">entry</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nx">atag</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>

        <span class="nx">row</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">atag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">urlutil</span><span class="p">.</span><span class="nx">absUrl</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">row</span><span class="p">.</span><span class="nx">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">images</span> <span class="o">&amp;&amp;</span> <span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">images</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">);</span> <span class="c1">//makeuseof</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">imgtag</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">srcset</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;data-srcset&quot;</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">srcset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">srcset</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;srcset&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">srcset</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
                        <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">=</span> <span class="nx">srcset</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//raspberrypi</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">hasTag</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">);</span>

                    <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">);</span>

                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">&amp;&amp;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
                <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">insertRows</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">insertRows</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>What we get in return is a <span class="green">Array</span> of <span class="green">Objects</span>, each object
with properties that match the column names of our table.  Naming the
properties of the <span class="green">Objects</span> the same as the column names will make
for easy inserts and updates of records.</p>
</div>
<div class="section" id="inserting-new-urls-into-the-table">
<h3>Inserting New URLs into the Table<a class="headerlink" href="#inserting-new-urls-into-the-table" title="Permalink to this headline">¶</a></h3>
<p>We have some of the columns for each row in the return value of
<code class="docutils literal notranslate"><span class="pre">procIndex()</span></code> but there are several missing ones.  We will need to fill
those in with blanks that will be updated when we actually get the article.
To do that, we will start with an empty <span class="green">Object</span>, add parameters and
blank values from <code class="docutils literal notranslate"><span class="pre">empty_params</span></code>, then overwrite the empty values with the
parameters we in have <code class="docutils literal notranslate"><span class="pre">data</span></code>, all using <code class="docutils literal notranslate"><span class="pre">Object.assign()</span></code> function.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">//properties we need in the substitution parameters object when doing an insert</span>
<span class="kd">var</span> <span class="nx">empty_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">status</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">fetch_count</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">server_date</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">fetch_date</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">img_url</span><span class="o">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">text</span><span class="o">:</span><span class="s2">&quot;&quot;</span>
<span class="p">}</span>

<span class="c1">// insert a new row into our table</span>
<span class="kd">function</span> <span class="nx">insert_row</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dfilled</span> <span class="o">=</span> <span class="p">{};</span>                     <span class="c1">// start with empty object</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">dfilled</span><span class="p">,</span> <span class="nx">empty_params</span><span class="p">);</span> <span class="c1">// add default empty params</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">dfilled</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>         <span class="c1">// overwrite params with what we have</span>

    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;insert into pipages values &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;(?status, ?fetch_count, ?server_date, ?fetch_date, ?site, ?url, ?img_url, ?title, ?text);&quot;</span><span class="p">,</span>
        <span class="nx">dfilled</span>
    <span class="p">);</span>

    <span class="c1">// if duplicate, sql.errMsg will be set with &quot;duplicate value&quot; message and res.rowCount == 0</span>
    <span class="c1">// Checking res.rowCount first is likely faster</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">rowCount</span> <span class="o">&amp;&amp;</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;Trying to insert duplicate value&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">isDup</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>
        <span class="c1">// remove sql.errMsg</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-first-run-grabbing-the-index-pages">
<h3>The First Run - Grabbing the Index Pages<a class="headerlink" href="#the-first-run-grabbing-the-index-pages" title="Permalink to this headline">¶</a></h3>
<p>The first time we run the script, we will need to create our database
and the unique index on <code class="docutils literal notranslate"><span class="pre">url</span></code>, and then grab the index pages and
subsequent pages to populate our database with a fair number of
recent articles (50-60 each).</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// get single key response without \n</span>
<span class="kd">function</span> <span class="nx">getresp</span><span class="p">(</span><span class="nx">def</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="p">(</span><span class="nx">len</span><span class="p">)</span><span class="o">?</span> <span class="nx">len</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">stdin</span><span class="p">.</span><span class="nx">getchar</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">ret</span> <span class="o">==</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">def</span><span class="p">;</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// drop table if exists, but ask first</span>
<span class="kd">function</span> <span class="nx">clean_database</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;select * from SYSTABLES where NAME = &#39;pipages&#39;;&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;Table &quot;pipages&quot; exists. Drop it and delete all saved pages?\n [y/N]: &#39;</span><span class="p">);</span>
        <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span> <span class="c1">//flush text after \n</span>
        <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">getresp</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">);</span> <span class="c1">//default no</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">resp</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;drop table pipages;&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Error dropping table:\n%s&quot;</span><span class="p">,</span><span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">);</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// on first run, get main index page and a few more index pages</span>
<span class="kd">function</span> <span class="nx">first_run</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">k</span><span class="p">;</span>

    <span class="nx">clean_database</span><span class="p">();</span>
    <span class="nx">create_table</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span> <span class="nx">sitenames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="nx">sites</span><span class="p">[</span><span class="nx">sitenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
        <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>

        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Getting new article urls for %s\n&quot;</span><span class="p">,</span> <span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

        <span class="nx">res</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;error getting &#39;%s&#39;:\n    %s\n&quot;</span><span class="p">,</span> <span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// extract urls of articles</span>
        <span class="kd">var</span> <span class="nx">urllist</span> <span class="o">=</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="c1">// insert urls into table</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">urllist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">insert_row</span><span class="p">(</span><span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="c1">// go slow</span>
        <span class="nx">sleep</span><span class="p">(</span><span class="nx">crawlDelay</span><span class="p">);</span>

        <span class="c1">// get second and subsequent pages up to site.initialPages</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">k</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="nx">k</span><span class="o">&lt;=</span><span class="nx">site</span><span class="p">.</span><span class="nx">initialPages</span><span class="p">;</span><span class="nx">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">purl</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">urlNextFmt</span><span class="p">,</span> <span class="nx">k</span><span class="p">);</span>

            <span class="nx">res</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">purl</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;error getting &#39;%s&#39;:\n    %s\n&quot;</span><span class="p">,</span> <span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
                <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// extract urls of articles</span>
            <span class="kd">var</span> <span class="nx">urllist</span> <span class="o">=</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
            <span class="c1">// insert urls into table</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">urllist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">insert_row</span><span class="p">(</span><span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="p">}</span>

            <span class="c1">//sleep unless at end</span>
            <span class="k">if</span><span class="p">(</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">site</span><span class="p">.</span><span class="nx">initialPages</span><span class="p">)</span>
                <span class="nx">sleep</span><span class="p">(</span><span class="nx">crawlDelay</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal notranslate"><span class="pre">crawlDelay</span></code> variable.  The sites have allowed us to index their
content, however they may change their mind if they see in their logs that you
are grabbing multiple pages at once.  So it pays to be conservative.</p>
</div>
<div class="section" id="update-runs-grabbing-new-article-urls">
<h3>Update Runs - Grabbing New Article URLs<a class="headerlink" href="#update-runs-grabbing-new-article-urls" title="Permalink to this headline">¶</a></h3>
<p>Here we will check, perhaps after a day or two, if there are any new
articles.  Very similar to above, we will fetch <code class="docutils literal notranslate"><span class="pre">sites[i].url</span></code>
and extract URLs.  We’ll also print out some extra information
about the links we get.</p>
<p>Also remember we created a unique index on <code class="docutils literal notranslate"><span class="pre">url</span></code>, so we do not have to
worry about inserting the same url more than once.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// check for new articles in the main index page (sites[].url)</span>
<span class="kd">function</span> <span class="nx">check_new_articles</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// check that our table exists</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;select * from SYSTABLES where NAME = &#39;pipages&#39;;&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
            <span class="s1">&#39;Error: table &quot;pipages&quot; does not exist.\n&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;If this is the first time running this script, run it with\n&#39;</span> <span class="o">+</span>
            <span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="sb"> --first-run`</span>
       <span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span> <span class="nx">sitenames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="nx">sites</span><span class="p">[</span><span class="nx">sitenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
        <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>

        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Getting new article urls for %s\n&quot;</span><span class="p">,</span> <span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

        <span class="nx">res</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">urllist</span> <span class="o">=</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">urllist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;checking     %s - \r&quot;</span><span class="p">,</span> <span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">url</span><span class="p">)</span>
            <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">sqlres</span> <span class="o">=</span> <span class="nx">insert_row</span><span class="p">(</span><span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">sqlres</span><span class="p">.</span><span class="nx">isDup</span><span class="p">)</span>
                <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;exists:      %s\n&quot;</span><span class="p">,</span> <span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">url</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;NEW ARTICLE: %s\n&quot;</span><span class="p">,</span> <span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-content">
<h3>Updating Content<a class="headerlink" href="#updating-content" title="Permalink to this headline">¶</a></h3>
<p>Once we actually fetch and process articles, we will need to insert the
updated content into the table.  Since the results of each fetch will give
us a varying list of properties in <code class="docutils literal notranslate"><span class="pre">data</span></code>, we will make a function that will create an
appropriate SQL statement for the update.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// update a row of data in our table</span>
<span class="kd">function</span> <span class="nx">update_row</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

    <span class="c1">// build our &quot;set&quot; section of sql statement</span>
    <span class="c1">// based on what we have in *data*</span>
    <span class="c1">// should look like &quot;text=?text, title=?title, ...&quot;</span>
    <span class="kd">var</span> <span class="nx">sqlstr</span><span class="o">=</span><span class="s2">&quot;update pipages set &quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span>
            <span class="nx">sqlstr</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span><span class="o">+</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nx">sqlstr</span> <span class="o">+=</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">j</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// if we only have data.url, there&#39;s nothing to update</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">j</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;updating %s\n&quot;</span><span class="p">,</span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">sqlstr</span> <span class="o">+</span> <span class="s2">&quot; where url=?url;&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;sql update error, cannot continue:\n%s&quot;</span><span class="p">,</span><span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="processing-the-articles">
<h3>Processing the Articles<a class="headerlink" href="#processing-the-articles" title="Permalink to this headline">¶</a></h3>
<p>Once our Table has some URLs in it, we can go about the business of fetching
and processing them.  To fetch, we will continue to use our robots.txt
friendly <code class="docutils literal notranslate"><span class="pre">fetch()</span></code> function from within a new function called
<code class="docutils literal notranslate"><span class="pre">fetch_article()</span></code>.  That function will select articles to be fetched and
updated based on their <code class="docutils literal notranslate"><span class="pre">status</span></code>.</p>
<p>To process the HTML and extract the text, we will create a new function
called <code class="docutils literal notranslate"><span class="pre">procpage()</span></code> that will use the rampart-html module to extract
the title and text.</p>
<p>We will also put it all together with a
<code class="docutils literal notranslate"><span class="pre">setInterval()</span></code> in order to respect <code class="docutils literal notranslate"><span class="pre">crawlDelay</span></code> per each site in a
function called <code class="docutils literal notranslate"><span class="pre">fetch_all_articles()</span></code>.  That function will select
articles to be updated based on their <code class="docutils literal notranslate"><span class="pre">status</span></code>.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// get relevant text and info from article html</span>
<span class="kd">function</span> <span class="nx">procpage</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">dbrow</span><span class="p">,</span> <span class="nx">fetch_res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">url</span><span class="o">:</span><span class="nx">dbrow</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
        <span class="nx">fetch_date</span><span class="o">:</span><span class="s1">&#39;now&#39;</span><span class="p">,</span>
        <span class="nx">fetch_count</span><span class="o">:</span> <span class="nx">dbrow</span><span class="p">.</span><span class="nx">fetch_count</span> <span class="o">+</span><span class="mi">1</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">imgtag</span><span class="p">;</span>

    <span class="c1">// get server date</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">fetch_res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nb">Date</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">server_date</span> <span class="o">=</span> <span class="nx">scanDate</span><span class="p">(</span><span class="nx">fetch_res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nb">Date</span><span class="p">,</span> <span class="nx">dateFmt</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">fetch_res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">date</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">server_date</span> <span class="o">=</span> <span class="nx">scanDate</span><span class="p">(</span><span class="nx">fetch_res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span> <span class="nx">dateFmt</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">server_date</span> <span class="o">=</span> <span class="s1">&#39;now&#39;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">newDocument</span><span class="p">(</span><span class="nx">fetch_res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="c1">// the content is located in an element with CSS class *site.contentClass*</span>
    <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">contentClass</span><span class="p">);</span>

    <span class="c1">// remove from content items we don&#39;t want</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">contentRemoveClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">site</span><span class="p">.</span><span class="nx">contentRemoveClass</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">content</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span> <span class="nx">site</span><span class="p">.</span><span class="nx">contentRemoveClass</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">).</span><span class="k">delete</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// makeuseof has an easier to grab image in the article</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">contentImgClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">image</span><span class="o">=</span><span class="nx">doc</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span> <span class="nx">site</span><span class="p">.</span><span class="nx">contentImgClass</span> <span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">hasTag</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">imgtag</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// extract the text from the content html</span>
    <span class="nx">row</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toText</span><span class="p">({</span><span class="nx">concatenate</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">titleText</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>

    <span class="c1">// find the &lt;title&gt; tag text</span>
    <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">title</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toText</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="nx">row</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// interval ID needed to cancel setInteral when all pages have been fetched;</span>
<span class="kd">var</span> <span class="nx">iId</span> <span class="o">=</span> <span class="p">{};</span>

<span class="c1">// status, fetch_count, server_date, fetch_date, site, url, img_url, text</span>

<span class="c1">//fetch, process and update table</span>
<span class="kd">function</span> <span class="nx">fetch_article</span><span class="p">(</span><span class="nx">sitename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">row</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;select * from pipages where site=? and status&lt;1 and fetch_count&lt;10 order by status DESC&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="nx">sitename</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%s is up to date\n&quot;</span><span class="p">,</span> <span class="nx">sitename</span><span class="p">);</span>
        <span class="c1">// no more pages to fetch, so cancel interval</span>
        <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">iId</span><span class="p">[</span><span class="nx">sitename</span><span class="p">]);</span>
        <span class="k">delete</span> <span class="nx">iId</span><span class="p">[</span><span class="nx">sitename</span><span class="p">];</span> <span class="c1">// get rid of entry so we know we are done with it</span>
        <span class="c1">// final action before script exits:</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">iId</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;updating fulltext index\n&quot;</span><span class="p">);</span>
            <span class="nx">make_index</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="nx">sites</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">site</span><span class="p">];</span>

    <span class="c1">// fetch the page</span>
    <span class="kd">var</span> <span class="nx">cres</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">cres</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span> <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// failed</span>
        <span class="nx">update_row</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span><span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
            <span class="nx">status</span><span class="o">:</span> <span class="nx">cres</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span>
            <span class="nx">fetch_count</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fetch_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// success</span>
        <span class="nx">row</span><span class="o">=</span><span class="nx">procpage</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">cres</span><span class="p">);</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">status</span><span class="o">=</span><span class="mi">200</span><span class="p">;</span>
        <span class="nx">update_row</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// get article pages asynchronously using setInterval</span>
<span class="kd">function</span> <span class="nx">fetch_all_articles</span><span class="p">(){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sitenames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="nx">sites</span><span class="p">[</span><span class="nx">sitenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>

        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;select * from pipages where site=? and status&lt;1 and fetch_count&lt;10 order by status DESC&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="nx">sitenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// only if we have some sites, otherwise we&#39;d waste crawlDelay seconds just to exit</span>

            <span class="c1">// this complicated mess is to make sure our *sitenames[i].name*</span>
            <span class="c1">// is scoped to the setInterval callback and stays the same</span>
            <span class="c1">// even as the *site* variable changes in subsequent *for* loops.</span>

            <span class="c1">// if you are unfamiliar with this technique and immediately invoked functions - see:</span>
            <span class="c1">// https://www.google.com/search?q=iife+settimeout</span>

            <span class="c1">// scope sitename in an IIFE</span>
            <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">sn</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">iId</span><span class="p">[</span><span class="nx">sn</span><span class="p">]</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span>
                    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">fetch_article</span><span class="p">(</span><span class="nx">sn</span><span class="p">);},</span>
                    <span class="nx">crawlDelay</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="p">);</span>
            <span class="p">})(</span><span class="nx">site</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

            <span class="cm">/* or use IIFE to return a function with sitename scoped. Result is the same.</span>
<span class="cm">            iId[site.name] = setInterval(</span>
<span class="cm">                (function(sn) {</span>
<span class="cm">                    return function() {</span>
<span class="cm">                        fetch_article(sn);</span>
<span class="cm">                    }</span>
<span class="cm">                })(site.name),</span>
<span class="cm">                crawlDelay * 1000</span>
<span class="cm">            );</span>
<span class="cm">            */</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-final-aggregator-script">
<h3>The Final Aggregator Script<a class="headerlink" href="#the-final-aggregator-script" title="Permalink to this headline">¶</a></h3>
<p>Putting everything above together, we end up with this script:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/local/bin/rampart</span>

<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Sql</span>    <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">curl</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-curl&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">html</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-html&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">robots</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-robots&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">urlutil</span><span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-url&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">dbdir</span>  <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">scriptPath</span> <span class="o">+</span> <span class="s2">&quot;/web_server/data/pi_news&quot;</span>

<span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">dbdir</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// The date format we are expecting from http servers</span>
<span class="kd">var</span> <span class="nx">dateFmt</span> <span class="o">=</span> <span class="s2">&quot;%a, %d %b %Y %H:%M:%S GMT&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">crawlDelay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  <span class="c1">// go slow - delay in seconds between fetches from same site.</span>

<span class="c1">// Columns for our table</span>
<span class="c1">// status, fetch_count, server_date, fetch_date, site, url, img_url, title, text</span>
<span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="s2">&quot;status smallint, fetch_count smallint, server_date date, fetch_date date, &quot;</span> <span class="o">+</span>
             <span class="s2">&quot;site varchar(8), url varchar(64), img_url varchar(64), title varchar(64), &quot;</span> <span class="o">+</span>
             <span class="s2">&quot;text varchar(1024)&quot;</span><span class="p">;</span>

<span class="c1">// running in two stages - first gets all articles from several index pages</span>
<span class="c1">//                       - second gets latest articles from main index page</span>
<span class="c1">// First stage is done by running with command line argument &#39;--first-run&#39;</span>
<span class="kd">var</span> <span class="nx">firstRun</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;--first-run&#39;</span> <span class="p">)</span>
    <span class="nx">firstRun</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>

<span class="cm">/* details of each scrape:</span>
<span class="cm">    url                - the index page with links to the latest articles</span>
<span class="cm">    urlNextFmt         - more index pages with links to articles</span>
<span class="cm">    initialPages       - how many pages with links to articles to grab on first run</span>
<span class="cm">    entryClass         - the CSS class of the element holding article links, for index pages</span>
<span class="cm">    entryImgClass      - the CSS class of the element on the index pages with a related image</span>
<span class="cm">    contentClass       - on article page, the CSS of element that holds most relevant text</span>
<span class="cm">    contentImgClass    - the CSS class of the element on the content pages with a related image</span>
<span class="cm">    contentRemoveClass - the CSS class of elements on the content pages inside contentClass that should be removed</span>
<span class="cm">*/</span>

<span class="kd">var</span> <span class="nx">sites</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;hackaday&quot;</span><span class="o">:</span>
    <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;hackaday&quot;</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;https://hackaday.com/category/raspberry-pi-2/&quot;</span><span class="p">,</span>
        <span class="nx">urlNextFmt</span><span class="o">:</span> <span class="s2">&quot;https://hackaday.com/category/raspberry-pi-2/page/%d/&quot;</span><span class="p">,</span>
        <span class="nx">initialPages</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="nx">entryClass</span><span class="o">:</span> <span class="s2">&quot;entry-featured-image&quot;</span><span class="p">,</span>
        <span class="nx">contentImgClass</span><span class="o">:</span> <span class="s2">&quot;entry-featured-image&quot;</span><span class="p">,</span>
        <span class="nx">contentClass</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span>
    <span class="p">},</span>
    <span class="s2">&quot;raspberrypi&quot;</span><span class="o">:</span>
    <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;raspberrypi&quot;</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;https://www.raspberrypi.com/news/&quot;</span><span class="p">,</span>
        <span class="nx">urlNextFmt</span><span class="o">:</span> <span class="s2">&quot;https://www.raspberrypi.com/news/page/%d/&quot;</span><span class="p">,</span>
        <span class="nx">initialPages</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="nx">entryClass</span><span class="o">:</span> <span class="s2">&quot;c-blog-post-card__link&quot;</span><span class="p">,</span>
        <span class="nx">entryImgClass</span><span class="o">:</span> <span class="s2">&quot;c-blog-post-card__image&quot;</span><span class="p">,</span>
        <span class="nx">contentClass</span><span class="o">:</span> <span class="s2">&quot;c-blog-post-content&quot;</span><span class="p">,</span>
        <span class="nx">contentRemoveClass</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;c-blog-post-content__footer&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;makeuseof&quot;</span><span class="o">:</span>
    <span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;makeuseof&quot;</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;https://www.makeuseof.com/search/raspberry%20pi/&quot;</span><span class="p">,</span>
        <span class="nx">urlNextFmt</span><span class="o">:</span> <span class="s2">&quot;https://www.makeuseof.com/search/raspberry%%20pi/%d/&quot;</span><span class="p">,</span>
        <span class="nx">initialPages</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="nx">entryClass</span><span class="o">:</span> <span class="s2">&quot;bc-title-link&quot;</span><span class="p">,</span>
        <span class="nx">entryImgClass</span><span class="o">:</span> <span class="s2">&quot;bc-img&quot;</span><span class="p">,</span>
        <span class="nx">contentClass</span><span class="o">:</span> <span class="s2">&quot;article&quot;</span><span class="p">,</span>
        <span class="nx">contentRemoveClass</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;sidebar&quot;</span><span class="p">,</span> <span class="s2">&quot;next-btn&quot;</span><span class="p">,</span> <span class="s2">&quot;sharing&quot;</span><span class="p">,</span> <span class="s2">&quot;letter-from&quot;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// the names of our sites.</span>
<span class="kd">var</span> <span class="nx">sitenames</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">sites</span><span class="p">);</span>

<span class="c1">// status &lt; 0 -- try or retry</span>
<span class="c1">// status &gt; 0 -- don&#39;t retry</span>
<span class="c1">// status = 0 -- first try</span>
<span class="c1">// status &gt; 0 and &lt; 100 - custom codes</span>
<span class="kd">var</span> <span class="nx">statTexts</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="s2">&quot;Disallowed by robots.txt&quot;</span><span class="p">,</span>
<span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="s2">&quot;Cannot parse Url&quot;</span><span class="p">,</span>
<span class="s2">&quot;-1&quot;</span><span class="o">:</span> <span class="s2">&quot;Error retrieving robots.txt&quot;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">robotstxt</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">//load these once per run</span>
<span class="kd">var</span> <span class="nx">userAgent</span> <span class="o">=</span> <span class="s2">&quot;rampart_tutorial&quot;</span><span class="p">;</span>  <span class="c1">//our identification</span>

<span class="c1">// fetch with robots.txt check</span>
<span class="kd">function</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">comp</span> <span class="o">=</span> <span class="nx">urlutil</span><span class="p">.</span><span class="nx">components</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">res</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">comp</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">statusText</span><span class="o">:</span> <span class="nx">statTexts</span><span class="p">[</span><span class="mi">2</span><span class="p">]};</span>

    <span class="nx">origin</span><span class="o">=</span><span class="nx">comp</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">])</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">rurl</span> <span class="o">=</span> <span class="nx">origin</span> <span class="o">+</span> <span class="s1">&#39;/robots.txt&#39;</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;fetching %s\r&quot;</span><span class="p">,</span> <span class="nx">rurl</span><span class="p">);</span>
        <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>

        <span class="c1">// body is a buffer.  robots.isAllowed also takes a buffer, so we can dispense with text.</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">curl</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">rurl</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="o">:</span> <span class="nx">userAgent</span><span class="p">,</span> <span class="nx">returnText</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d    - %s\n&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">rurl</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="o">==</span><span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">]</span><span class="o">=</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// there are other possibilities not covered here</span>
            <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">statusText</span><span class="o">:</span> <span class="nx">statTexts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]};</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// if there is a robots.txt, and this url is disallowed, return status=1</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">]</span><span class="o">!=-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">robots</span><span class="p">.</span><span class="nx">isAllowed</span><span class="p">(</span><span class="nx">userAgent</span><span class="p">,</span> <span class="nx">robotstxt</span><span class="p">[</span><span class="nx">origin</span><span class="p">],</span> <span class="nx">url</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">statusText</span><span class="o">:</span> <span class="nx">statTexts</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
    <span class="p">}</span>

    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;fetching %s\r&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">curl</span><span class="p">.</span><span class="nx">fetch</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="o">:</span> <span class="nx">userAgent</span><span class="p">,</span> <span class="nx">returnText</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">location</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d    - %s\n&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;</span> <span class="mi">499</span><span class="p">)</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">//return negative on serve error, so we will retry</span>

    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// process the index page holding links to articles</span>
<span class="kd">function</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">docBody</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">newDocument</span><span class="p">(</span><span class="nx">docBody</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">entryClass</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">images</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">entryImgClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">images</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">entryImgClass</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">insertRows</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">row</span><span class="o">=</span><span class="p">{</span><span class="nx">site</span><span class="o">:</span> <span class="nx">site</span><span class="p">.</span><span class="nx">name</span><span class="p">};</span>
        <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">atag</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">hasTag</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nx">atag</span><span class="o">=</span><span class="nx">entry</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nx">atag</span> <span class="o">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>

        <span class="nx">row</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">atag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">urlutil</span><span class="p">.</span><span class="nx">absUrl</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">row</span><span class="p">.</span><span class="nx">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">images</span> <span class="o">&amp;&amp;</span> <span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">images</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">);</span> <span class="c1">//makeuseof</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">imgtag</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">srcset</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;data-srcset&quot;</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">srcset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">srcset</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;srcset&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">srcset</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
                        <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">=</span> <span class="nx">srcset</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//raspberrypi</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">hasTag</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">);</span>

                    <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">);</span>

                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">&amp;&amp;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
                <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">insertRows</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">insertRows</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// get single key response without \n</span>
<span class="kd">function</span> <span class="nx">getresp</span><span class="p">(</span><span class="nx">def</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="p">(</span><span class="nx">len</span><span class="p">)</span><span class="o">?</span> <span class="nx">len</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">stdin</span><span class="p">.</span><span class="nx">getchar</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">ret</span> <span class="o">==</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">def</span><span class="p">;</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// drop table if exists, but ask first</span>
<span class="kd">function</span> <span class="nx">clean_database</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;select * from SYSTABLES where NAME = &#39;pipages&#39;;&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;Table &quot;pipages&quot; exists. Drop it and delete all saved pages?\n [y/N]: &#39;</span><span class="p">);</span>
        <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span> <span class="c1">//flush text after \n</span>
        <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">getresp</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">);</span> <span class="c1">//default no</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">resp</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;drop table pipages;&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Error dropping table:\n%s&quot;</span><span class="p">,</span><span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">);</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">create_table</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// create using schema</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`create table pipages (</span><span class="si">${</span><span class="nx">schema</span><span class="si">}</span><span class="sb">);`</span><span class="p">);</span>
    <span class="c1">// unique index on url, so we don&#39;t have duplicates</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;create unique index pipages_url_ux on pipages(url);&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// update a row of data in our table</span>
<span class="kd">function</span> <span class="nx">update_row</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

    <span class="c1">// build our &quot;set&quot; section of sql statement</span>
    <span class="c1">// based on what we have in *data*</span>
    <span class="c1">// should look like &quot;text=?text, title=?title, ...&quot;</span>
    <span class="kd">var</span> <span class="nx">sqlstr</span><span class="o">=</span><span class="s2">&quot;update pipages set &quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span>
            <span class="nx">sqlstr</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span><span class="o">+</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nx">sqlstr</span> <span class="o">+=</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;=?&quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">;</span>
        <span class="nx">j</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// if we only have data.url, there&#39;s nothing to update</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">j</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;updating %s\n&quot;</span><span class="p">,</span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">sqlstr</span> <span class="o">+</span> <span class="s2">&quot; where url=?url;&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;sql update error, cannot continue:\n%s&quot;</span><span class="p">,</span><span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//properties we need in the substitution parameters object when doing an insert</span>
<span class="kd">var</span> <span class="nx">empty_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">status</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">fetch_count</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">server_date</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">fetch_date</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">img_url</span><span class="o">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nx">text</span><span class="o">:</span><span class="s2">&quot;&quot;</span>
<span class="p">}</span>

<span class="c1">// insert a new row into our table</span>
<span class="kd">function</span> <span class="nx">insert_row</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dfilled</span> <span class="o">=</span> <span class="p">{};</span>                     <span class="c1">// start with empty object</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">dfilled</span><span class="p">,</span> <span class="nx">empty_params</span><span class="p">);</span> <span class="c1">// add default empty params</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">dfilled</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>         <span class="c1">// overwrite params with what we have</span>

    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;insert into pipages values &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;(?status, ?fetch_count, ?server_date, ?fetch_date, ?site, ?url, ?img_url, ?title, ?text);&quot;</span><span class="p">,</span>
        <span class="nx">dfilled</span>
    <span class="p">);</span>

    <span class="c1">// if duplicate, sql.errMsg will be set with &quot;duplicate value&quot; message and res.rowCount == 0</span>
    <span class="c1">// Checking res.rowCount first is likely faster</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">rowCount</span> <span class="o">&amp;&amp;</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;Trying to insert duplicate value&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">isDup</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>
        <span class="c1">// remove sql.errMsg</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">errMsg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// check for new articles in the main index page (sites[].url)</span>
<span class="kd">function</span> <span class="nx">check_new_articles</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// check that our table exists</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;select * from SYSTABLES where NAME = &#39;pipages&#39;;&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
            <span class="s1">&#39;Error: table &quot;pipages&quot; does not exist.\n&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;If this is the first time running this script, run it with\n&#39;</span> <span class="o">+</span>
            <span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="sb"> --first-run`</span>
       <span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span> <span class="nx">sitenames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="nx">sites</span><span class="p">[</span><span class="nx">sitenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
        <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>

        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Getting new article urls for %s\n&quot;</span><span class="p">,</span> <span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

        <span class="nx">res</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">urllist</span> <span class="o">=</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">urllist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;checking     %s - \r&quot;</span><span class="p">,</span> <span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">url</span><span class="p">)</span>
            <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">sqlres</span> <span class="o">=</span> <span class="nx">insert_row</span><span class="p">(</span><span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">sqlres</span><span class="p">.</span><span class="nx">isDup</span><span class="p">)</span>
                <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;exists:      %s\n&quot;</span><span class="p">,</span> <span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">url</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;NEW ARTICLE: %s\n&quot;</span><span class="p">,</span> <span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// on first run, get main index page and a few more index pages</span>
<span class="kd">function</span> <span class="nx">first_run</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span><span class="nx">j</span><span class="p">,</span><span class="nx">k</span><span class="p">;</span>

    <span class="nx">clean_database</span><span class="p">();</span>
    <span class="nx">create_table</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span> <span class="nx">sitenames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="nx">sites</span><span class="p">[</span><span class="nx">sitenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
        <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>

        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Getting new article urls for %s\n&quot;</span><span class="p">,</span> <span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

        <span class="nx">res</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;error getting &#39;%s&#39;:\n    %s\n&quot;</span><span class="p">,</span> <span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// extract urls of articles</span>
        <span class="kd">var</span> <span class="nx">urllist</span> <span class="o">=</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
        <span class="c1">// insert urls into table</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">urllist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">insert_row</span><span class="p">(</span><span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="c1">// go slow</span>
        <span class="nx">sleep</span><span class="p">(</span><span class="nx">crawlDelay</span><span class="p">);</span>

        <span class="c1">// get second and subsequent pages up to site.initialPages</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">k</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="nx">k</span><span class="o">&lt;=</span><span class="nx">site</span><span class="p">.</span><span class="nx">initialPages</span><span class="p">;</span><span class="nx">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">purl</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">urlNextFmt</span><span class="p">,</span> <span class="nx">k</span><span class="p">);</span>

            <span class="nx">res</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">purl</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;error getting &#39;%s&#39;:\n    %s\n&quot;</span><span class="p">,</span> <span class="nx">site</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
                <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// extract urls of articles</span>
            <span class="kd">var</span> <span class="nx">urllist</span> <span class="o">=</span> <span class="nx">procIndex</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
            <span class="c1">// insert urls into table</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">urllist</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">insert_row</span><span class="p">(</span><span class="nx">urllist</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="p">}</span>

            <span class="c1">//sleep unless at end</span>
            <span class="k">if</span><span class="p">(</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">site</span><span class="p">.</span><span class="nx">initialPages</span><span class="p">)</span>
                <span class="nx">sleep</span><span class="p">(</span><span class="nx">crawlDelay</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// get relevant text and info from article html</span>
<span class="kd">function</span> <span class="nx">procpage</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">dbrow</span><span class="p">,</span> <span class="nx">fetch_res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">url</span><span class="o">:</span><span class="nx">dbrow</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
        <span class="nx">fetch_date</span><span class="o">:</span><span class="s1">&#39;now&#39;</span><span class="p">,</span>
        <span class="nx">fetch_count</span><span class="o">:</span> <span class="nx">dbrow</span><span class="p">.</span><span class="nx">fetch_count</span> <span class="o">+</span><span class="mi">1</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">imgtag</span><span class="p">;</span>

    <span class="c1">// get server date</span>
    <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">fetch_res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nb">Date</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">server_date</span> <span class="o">=</span> <span class="nx">scanDate</span><span class="p">(</span><span class="nx">fetch_res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nb">Date</span><span class="p">,</span> <span class="nx">dateFmt</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">fetch_res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">date</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">server_date</span> <span class="o">=</span> <span class="nx">scanDate</span><span class="p">(</span><span class="nx">fetch_res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span> <span class="nx">dateFmt</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">server_date</span> <span class="o">=</span> <span class="s1">&#39;now&#39;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">newDocument</span><span class="p">(</span><span class="nx">fetch_res</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="c1">// the content is located in an element with CSS class *site.contentClass*</span>
    <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">contentClass</span><span class="p">);</span>

    <span class="c1">// remove from content items we don&#39;t want</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">contentRemoveClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">site</span><span class="p">.</span><span class="nx">contentRemoveClass</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">content</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span> <span class="nx">site</span><span class="p">.</span><span class="nx">contentRemoveClass</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">).</span><span class="k">delete</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// makeuseof has an easier to grab image in the article</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">contentImgClass</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">image</span><span class="o">=</span><span class="nx">doc</span><span class="p">.</span><span class="nx">findClass</span><span class="p">(</span> <span class="nx">site</span><span class="p">.</span><span class="nx">contentImgClass</span> <span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">hasTag</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="nx">imgtag</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">imgtag</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">img_url</span> <span class="o">=</span> <span class="nx">imgtag</span><span class="p">.</span><span class="nx">getAttr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// extract the text from the content html</span>
    <span class="nx">row</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">toText</span><span class="p">({</span><span class="nx">concatenate</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">titleText</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>

    <span class="c1">// find the &lt;title&gt; tag text</span>
    <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">findTag</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">title</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">title</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toText</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="nx">row</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">    Regular indexes are updated on each insert/update.</span>
<span class="cm">    Text indexes, however, need to be manually updated.</span>
<span class="cm">      -  When a new row is inserted, it still is available for search,</span>
<span class="cm">         but that search is a linear scan of the document, so it is slower.</span>
<span class="cm">      -  A text index can be updated with either:</span>
<span class="cm">          1) sql.exec(&quot;alter index pipages_text_ftx OPTIMIZE&quot;);</span>
<span class="cm">              or</span>
<span class="cm">          2) issuing the same command that created the index as in make_index() below.</span>
<span class="cm">         Here we will issue the same command when creating and updating for simplicity.</span>
<span class="cm">*/</span>

<span class="kd">function</span> <span class="nx">make_index</span><span class="p">(){</span>
    <span class="c1">// we want to match &quot;Check out the new pi 4.&quot; if we search for &quot;pi 4&quot;</span>
    <span class="c1">// so we add an expression for [\s\,]\d+[\s,\.] (in PERLRE), but only matching the number(s)</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span>
        <span class="s2">&quot;create fulltext index pipages_text_ftx on pipages(text) &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;WITH WORDEXPRESSIONS &quot;</span><span class="o">+</span>
        <span class="s2">&quot;(&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;, &#39;[\\space\\,]\\P=\\digit+\\F[\\space,\\.]=&#39;) &quot;</span><span class="o">+</span>
        <span class="s2">&quot;INDEXMETER &#39;on&#39;&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="c1">// interval ID needed to cancel setInteral when all pages have been fetched;</span>
<span class="kd">var</span> <span class="nx">iId</span> <span class="o">=</span> <span class="p">{};</span>

<span class="c1">// status, fetch_count, server_date, fetch_date, site, url, img_url, text</span>

<span class="c1">//fetch, process and update table</span>
<span class="kd">function</span> <span class="nx">fetch_article</span><span class="p">(</span><span class="nx">sitename</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">row</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;select * from pipages where site=? and status&lt;1 and fetch_count&lt;10 order by status DESC&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="nx">sitename</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%s is up to date\n&quot;</span><span class="p">,</span> <span class="nx">sitename</span><span class="p">);</span>
        <span class="c1">// no more pages to fetch, so cancel interval</span>
        <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">iId</span><span class="p">[</span><span class="nx">sitename</span><span class="p">]);</span>
        <span class="k">delete</span> <span class="nx">iId</span><span class="p">[</span><span class="nx">sitename</span><span class="p">];</span> <span class="c1">// get rid of entry so we know we are done with it</span>
        <span class="c1">// final action before script exits:</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">iId</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;updating fulltext index\n&quot;</span><span class="p">);</span>
            <span class="nx">make_index</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="nx">sites</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">site</span><span class="p">];</span>

    <span class="c1">// fetch the page</span>
    <span class="kd">var</span> <span class="nx">cres</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">cres</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span> <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// failed</span>
        <span class="nx">update_row</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span><span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
            <span class="nx">status</span><span class="o">:</span> <span class="nx">cres</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span>
            <span class="nx">fetch_count</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fetch_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// success</span>
        <span class="nx">row</span><span class="o">=</span><span class="nx">procpage</span><span class="p">(</span><span class="nx">site</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">cres</span><span class="p">);</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">status</span><span class="o">=</span><span class="mi">200</span><span class="p">;</span>
        <span class="nx">update_row</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// get article pages asynchronously using setInterval</span>
<span class="kd">function</span> <span class="nx">fetch_all_articles</span><span class="p">(){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sitenames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">site</span> <span class="o">=</span> <span class="nx">sites</span><span class="p">[</span><span class="nx">sitenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>

        <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;select * from pipages where site=? and status&lt;1 and fetch_count&lt;10 order by status DESC&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="nx">sitenames</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// only if we have some sites, otherwise we&#39;d waste crawlDelay seconds just to exit</span>

            <span class="c1">// this complicated mess is to make sure our *sitenames[i].name*</span>
            <span class="c1">// is scoped to the setInterval callback and stays the same</span>
            <span class="c1">// even as the *site* variable changes in subsequent *for* loops.</span>

            <span class="c1">// if you are unfamiliar with this technique and immediately invoked functions - see:</span>
            <span class="c1">// https://www.google.com/search?q=iife+settimeout</span>

            <span class="c1">// scope sitename in an IIFE</span>
            <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">sn</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">iId</span><span class="p">[</span><span class="nx">sn</span><span class="p">]</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span>
                    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">fetch_article</span><span class="p">(</span><span class="nx">sn</span><span class="p">);},</span>
                    <span class="nx">crawlDelay</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="p">);</span>
            <span class="p">})(</span><span class="nx">site</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

            <span class="cm">/* or use IIFE to return a function with sitename scoped. Result is the same.</span>
<span class="cm">            iId[site.name] = setInterval(</span>
<span class="cm">                (function(sn) {</span>
<span class="cm">                    return function() {</span>
<span class="cm">                        fetch_article(sn);</span>
<span class="cm">                    }</span>
<span class="cm">                })(site.name),</span>
<span class="cm">                crawlDelay * 1000</span>
<span class="cm">            );</span>
<span class="cm">            */</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// get index pages</span>
<span class="k">if</span><span class="p">(</span><span class="nx">firstRun</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">first_run</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">check_new_articles</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// get article pages</span>
<span class="nx">fetch_all_articles</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="client-side-script">
<h2>Client-Side Script<a class="headerlink" href="#client-side-script" title="Permalink to this headline">¶</a></h2>
<p>The client-side script is fairly easy and self explanatory compared to the
aggregator script.  Here we edit the <code class="docutils literal notranslate"><span class="pre">search.js</span></code> file and add some
styling using Bootstrap:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/* The PI NEWS Demo Search Module</span>

<span class="cm">   Everything outside the &#39;search()&#39; function below is run once (per thread) when</span>
<span class="cm">   the module is loaded.  The &#39;module.exports=search` is the exported function</span>
<span class="cm">   which is run once per client request.</span>

<span class="cm">   Note that this means that variables set outside the &#39;search()&#39; function are</span>
<span class="cm">   long lived and span multiple requests by potentially multiple clients.  As</span>
<span class="cm">   such, care should be taken that these variables do not include any information</span>
<span class="cm">   which should not be shared between clients.</span>
<span class="cm">*/</span>

<span class="c1">// Load the sql module.  This only needs to be done once</span>
<span class="kd">var</span> <span class="nx">Sql</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="c1">// process.scriptPath is the path of the web_server_conf.js, not</span>
<span class="c1">// the path of this module script. For the path of this module,</span>
<span class="c1">// use &#39;module.path&#39;.</span>
<span class="kd">var</span> <span class="nx">db</span><span class="o">=</span><span class="nx">process</span><span class="p">.</span><span class="nx">scriptPath</span> <span class="o">+</span> <span class="s1">&#39;/data/pi_news&#39;</span><span class="p">;</span>

<span class="c1">// Open the db.</span>
<span class="kd">var</span> <span class="nx">sql</span><span class="o">=</span><span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">db</span><span class="p">);</span>

<span class="c1">// make printf = rampart.utils.printf</span>
<span class="c1">// See: https://rampart.dev/docs/rampart-main.html#rampart-globalize</span>
<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">Example of some settings to modify search weights which can be used to use</span>
<span class="cm">to tune the search results.  These values are just examples and are not</span>
<span class="cm">tuned for this search.</span>
<span class="cm">See: https://rampart.dev/docs/sql-set.html#rank-knobs</span>
<span class="cm">and  https://rampart.dev/docs/sql-set.html#other-ranking-properties</span>
<span class="cm">    sql.set({</span>
<span class="cm">        &quot;likepallmatch&quot;:false,</span>
<span class="cm">        &quot;likepleadbias&quot;:250,</span>
<span class="cm">        &quot;likepproximity&quot;:750,</span>
<span class="cm">        &quot;likeprows&quot;:2000,</span>
<span class="cm">    });</span>

<span class="cm">NOTE ALSO:</span>
<span class="cm">     Here the &#39;sql&#39; variable is set when the module is loaded.  Any changes</span>
<span class="cm">     made in &#39;search()&#39; below using sql.set() will be carried forward for</span>
<span class="cm">     the next client (per server thread).  If you have settings (as set in</span>
<span class="cm">     &#39;sql.set()&#39;) that change per request or per client, it is highly</span>
<span class="cm">     advisable that you call &#39;sql.reset()&#39; at the beginning of the exported</span>
<span class="cm">     &#39;search()&#39; function below followed by a `sql.set()` call to make the</span>
<span class="cm">     behavioral changes desired.</span>

<span class="cm">     If the sql.set() call is intended for every client and every search,</span>
<span class="cm">     setting it here is not problematic.</span>
<span class="cm">*/</span>

<span class="c1">// we want &quot;pi 4&quot; query to match &quot;Check out the new pi 4.&quot;</span>
<span class="c1">// so we set qminwordlen to 1, the shortest word in a query (normally 2).</span>
<span class="c1">// We also set wordexpressions to:</span>
<span class="c1">//      (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;, &#39;[\\space\\,]\\P=\\digit+\\F[\\space,\\.]=&#39;)</span>
<span class="c1">// in the scraping script so that single digits will be indexed.</span>
<span class="c1">// In another context, this might be counter productive as it polutes the index, but</span>
<span class="c1">// here we have a small table and a greater need to match single digits.</span>
<span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="s2">&quot;qminwordlen&quot;</span><span class="o">:</span><span class="mi">1</span> <span class="p">});</span>

<span class="cm">/*</span>
<span class="cm"> the top section of html only needs to be set once as it remains the same</span>
<span class="cm"> regardless of the request.  Here it is set when the module is first loaded.</span>
<span class="cm"> This is a printf style format string so that the query text box may be</span>
<span class="cm"> filled if, e.g., ?q=pi+4 is set.</span>

<span class="cm"> The sprintf(%w&#39;, format_string):</span>
<span class="cm">    This removes leading white space so it can be pretty</span>
<span class="cm">    here in the source but compact when sent.</span>
<span class="cm">    See https://rampart.dev/docs/rampart-utils.html#printf</span>
<span class="cm">*/</span>
<span class="kd">var</span> <span class="nx">htmltop_format</span><span class="o">=</span><span class="nx">sprintf</span><span class="p">(</span><span class="s1">&#39;%w&#39;</span><span class="p">,</span>
<span class="sb">`&lt;!DOCTYPE HTML&gt;</span>
<span class="sb">    &lt;html&gt;</span>
<span class="sb">    &lt;head&gt;</span>
<span class="sb">      &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="sb">      &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span>
<span class="sb">      &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3&quot; crossorigin=&quot;anonymous&quot;&gt;</span>
<span class="sb">      &lt;style&gt;</span>
<span class="sb">        body {font-family: arial,sans-serif;}</span>
<span class="sb">        .urlsp {color:#006621;max-width:100%%;overflow: hidden;text-overflow: ellipsis;white-space:nowrap;display:inline-block;font-size:.90em;}</span>
<span class="sb">        .urla {text-decoration: none;font-size:16px;overflow: hidden;text-overflow: ellipsis;white-space:nowrap;display:inline-block; width: 100%%; }</span>
<span class="sb">        .res {margin-top: 80px !important;}</span>
<span class="sb">        .img-cover{object-fit: cover; aspect-ratio:5/3}</span>
<span class="sb">      &lt;/style&gt;</span>
<span class="sb">    &lt;/head&gt;</span>
<span class="sb">    &lt;body&gt;</span>
<span class="sb">    &lt;nav style=&quot;z-index:1&quot; class=&quot;navbar position-fixed top-0 w-100 navbar-expand-lg navbar-light bg-light&quot;&gt;</span>
<span class="sb">      &lt;div class=&quot;container-fluid&quot;&gt;</span>
<span class="sb">        &lt;a class=&quot;navbar-brand m-auto p-2&quot; href=&quot;#&quot;&gt;</span>
<span class="sb">          【Ｒａｍｐａｒｔ : Ｐｉ Ｎｅｗｓ】</span>
<span class="sb">        &lt;/a&gt;</span>
<span class="sb">        &lt;form style=&quot;width:100%%&quot; id=&quot;mf&quot; action=&quot;/apps/pi_news/search.html&quot;&gt;</span>
<span class="sb">          &lt;div class=&quot;input-group mb-2&quot;&gt;</span>
<span class="sb">            &lt;input autocomplete=&quot;off&quot; type=&quot;text&quot; id=&quot;fq&quot; name=&quot;q&quot; value=&quot;%H&quot; placeholder=&quot;Search&quot; class=&quot;form-control&quot;&gt;</span>
<span class="sb">            &lt;button class=&quot;btn btn-outline-secondary&quot; type=&quot;submit&quot;&gt;Search&lt;/button&gt;</span>
<span class="sb">          &lt;/div&gt;</span>
<span class="sb">        &lt;/form&gt;</span>
<span class="sb">      &lt;/div&gt;</span>
<span class="sb">    &lt;/nav&gt;</span>
<span class="sb">`</span>
<span class="p">);</span>



<span class="kd">function</span> <span class="nx">search</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">q</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">q</span> <span class="o">?</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">q</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="c1">// req.query.skip in, e.g. &quot;/apps/pi_news/search.html?q=pi&amp;skip=10&quot; is text.</span>
    <span class="c1">// Make it a JavaScript number.</span>
    <span class="kd">var</span> <span class="nx">skip</span><span class="o">=</span><span class="nb">parseInt</span><span class="p">(</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">skip</span> <span class="p">);</span>

    <span class="kd">var</span> <span class="nx">icount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>  <span class="c1">//estimated total number of results, set below</span>
    <span class="kd">var</span> <span class="nx">endhtml</span><span class="p">;</span>   <span class="c1">// closing tags, set below</span>
    <span class="kd">var</span> <span class="nx">nres</span><span class="o">=</span><span class="mi">12</span><span class="p">;</span>   <span class="c1">// number of results per page</span>

    <span class="c1">// add the htmltop text to the server&#39;s output buffer.</span>
    <span class="c1">// See: https://rampart.dev/docs/rampart-server.html#req-printf</span>
    <span class="c1">// it includes escaped &#39;%%&#39; values and the &#39;value=&quot;%H&quot;&#39; format code for the query</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="nx">htmltop_format</span><span class="p">,</span> <span class="nx">q</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">skip</span><span class="p">)</span><span class="nx">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">sqlStatement</span><span class="p">;</span>
    <span class="c1">// if there is a query, search for it and format the results.</span>
    <span class="c1">// if not, just send the latest articles.</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">q</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* The SQL statement:</span>

<span class="cm">           %mbH in stringformat() means highlight with bold and html escape.</span>
<span class="cm">           See: https://rampart.dev/docs/rampart-sql.html#metamorph-hit-mark-up</span>
<span class="cm">                https://rampart.dev/docs/sql-server-funcs.html#stringformat</span>

<span class="cm">           abstract(text[, maxsize[, style[, query]]]) will create an abstract:</span>
<span class="cm">              - text is the table field from which to create an abstract.</span>
<span class="cm">              - 0 (or &lt;0) means use the default maximum size of 230 characters.</span>
<span class="cm">              - &#39;querymultiple&#39; is a style which will break up the abstract into multiple sections if necessary</span>
<span class="cm">              - &#39;?&#39; is replaced with the JavaScript variable &#39;q&#39;</span>
<span class="cm">        */</span>
        <span class="nx">sqlStatement</span> <span class="o">=</span> <span class="s2">&quot;select url, img_url, title, stringformat(&#39;%mbH&#39;,?query,abstract(text, 0,&#39;querymultiple&#39;,?query)) Ab from pipages where text likep ?query&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* if no query, get latest articles */</span>
        <span class="nx">sqlStatement</span> <span class="o">=</span> <span class="s2">&quot;select url, img_url, title, abstract(text) Ab from pipages order by server_date DESC&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// by default, only the first 100 rows are returned for any likep search.</span>
    <span class="c1">// if we are skipping past that, we need to raise the likeprows setting.</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">skip</span> <span class="o">+</span> <span class="nx">nres</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="p">)</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">likeprows</span><span class="o">:</span><span class="nx">skip</span> <span class="o">+</span> <span class="nx">nres</span><span class="p">});</span>
    <span class="k">else</span>
        <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">likeprows</span><span class="o">:</span><span class="mi">100</span><span class="p">});</span> <span class="c1">//reset to default in case previously set</span>
    <span class="c1">// sql.exec(statement, params, settings, callback);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span>
        <span class="nx">sqlStatement</span><span class="p">,</span>
        <span class="c1">// the parameters for each &#39;?query&#39; in the above statement</span>
        <span class="p">{</span><span class="nx">query</span><span class="o">:</span> <span class="nx">q</span><span class="p">},</span>

        <span class="c1">// options</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:</span><span class="nx">nres</span><span class="p">,</span><span class="nx">skipRows</span><span class="o">:</span><span class="nx">skip</span><span class="p">,</span><span class="nx">includeCounts</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span>

        <span class="c1">// callback is executed once per retrieved row.</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="nx">cols</span><span class="p">,</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* res = {url: www, img_url:xxx, title:&quot;yyy&quot;, Ab:&quot;zzz&quot;}</span>
<span class="cm">             * i = current row, beginning at skip, ending at or before skip + nres</span>
<span class="cm">             * cols = [&quot;url&quot;, &quot;img_url&quot;, &quot;title&quot;, &quot;Ab&quot;] - the columns returned from the SQL statement</span>
<span class="cm">             * includeCounts sets info to an object detailing the number of possible matches to a &quot;likep&quot; query. */</span>

            <span class="c1">// before the first row</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="o">==</span><span class="nx">skip</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">icount</span><span class="o">=</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">indexCount</span><span class="p">);</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;res m-3&quot;&gt;&#39;</span><span class="p">);</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">q</span><span class="p">)</span>
                    <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;m-5 mb-0&quot;&gt;Results %d-%d of about %d&lt;/div&gt;&#39;</span><span class="p">,</span>
                        <span class="nx">skip</span><span class="o">+</span><span class="mi">1</span><span class="p">,(</span><span class="nx">skip</span><span class="o">+</span><span class="nx">nres</span><span class="o">&gt;</span><span class="nx">icount</span><span class="p">)</span><span class="o">?</span><span class="nx">icount</span><span class="o">:</span><span class="nx">skip</span><span class="o">+</span><span class="nx">nres</span><span class="p">,</span><span class="nx">icount</span>
                    <span class="p">);</span>
                <span class="k">else</span>
                    <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;m-5 mb-0&quot;&gt;Latest Articles&lt;/div&gt;&#39;</span><span class="p">);</span>

                <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;row row-cols-md-3 row-cols-sm-2 row-cols-1 g-4 m-3 mt-0&quot;&gt;&#39;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;col&quot;&gt;&lt;div class=&quot;card&quot;&gt;&#39;</span><span class="o">+</span>
                           <span class="s1">&#39;&lt;a target=&quot;_blank&quot; href=&quot;%s&quot;&gt;&#39;</span><span class="o">+</span>
                             <span class="s1">&#39;&lt;img class=&quot;card-img-top img-cover&quot; src = &quot;%s&quot;&gt;&#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;&lt;/a&gt;&#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;&lt;div class=&quot;card-body&quot;&gt;&#39;</span><span class="o">+</span>
                             <span class="s1">&#39;&lt;a class=&quot;urla tar&quot; target=&quot;_blank&quot; href=&quot;%s&quot;&gt;%s&lt;/a&gt;&#39;</span><span class="o">+</span>
                              <span class="s1">&#39;&lt;span class=&quot;urlsp&quot;&gt;%s&lt;/span&gt;&#39;</span><span class="o">+</span>
                              <span class="s1">&#39;&lt;p class=&quot;card-text&quot;&gt;%s&lt;/p&gt;&#39;</span><span class="o">+</span>
                           <span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="o">+</span>
                        <span class="s1">&#39;&lt;/div&gt;&lt;/div&gt;&#39;</span><span class="p">,</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">img_url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Ab</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">);</span>

    <span class="c1">// check if there are more rows.  If so, print a &#39;next&#39; link.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">icount</span> <span class="o">&gt;</span> <span class="nx">nres</span><span class="o">+</span><span class="nx">skip</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">skip</span><span class="o">+=</span><span class="nx">nres</span>
        <span class="c1">// %U is for url encoding.  See https://rampart.dev/docs/rampart-utils.html#printf</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;&lt;/div&gt;&lt;div class=&quot;m-3 mt-0&quot;&gt;&#39;</span> <span class="o">+</span>
                      <span class="s1">&#39;&lt;a class=&quot;m-3&quot; href=&quot;/apps/pi_news/search.html?q=%U&amp;skip=%d&quot;&gt;Next %d&lt;/a&gt;&#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;&lt;div class=&quot;m-3&quot;&gt; &lt;/div&gt;&lt;/div&gt;&#39;</span><span class="p">,</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">q</span><span class="p">,</span><span class="nx">skip</span><span class="p">,</span> <span class="p">(</span><span class="nx">nres</span> <span class="o">&gt;</span> <span class="nx">icount</span> <span class="o">-</span> <span class="nx">skip</span> <span class="o">?</span> <span class="nx">icount</span> <span class="o">-</span> <span class="nx">skip</span><span class="o">:</span> <span class="nx">nres</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">endhtml</span><span class="o">=</span><span class="s1">&#39;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="p">;</span>


    <span class="c1">// send the closing html and set the  mime-type to text/html</span>
    <span class="c1">// This is appended to everything already sent using req.printf()</span>
    <span class="k">return</span><span class="p">({</span><span class="nx">html</span><span class="o">:</span><span class="nx">endhtml</span><span class="p">});</span>

    <span class="c1">// alternatively, it might be sent like this:</span>
<span class="c1">//    req.put(endhtml);</span>
<span class="c1">//    return({html:null}); //null means just set the mime-type, but don&#39;t append</span>

<span class="p">}</span>

<span class="c1">//export the main search function</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">search</span><span class="p">;</span>

<span class="c1">// -fin-</span>
</pre></div>
</div>
</div>
<div class="section" id="improvements">
<h2>Improvements<a class="headerlink" href="#improvements" title="Permalink to this headline">¶</a></h2>
<p>We purposely kept these examples very simple in order to clearly demonstrate
the concepts we covered, so there is room for improvement:</p>
<ul class="simple">
<li><p>Save the HTML of each article in our table.</p></li>
<li><p>Include a more robust treatment of HTTP status codes.</p></li>
<li><p>Error check the results of the parsed properties before insert or update.</p></li>
<li><p>Optimize the update of the fulltext index with a conditional, e.g.,
<code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">INDEX</span> <span class="pre">pipages_text_ftx</span> <span class="pre">OPTIMIZE</span> <span class="pre">HAVING</span> <span class="pre">COUNT(NewRows)</span> <span class="pre">&gt;</span> <span class="pre">30;</span></code> so
that there is a balance between the time it takes to optimize the index
and number of rows that will be linearly search.  This would only be an
issue after the database grows much larger than anticipated in this
tutorial.</p></li>
<li><p>Create a better strategy should the fetch of <code class="docutils literal notranslate"><span class="pre">/robots.txt</span></code> not return <code class="docutils literal notranslate"><span class="pre">200</span></code>.</p></li>
<li><p>Examine <code class="docutils literal notranslate"><span class="pre">sql.errMsg</span></code> after each call to <code class="docutils literal notranslate"><span class="pre">sql.exec()</span></code>.</p></li>
<li><p>Have a different format for the latest articles and the search results (so that search
results look more like the return from a search).</p></li>
</ul>
<p>Enjoy!</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="tutorial-wschat.html" class="btn btn-neutral" title="Using Websockets to Build a Chat" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Moat Crossing Systems.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>